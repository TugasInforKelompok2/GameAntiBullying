<!DOCTYPE html>
<html lang="id" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hero Kebaikan - Game Edukasi Anti-Bullying</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚≠ê</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Poppins', sans-serif; 
            scroll-behavior: smooth;
        }
        .orbitron { font-family: 'Orbitron', monospace; }
        
        /* Galaxy background animation */
        .galaxy-bg {
            background: linear-gradient(135deg, #0d0d0d 0%, #1a0033 50%, #4b0082 100%);
            position: relative;
            min-height: 100vh;
        }
        
        .stars {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            animation: twinkle 3s infinite;
        }
        
        @keyframes twinkle {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.2); }
        }
        
        .neon-glow {
            box-shadow: 0 0 20px rgba(138, 43, 226, 0.5), 0 0 40px rgba(138, 43, 226, 0.3);
        }
        
        .neon-text {
            text-shadow: 0 0 10px rgba(138, 43, 226, 0.8), 0 0 20px rgba(138, 43, 226, 0.6);
        }
        
        .panel-transition {
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .fade-slide-in {
            animation: fadeSlideIn 0.6s ease-out;
        }
        
        @keyframes fadeSlideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Emoji animations */
        .emoji-bounce {
            animation: emojiBounce 2s ease-in-out infinite;
        }
        
        @keyframes emojiBounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0) scale(1); }
            40% { transform: translateY(-15px) scale(1.1); }
            60% { transform: translateY(-8px) scale(1.05); }
        }
        
        .emoji-shake {
            animation: emojiShake 1.5s ease-in-out infinite;
        }
        
        @keyframes emojiShake {
            0%, 100% { transform: translateX(0) rotate(0deg); }
            25% { transform: translateX(-5px) rotate(-5deg); }
            75% { transform: translateX(5px) rotate(5deg); }
        }
        
        .emoji-pulse {
            animation: emojiPulse 2s ease-in-out infinite;
        }
        
        @keyframes emojiPulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.8; }
        }
        
        .emoji-spin {
            animation: emojiSpin 3s linear infinite;
        }
        
        @keyframes emojiSpin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* Interactive UI hints */
        .interactive-hint {
            position: relative;
            overflow: visible;
        }
        
        .interactive-hint::before {
            content: 'üëÜ';
            position: absolute;
            top: -30px;
            right: -10px;
            font-size: 20px;
            animation: pointingHand 2s ease-in-out infinite;
            z-index: 10;
        }
        
        @keyframes pointingHand {
            0%, 100% { transform: translateY(0px); opacity: 0.7; }
            50% { transform: translateY(-5px); opacity: 1; }
        }
        
        .choice-button {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }
        
        .choice-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(138, 43, 226, 0.3);
        }
        
        .choice-button::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: inherit;
            padding: 2px;
            background: linear-gradient(45deg, transparent, rgba(138, 43, 226, 0.5), transparent);
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask-composite: exclude;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .choice-button:hover::after {
            opacity: 1;
        }
        
        /* Tutorial animations */
        .tutorial-bounce {
            animation: tutorialBounce 2s infinite;
        }
        
        @keyframes tutorialBounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }
        
        .tutorial-pulse {
            animation: tutorialPulse 2s infinite;
        }
        
        @keyframes tutorialPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .tutorial-glow {
            animation: tutorialGlow 3s infinite;
        }
        
        @keyframes tutorialGlow {
            0%, 100% { box-shadow: 0 0 20px rgba(138, 43, 226, 0.3); }
            50% { box-shadow: 0 0 30px rgba(138, 43, 226, 0.6), 0 0 40px rgba(138, 43, 226, 0.4); }
        }
        
        .tutorial-slide-left {
            animation: slideLeft 0.8s ease-out;
        }
        
        @keyframes slideLeft {
            from { opacity: 0; transform: translateX(50px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .tutorial-slide-right {
            animation: slideRight 0.8s ease-out;
        }
        
        @keyframes slideRight {
            from { opacity: 0; transform: translateX(-50px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        /* Panel Lock Styles */
        .panel-locked {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 60;
            background: linear-gradient(135deg, #0d0d0d 0%, #1a0033 50%, #4b0082 100%);
            backdrop-filter: none;
        }
        
        .panel-locked .scenario-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 95vw;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            z-index: 61;
            background: linear-gradient(135deg, #1a0033 0%, #2d1b69 50%, #4b0082 100%);
            border: 2px solid rgba(138, 43, 226, 0.8);
            box-shadow: 0 0 30px rgba(138, 43, 226, 0.5), 0 0 60px rgba(138, 43, 226, 0.3);
        }
        
        .lock-button {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 62;
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            border: 2px solid rgba(138, 43, 226, 0.8);
            color: white;
            padding: 10px 14px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(138, 43, 226, 0.4);
        }
        
        .lock-button:hover {
            background: linear-gradient(135deg, #7c3aed, #6d28d9);
            border-color: rgba(138, 43, 226, 1);
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(138, 43, 226, 0.6);
        }
        
        .panel-locked .lock-button {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            border-color: rgba(239, 68, 68, 0.8);
        }
        
        .panel-locked .lock-button:hover {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            border-color: rgba(239, 68, 68, 1);
        }
        
        /* Sidebar Styles */
        .sidebar-open {
            transform: translateX(0) !important;
        }
        
        .sidebar-overlay-show {
            opacity: 1 !important;
            pointer-events: auto !important;
        }
        
        /* Z-Index Hierarchy - Complete Layer Management */
        /* 
         * Layer Priority (highest to lowest):
         * 100: Sidebar Toggle Button (always accessible)
         * 90:  Sidebar Panel (main navigation)
         * 85:  Sidebar Overlay (mobile backdrop)
         * 60:  Modals (tutorial, game info, achievements, etc.)
         * 50:  Panel Lock System
         * 46:  Mobile Map Trigger
         * 45:  Mobile Map Popup
         * 40:  Header
         * 10:  Regular content
         */
        
        #sidebarToggle {
            z-index: 100 !important; /* Highest - always clickable and visible */
        }
        
        #sidebar {
            z-index: 90 !important; /* Sidebar panel - highest content priority */
        }
        
        #sidebarOverlay {
            z-index: 85 !important; /* Sidebar overlay - above all content */
        }
        
        /* Ensure sidebar is never covered by any other element */
        .sidebar-open {
            z-index: 90 !important;
        }
        
        /* Responsive sidebar adjustments */
        @media (max-width: 768px) {
            #sidebar {
                width: 100vw;
                max-width: 320px;
            }
        }
        
        @media (min-width: 1024px) {
            #sidebar {
                width: 320px;
            }
        }

        /* Sidebar toggle button positioning */
        #sidebarToggle {
            z-index: 75; /* Higher than sidebar overlay */
        }

        /* Mobile Map Popup */
        .mobile-map-popup {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.95), rgba(0, 0, 0, 0.8));
            backdrop-filter: blur(10px);
            border-top: 2px solid rgba(138, 43, 226, 0.5);
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 45;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .mobile-map-popup::-webkit-scrollbar {
            width: 8px;
        }
        
        .mobile-map-popup::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 6px;
        }
        
        .mobile-map-popup::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            border-radius: 6px;
            border: 1px solid rgba(138, 43, 226, 0.3);
        }
        
        .mobile-map-popup.show {
            transform: translateY(0);
        }
        
        .mobile-map-trigger {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 46;
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            border: 2px solid rgba(138, 43, 226, 0.5);
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(138, 43, 226, 0.4);
        }
        
        .mobile-map-trigger:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(138, 43, 226, 0.6);
        }
        
        .mobile-map-trigger.hidden {
            display: none;
        }
        
        /* Responsive adjustments */
        @media (min-width: 768px) {
            .mobile-map-trigger {
                display: none;
            }
            
            .mobile-map-popup {
                display: none;
            }
        }
        
        @media (max-width: 767px) {
            #locationPanel {
                display: none;
            }
        }

        /* Mini Game Styles */
        .letter-button {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }
        
        .letter-button:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(138, 43, 226, 0.4);
        }
        
        .letter-button.selected {
            background: linear-gradient(135deg, #10b981, #059669);
            transform: scale(0.95);
        }
        
        .letter-button.correct {
            background: linear-gradient(135deg, #10b981, #059669);
            animation: correctLetter 0.5s ease-out;
        }
        
        .letter-button.wrong {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            animation: wrongLetter 0.5s ease-out;
        }
        
        @keyframes correctLetter {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        @keyframes wrongLetter {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        .word-slot {
            min-height: 50px;
            transition: all 0.3s ease;
        }
        
        .word-slot.filled {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            transform: scale(1.05);
        }
    </style>
</head>
<body class="galaxy-bg min-h-screen text-white">
    <!-- Animated stars background -->
    <div class="stars" id="stars"></div>
    
    <!-- Sidebar Toggle Button -->
    <button id="sidebarToggle" class="fixed top-4 left-4 z-90 bg-gradient-to-r from-purple-600/80 to-indigo-600/80 backdrop-blur-md text-white p-3 rounded-lg border border-purple-400/30 hover:from-purple-500/90 hover:to-indigo-500/90 transition-all duration-300 shadow-lg">
        <span id="sidebarToggleIcon" class="text-xl">‚ò∞</span>
    </button>

    <!-- Sidebar -->
    <div id="sidebar" class="fixed top-0 left-0 h-full w-80 bg-gradient-to-b from-purple-900/95 to-indigo-900/95 backdrop-blur-md border-r border-purple-400/30 transform -translate-x-full transition-transform duration-300 z-80 overflow-y-auto">
        <div class="p-6 pt-24">
            <!-- Sidebar Header -->
            <div class="flex items-center justify-between mb-6">
                <h2 class="orbitron text-xl font-bold text-cyan-300">üéÆ Game Panel</h2>
                <button onclick="toggleSidebar()" class="text-gray-400 hover:text-white transition-colors">
                    <span class="text-xl">‚úï</span>
                </button>
            </div>

            <!-- Quick Stats -->
            <div class="bg-black/30 rounded-xl p-4 mb-6 border border-purple-400/20">
                <h3 class="font-bold text-purple-300 mb-3 text-sm">üìä Quick Stats</h3>
                <div class="grid grid-cols-2 gap-3 text-xs">
                    <div class="bg-purple-800/30 p-2 rounded">
                        <div class="text-purple-300">Level</div>
                        <div class="font-bold text-cyan-300" id="sidebarLevel">1</div>
                    </div>
                    <div class="bg-green-800/30 p-2 rounded">
                        <div class="text-green-300">Kebaikan</div>
                        <div class="font-bold text-green-300" id="sidebarKindness">0</div>
                    </div>
                    <div class="bg-blue-800/30 p-2 rounded">
                        <div class="text-blue-300">Kepintaran</div>
                        <div class="font-bold text-blue-300" id="sidebarSmart">1</div>
                    </div>
                    <div class="bg-yellow-800/30 p-2 rounded">
                        <div class="text-yellow-300">Matematika</div>
                        <div class="font-bold text-yellow-300" id="sidebarMath">0</div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="mb-6">
                <h3 class="font-bold text-purple-300 mb-3 text-sm">‚ö° Quick Actions</h3>
                <div class="space-y-2">
                    <button onclick="quickSelectLocation('school')" class="w-full text-left bg-purple-800/30 hover:bg-purple-700/40 p-3 rounded-lg border border-purple-400/20 hover:border-cyan-400/40 transition-all duration-300">
                        <div class="flex items-center gap-3">
                            <span class="text-xl">üè´</span>
                            <div>
                                <div class="font-semibold text-purple-300 text-sm">Sekolah</div>
                                <div class="text-xs text-gray-400">Misi anti-bullying</div>
                            </div>
                        </div>
                    </button>
                    <button onclick="quickSelectLocation('park')" class="w-full text-left bg-green-800/30 hover:bg-green-700/40 p-3 rounded-lg border border-green-400/20 hover:border-cyan-400/40 transition-all duration-300 ${!gameState.unlockedFeatures.park ? 'opacity-50 cursor-not-allowed' : ''}">
                        <div class="flex items-center gap-3">
                            <span class="text-xl">üå≥</span>
                            <div>
                                <div class="font-semibold text-green-300 text-sm">Taman</div>
                                <div class="text-xs text-gray-400">${!gameState.unlockedFeatures.park ? 'üîí Locked' : 'Petualangan outdoor'}</div>
                            </div>
                        </div>
                    </button>
                    <button onclick="quickSelectLocation('classroom')" class="w-full text-left bg-blue-800/30 hover:bg-blue-700/40 p-3 rounded-lg border border-blue-400/20 hover:border-cyan-400/40 transition-all duration-300 ${!gameState.unlockedFeatures.classroom ? 'opacity-50 cursor-not-allowed' : ''}">
                        <div class="flex items-center gap-3">
                            <span class="text-xl">üìö</span>
                            <div>
                                <div class="font-semibold text-blue-300 text-sm">Ruang Kelas</div>
                                <div class="text-xs text-gray-400">${!gameState.unlockedFeatures.classroom ? 'üîí Locked' : 'Pembelajaran interaktif'}</div>
                            </div>
                        </div>
                    </button>
                </div>
            </div>

            <!-- Game Modes -->
            <div class="mb-6">
                <h3 class="font-bold text-purple-300 mb-3 text-sm">üéØ Game Modes</h3>
                <div class="space-y-2">
                    <button onclick="quickShowMathMode()" class="w-full text-left bg-yellow-800/30 hover:bg-yellow-700/40 p-3 rounded-lg border border-yellow-400/20 hover:border-cyan-400/40 transition-all duration-300 ${!gameState.unlockedFeatures.mathTutor ? 'opacity-50 cursor-not-allowed' : ''}">
                        <div class="flex items-center gap-3">
                            <span class="text-xl">üßÆ</span>
                            <div>
                                <div class="font-semibold text-yellow-300 text-sm">Math Tutor</div>
                                <div class="text-xs text-gray-400">${!gameState.unlockedFeatures.mathTutor ? 'üîí Need 20 points' : 'Latihan matematika'}</div>
                            </div>
                        </div>
                    </button>
                    <button onclick="quickShowStoryMode()" class="w-full text-left bg-pink-800/30 hover:bg-pink-700/40 p-3 rounded-lg border border-pink-400/20 hover:border-cyan-400/40 transition-all duration-300 ${!gameState.unlockedFeatures.storyMode ? 'opacity-50 cursor-not-allowed' : ''}">
                        <div class="flex items-center gap-3">
                            <span class="text-xl">üìñ</span>
                            <div>
                                <div class="font-semibold text-pink-300 text-sm">Story Mode</div>
                                <div class="text-xs text-gray-400">${!gameState.unlockedFeatures.storyMode ? 'üîí Need 30 points' : 'Cerita interaktif'}</div>
                            </div>
                        </div>
                    </button>
                    <button onclick="quickShowMiniGame()" class="w-full text-left bg-cyan-800/30 hover:bg-cyan-700/40 p-3 rounded-lg border border-cyan-400/20 hover:border-cyan-400/40 transition-all duration-300 ${!gameState.unlockedFeatures.miniGame ? 'opacity-50 cursor-not-allowed' : ''}">
                        <div class="flex items-center gap-3">
                            <span class="text-xl">üéØ</span>
                            <div>
                                <div class="font-semibold text-cyan-300 text-sm">Mini Games</div>
                                <div class="text-xs text-gray-400">${!gameState.unlockedFeatures.miniGame ? 'üîí Need level 3' : 'Susun kata & defender'}</div>
                            </div>
                        </div>
                    </button>
                </div>
            </div>

            <!-- Progress Tracker -->
            <div class="mb-6">
                <h3 class="font-bold text-purple-300 mb-3 text-sm">üìà Progress Tracker</h3>
                <div class="bg-black/30 rounded-lg p-3 border border-purple-400/20">
                    <div class="space-y-3">
                        <div>
                            <div class="flex justify-between text-xs mb-1">
                                <span class="text-gray-300">Level Progress</span>
                                <span class="text-cyan-300" id="sidebarLevelProgress">0/20</span>
                            </div>
                            <div class="w-full bg-gray-700 rounded-full h-2">
                                <div id="sidebarLevelBar" class="bg-gradient-to-r from-cyan-500 to-blue-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between text-xs mb-1">
                                <span class="text-gray-300">Daily Missions</span>
                                <span class="text-green-300" id="sidebarDailyProgress">0/3</span>
                            </div>
                            <div class="w-full bg-gray-700 rounded-full h-2">
                                <div id="sidebarDailyBar" class="bg-gradient-to-r from-green-500 to-emerald-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between text-xs mb-1">
                                <span class="text-gray-300">Achievements</span>
                                <span class="text-yellow-300" id="sidebarAchievements">0/15</span>
                            </div>
                            <div class="w-full bg-gray-700 rounded-full h-2">
                                <div id="sidebarAchievementBar" class="bg-gradient-to-r from-yellow-500 to-orange-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="mb-6">
                <h3 class="font-bold text-purple-300 mb-3 text-sm">üìã Recent Activity</h3>
                <div id="sidebarActivity" class="bg-black/30 rounded-lg p-3 border border-purple-400/20 max-h-32 overflow-y-auto">
                    <div class="text-xs text-gray-400 text-center">No recent activity</div>
                </div>
            </div>

            <!-- Settings & Tools -->
            <div class="mb-6">
                <h3 class="font-bold text-purple-300 mb-3 text-sm">‚öôÔ∏è Settings & Tools</h3>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="saveGameManual()" class="bg-green-600/30 hover:bg-green-500/40 p-2 rounded text-xs border border-green-400/20 transition-all duration-300">
                        <div class="text-green-300">üíæ</div>
                        <div class="text-green-300">Save</div>
                    </button>
                    <button onclick="loadGameManual()" class="bg-cyan-600/30 hover:bg-cyan-500/40 p-2 rounded text-xs border border-cyan-400/20 transition-all duration-300">
                        <div class="text-cyan-300">üìÇ</div>
                        <div class="text-cyan-300">Load</div>
                    </button>
                    <button onclick="showTutorial()" class="bg-yellow-600/30 hover:bg-yellow-500/40 p-2 rounded text-xs border border-yellow-400/20 transition-all duration-300">
                        <div class="text-yellow-300">üìñ</div>
                        <div class="text-yellow-300">Tutorial</div>
                    </button>
                    <button onclick="showGameInfo()" class="bg-purple-600/30 hover:bg-purple-500/40 p-2 rounded text-xs border border-purple-400/20 transition-all duration-300">
                        <div class="text-purple-300">‚ÑπÔ∏è</div>
                        <div class="text-purple-300">Info</div>
                    </button>
                </div>
            </div>

            <!-- Auto-save Status -->
            <div class="bg-blue-900/30 rounded-lg p-3 border border-blue-400/20">
                <div class="flex items-center justify-between">
                    <div class="text-xs text-blue-300">Auto-save</div>
                    <div class="flex items-center gap-2">
                        <span id="sidebarAutoSaveIndicator" class="text-xs">üîÑ</span>
                        <span id="sidebarAutoSaveTimer" class="text-xs text-blue-300">30s</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar Overlay (Mobile) -->
    <div id="sidebarOverlay" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-70 opacity-0 pointer-events-none transition-opacity duration-300"></div>

    <!-- Header -->
    <header class="fixed top-0 left-0 right-0 z-50 bg-black/30 backdrop-blur-md border-b border-purple-500/30">
        <div class="container mx-auto px-4 py-3">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4 ml-16 md:ml-20">
                <h1 class="orbitron text-2xl md:text-3xl font-bold neon-text">üåü Hero Kebaikan</h1>
                <div class="flex flex-wrap gap-2 md:gap-4 text-xs md:text-sm">
                    <div class="bg-purple-900/50 px-2 md:px-3 py-1 rounded-full border border-purple-400/30">
                        Level: <span id="playerLevel" class="font-bold text-cyan-300">1</span>
                    </div>
                    <div class="bg-purple-900/50 px-2 md:px-3 py-1 rounded-full border border-purple-400/30">
                        Poin Kebaikan: <span id="kindnessPoints" class="font-bold text-green-300">0</span>
                    </div>
                    <div class="bg-purple-900/50 px-2 md:px-3 py-1 rounded-full border border-purple-400/30">
                        Level Kepintaran: <span id="smartLevel" class="font-bold text-blue-300">1</span>
                    </div>
                    <div class="bg-purple-900/50 px-2 md:px-3 py-1 rounded-full border border-purple-400/30">
                        Poin Matematika: <span id="mathPoints" class="font-bold text-yellow-300">0</span>
                    </div>
                    <div class="flex gap-1">
                        <button onclick="saveGameManual()" class="bg-green-600/50 hover:bg-green-500/60 px-2 md:px-3 py-1 rounded-full border border-green-400/30 panel-transition" title="Simpan Game Manual">
                            üíæ
                        </button>
                        <button onclick="loadGameManual()" class="bg-cyan-600/50 hover:bg-cyan-500/60 px-2 md:px-3 py-1 rounded-full border border-cyan-400/30 panel-transition" title="Muat Game Manual">
                            üìÇ
                        </button>
                        <button onclick="resetGame()" class="bg-red-600/50 hover:bg-red-500/60 px-2 md:px-3 py-1 rounded-full border border-red-400/30 panel-transition" title="Reset Game">
                            üîÑ
                        </button>
                        <button onclick="showTutorial()" class="bg-yellow-600/50 hover:bg-yellow-500/60 px-2 md:px-3 py-1 rounded-full border border-yellow-400/30 panel-transition" title="Tutorial">
                            üìñ
                        </button>
                        <button onclick="showGameInfo()" class="bg-purple-600/50 hover:bg-purple-500/60 px-2 md:px-3 py-1 rounded-full border border-purple-400/30 panel-transition" title="Info Game">
                            ‚ÑπÔ∏è
                        </button>
                        <div class="bg-blue-600/50 px-2 md:px-3 py-1 rounded-full border border-blue-400/30 flex items-center" title="Auto-save timer">
                            <span id="autoSaveIndicator" class="text-xs">üîÑ</span>
                            <span id="autoSaveTimer" class="hidden md:inline text-xs ml-1">30s</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Mobile Map Trigger Button -->
    <div id="mobileMapTrigger" class="mobile-map-trigger" onclick="toggleMobileMap()">
        üó∫Ô∏è
    </div>

    <!-- Mobile Map Popup -->
    <div id="mobileMapPopup" class="mobile-map-popup">
        <div class="p-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="orbitron text-lg font-bold neon-text">üó∫Ô∏è Peta Lokasi</h2>
                <button onclick="toggleMobileMap()" class="bg-red-600/50 hover:bg-red-500/60 px-3 py-1 rounded-lg text-sm panel-transition">
                    ‚úï Tutup
                </button>
            </div>
            <div class="grid grid-cols-2 gap-3 mb-4" id="mobileLocationGrid">
                <!-- Mobile locations will be dynamically generated -->
            </div>
            <div class="text-center" id="mobileMiniGameButton">
                <!-- Mobile mini game button will be dynamically generated -->
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="pt-28 md:pt-24 pb-8 px-2 md:px-4">
        <div class="container mx-auto max-w-7xl">
            <!-- Location Map (Desktop Only) -->
            <div id="locationPanel" class="mb-6 md:mb-8 fade-slide-in">
                <h2 class="orbitron text-lg md:text-xl font-bold mb-4 text-center neon-text">üó∫Ô∏è Peta Lokasi</h2>
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-2 md:gap-4" id="locationGrid">
                    <!-- Locations will be dynamically generated -->
                </div>
                <div class="mt-4 text-center" id="miniGameButton">
                    <!-- Mini game button will be dynamically generated -->
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 md:gap-6">
                <!-- Combined Scenario & Math Panel -->
                <div id="scenarioHeroPanel" class="scenario-panel lg:col-span-2 bg-black/40 backdrop-blur-md rounded-2xl border border-purple-400/30 p-4 md:p-6 panel-transition fade-slide-in">
                    <!-- Lock Button -->
                    <button id="panelLockButton" onclick="togglePanelLock()" class="lock-button" title="Kunci Panel">
                        üîì
                    </button>
                    <div class="flex flex-col lg:flex-row gap-4 md:gap-6">
                        <!-- Main Content Section -->
                        <div class="flex-1">
                            <!-- Story Mode -->
                            <div id="storyMode">
                                <h3 class="orbitron text-base md:text-lg font-bold mb-3 md:mb-4 neon-text">üìñ Cerita Interaktif</h3>
                                <div id="scenarioContent" class="space-y-4">
                                    <div class="bg-purple-900/30 p-4 rounded-xl border border-purple-400/20">
                                        <p class="text-gray-200 mb-3">Selamat datang, Hero! Pilih lokasi untuk memulai petualangan kebaikan mu. Setiap pilihan yang kamu buat akan mempengaruhi dunia di sekitarmu.</p>
                                        <div class="text-center">
                                            <span class="text-4xl">üåü</span>
                                            <p class="text-sm text-purple-300 mt-2">Pilih lokasi untuk memulai misi</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Math Mode -->
                            <div id="mathMode" class="hidden">
                                <div class="mb-4">
                                    <div class="flex justify-between items-center mb-3">
                                        <h3 class="orbitron text-base md:text-lg font-bold neon-text">üßÆ Mode Matematika SMP</h3>
                                    </div>
                                    <div class="text-center">
                                        <button onclick="hideMathMode()" class="bg-red-600/50 hover:bg-red-500/60 px-4 py-2 rounded-lg text-sm panel-transition">
                                            ‚úï Tutup Math Mode
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-2 gap-3 mb-4">
                                    <button onclick="selectMathCategory('dasar')" class="bg-gradient-to-br from-blue-800/50 to-cyan-900/50 hover:from-blue-700/60 hover:to-cyan-800/60 p-3 rounded-xl border border-blue-400/30 hover:border-cyan-400/50 panel-transition">
                                        <div class="text-xl mb-1">üî¢</div>
                                        <div class="text-sm font-semibold">Dasar</div>
                                    </button>
                                    <button onclick="selectMathCategory('aljabar')" class="bg-gradient-to-br from-purple-800/50 to-indigo-900/50 hover:from-purple-700/60 hover:to-indigo-800/60 p-3 rounded-xl border border-purple-400/30 hover:border-cyan-400/50 panel-transition">
                                        <div class="text-xl mb-1">üìê</div>
                                        <div class="text-sm font-semibold">Aljabar</div>
                                    </button>
                                    <button onclick="selectMathCategory('geometri')" class="bg-gradient-to-br from-green-800/50 to-emerald-900/50 hover:from-green-700/60 hover:to-emerald-800/60 p-3 rounded-xl border border-green-400/30 hover:border-cyan-400/50 panel-transition">
                                        <div class="text-xl mb-1">üìè</div>
                                        <div class="text-sm font-semibold">Geometri</div>
                                    </button>
                                    <button onclick="selectMathCategory('lanjutan')" class="bg-gradient-to-br from-red-800/50 to-pink-900/50 hover:from-red-700/60 hover:to-pink-800/60 p-3 rounded-xl border border-red-400/30 hover:border-cyan-400/50 panel-transition">
                                        <div class="text-xl mb-1">üß†</div>
                                        <div class="text-sm font-semibold">Lanjutan</div>
                                    </button>
                                </div>
                                
                                <div id="mathQuestion" class="hidden bg-purple-900/30 p-4 rounded-xl border border-purple-400/20">
                                    <h4 class="font-bold mb-3" id="questionTitle">Soal Matematika</h4>
                                    <p class="mb-4" id="questionText">Loading...</p>
                                    <div id="mathOptions" class="space-y-2">
                                        <!-- Options will be inserted here -->
                                    </div>
                                    <div class="mt-4 text-center">
                                        <button onclick="submitMathAnswer()" id="submitMathBtn" class="bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-500 hover:to-indigo-500 px-6 py-2 rounded-lg font-semibold panel-transition neon-glow">Submit Jawaban</button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Story Mode -->
                            <div id="storyModePanel" class="hidden">
                                <div class="mb-4">
                                    <div class="flex justify-between items-center mb-3">
                                        <h3 class="orbitron text-base md:text-lg font-bold neon-text">üìñ Story Mode</h3>
                                    </div>
                                    <div class="text-center">
                                        <button onclick="hideStoryMode()" class="bg-red-600/50 hover:bg-red-500/60 px-4 py-2 rounded-lg text-sm panel-transition">
                                            ‚úï Tutup Story Mode
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="bg-gradient-to-r from-pink-900/30 to-purple-900/30 p-4 rounded-xl border border-pink-400/20 mb-4">
                                    <div class="flex items-center gap-3 mb-3">
                                        <span class="text-2xl">üìö</span>
                                        <div>
                                            <h4 class="font-bold text-pink-300" id="currentChapterTitle">Chapter 1: Hari Pertama</h4>
                                            <p class="text-sm text-gray-300" id="storyProgress">Progress: 0/3 Chapter</p>
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-2 gap-2 text-xs">
                                        <div class="bg-purple-800/30 p-2 rounded">
                                            <span class="text-purple-300">Ending Terkumpul:</span>
                                            <span class="font-bold text-cyan-300" id="endingsCount">0/5</span>
                                        </div>
                                        <div class="bg-pink-800/30 p-2 rounded">
                                            <span class="text-pink-300">Path:</span>
                                            <span class="font-bold text-yellow-300" id="currentPath">Neutral</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div id="storyContent" class="bg-purple-900/30 p-4 rounded-xl border border-purple-400/20">
                                    <div class="text-center">
                                        <span class="text-4xl mb-3 block">üìñ</span>
                                        <h4 class="font-bold text-cyan-300 mb-2">Selamat Datang di Story Mode!</h4>
                                        <p class="text-gray-200 mb-4">Ikuti perjalanan sebagai siswa baru dan tentukan nasibmu sendiri.</p>
                                        <button onclick="startStoryMode()" class="bg-gradient-to-r from-pink-600 to-purple-600 hover:from-pink-500 hover:to-purple-500 px-6 py-2 rounded-lg font-semibold panel-transition neon-glow">
                                            üöÄ Mulai Cerita
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Hero Status Section -->
                        <div class="lg:w-80">
                            <h3 class="orbitron text-base md:text-lg font-bold mb-3 md:mb-4 neon-text">ü¶∏‚Äç‚ôÇÔ∏è Status Hero</h3>
                            <div class="bg-gradient-to-br from-indigo-900/50 to-purple-900/50 p-3 md:p-4 rounded-xl border border-indigo-400/30">
                                <div class="text-center mb-4">
                                    <div class="text-4xl mb-2">üåü</div>
                                    <h4 class="font-bold text-cyan-300" id="heroName">Hero Pemula</h4>
                                    <p class="text-sm text-purple-300" id="heroTitle">Pejuang Kebaikan</p>
                                </div>
                                <div class="space-y-3">
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">Level:</span>
                                        <span class="font-bold text-cyan-300" id="heroLevel">1</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">Poin Kebaikan:</span>
                                        <span class="font-bold text-green-300" id="heroKindness">0</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">Kepintaran:</span>
                                        <span class="font-bold text-blue-300" id="heroSmart">1</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">Matematika:</span>
                                        <span class="font-bold text-yellow-300" id="heroMath">0</span>
                                    </div>
                                </div>
                                <div class="mt-4 pt-3 border-t border-purple-400/30">
                                    <p class="text-xs text-gray-400 text-center">Misi Diselesaikan: <span id="completedMissions" class="text-purple-300">0</span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Daily Missions & Features Panel -->
                <div id="featuresPanel" class="bg-black/40 backdrop-blur-md rounded-2xl border border-purple-400/30 p-4 md:p-6 panel-transition fade-slide-in">
                    <!-- Daily Missions -->
                    <div class="mb-6">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="orbitron text-base md:text-lg font-bold neon-text">üéØ Daily Missions</h3>
                            <button onclick="refreshDailyMissions()" class="bg-blue-600/50 hover:bg-blue-500/60 px-2 py-1 rounded text-xs panel-transition" title="Refresh (24h cooldown)">üîÑ</button>
                        </div>
                        <div id="dailyMissionsList" class="space-y-2 mb-4">
                            <!-- Daily missions will be inserted here -->
                        </div>
                    </div>
                    
                    <!-- Quick Actions -->
                    <div class="grid grid-cols-2 gap-2 mb-4">
                        <button onclick="showAchievements()" class="bg-gradient-to-r from-yellow-800/30 to-orange-800/30 hover:from-yellow-700/40 hover:to-orange-700/40 p-2 rounded-lg border border-yellow-400/20 hover:border-yellow-400/40 panel-transition text-xs">
                            <div class="text-lg mb-1">üèÜ</div>
                            <div class="font-semibold">Achievements</div>
                        </button>
                        <button onclick="showCollectibles()" class="bg-gradient-to-r from-purple-800/30 to-pink-800/30 hover:from-purple-700/40 hover:to-pink-700/40 p-2 rounded-lg border border-purple-400/20 hover:border-purple-400/40 panel-transition text-xs">
                            <div class="text-lg mb-1">üíé</div>
                            <div class="font-semibold">Collectibles</div>
                        </button>
                    </div>
                    
                    <!-- Current Mission Status -->
                    <div id="currentMissionStatus" class="bg-gradient-to-r from-green-900/30 to-emerald-900/30 p-3 rounded-lg border border-green-400/20">
                        <h4 class="font-semibold text-green-300 text-sm">Status Misi</h4>
                        <p class="text-xs text-gray-300 mt-1">Pilih lokasi untuk memulai misi</p>
                        <div class="flex justify-between items-center mt-2">
                            <span class="text-xs text-green-300">Siap bermain!</span>
                            <span class="text-xs bg-blue-600 px-2 py-1 rounded">Standby</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Tutorial Modal -->
    <div id="tutorialModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[60] hidden flex items-center justify-center p-2 md:p-4">
        <div class="modal-content bg-gradient-to-br from-purple-900/90 to-indigo-900/90 backdrop-blur-md rounded-xl md:rounded-2xl border border-purple-400/30 max-w-4xl w-full max-h-[95vh] md:max-h-[90vh] overflow-y-auto">
            <div class="p-3 md:p-6">
                <div class="flex justify-between items-center mb-3 md:mb-6">
                    <h2 class="orbitron text-lg md:text-2xl font-bold neon-text">üìñ Tutorial Hero Kebaikan</h2>
                    <button onclick="closeTutorial()" class="bg-red-600/50 hover:bg-red-500/60 px-2 md:px-3 py-1 rounded-lg text-xs md:text-sm panel-transition">Tutup</button>
                </div>
                
                <div id="tutorialContent" class="space-y-3 md:space-y-6 min-h-[300px] md:min-h-[400px]">
                    <!-- Tutorial steps will be inserted here -->
                </div>
                
                <div class="flex justify-between items-center mt-3 md:mt-6 gap-2">
                    <button id="prevTutorialBtn" onclick="prevTutorialStep()" class="bg-gray-600/50 hover:bg-gray-500/60 px-2 md:px-4 py-1 md:py-2 rounded-lg panel-transition text-xs md:text-sm" disabled>‚¨ÖÔ∏è <span class="hidden sm:inline">Sebelumnya</span></button>
                    <span id="tutorialProgress" class="text-purple-300 text-sm md:text-base">1 / 5</span>
                    <button id="nextTutorialBtn" onclick="nextTutorialStep()" class="bg-purple-600/50 hover:bg-purple-500/60 px-2 md:px-4 py-1 md:py-2 rounded-lg panel-transition text-xs md:text-sm"><span class="hidden sm:inline">Selanjutnya</span> ‚û°Ô∏è</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Game Info Modal -->
    <div id="gameInfoModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[60] hidden flex items-center justify-center p-4">
        <div class="modal-content bg-gradient-to-br from-purple-900/90 to-indigo-900/90 backdrop-blur-md rounded-2xl border border-purple-400/30 max-w-3xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="orbitron text-2xl font-bold neon-text">‚ÑπÔ∏è Tentang Game</h2>
                    <button onclick="closeGameInfo()" class="bg-red-600/50 hover:bg-red-500/60 px-3 py-1 rounded-lg text-sm panel-transition">Tutup</button>
                </div>
                
                <div class="space-y-6">
                    <!-- Game Description -->
                    <div class="bg-purple-900/30 p-4 rounded-xl border border-purple-400/20">
                        <h3 class="orbitron text-lg font-bold mb-3 text-cyan-300">üéÆ Deskripsi Game</h3>
                        <p class="text-gray-200 leading-relaxed">
                            Hero Kebaikan adalah game edukasi interaktif yang mengajarkan nilai-nilai anti-bullying dan kebaikan. 
                            Pemain akan menghadapi berbagai skenario kehidupan nyata dan membuat pilihan yang mencerminkan karakter positif. 
                            Game ini menggabungkan pembelajaran moral dengan latihan matematika untuk pengembangan karakter yang holistik.
                        </p>
                    </div>

                    <!-- Game Features -->
                    <div class="bg-indigo-900/30 p-4 rounded-xl border border-indigo-400/20">
                        <h3 class="orbitron text-lg font-bold mb-3 text-cyan-300">‚ú® Fitur Game</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div class="flex items-start gap-2">
                                <span class="text-green-400">üéØ</span>
                                <div>
                                    <h4 class="font-semibold text-green-300">Skenario Interaktif</h4>
                                    <p class="text-sm text-gray-300">Berbagai situasi kehidupan nyata untuk dipecahkan</p>
                                </div>
                            </div>
                            <div class="flex items-start gap-2">
                                <span class="text-blue-400">üßÆ</span>
                                <div>
                                    <h4 class="font-semibold text-blue-300">Math Tutor</h4>
                                    <p class="text-sm text-gray-300">Latihan matematika SMP dengan berbagai kategori</p>
                                </div>
                            </div>
                            <div class="flex items-start gap-2">
                                <span class="text-purple-400">üèÜ</span>
                                <div>
                                    <h4 class="font-semibold text-purple-300">Sistem Poin</h4>
                                    <p class="text-sm text-gray-300">Kumpulkan poin kebaikan dan matematika</p>
                                </div>
                            </div>
                            <div class="flex items-start gap-2">
                                <span class="text-yellow-400">üíæ</span>
                                <div>
                                    <h4 class="font-semibold text-yellow-300">Auto-Save</h4>
                                    <p class="text-sm text-gray-300">Progress tersimpan otomatis setiap 30 detik</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Developer Info -->
                    <div class="bg-gradient-to-r from-cyan-900/30 to-blue-900/30 p-4 rounded-xl border border-cyan-400/20">
                        <h3 class="orbitron text-lg font-bold mb-3 text-cyan-300">üë• Tim Developer</h3>
                        <div class="text-center mb-4">
                            <h4 class="text-xl font-bold text-cyan-300 mb-2">Kelompok 2 Informatika</h4>
                            <p class="text-purple-300 mb-4">SMPN 20 SKA - Tugas Kelompok Informatika</p>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                            <div class="bg-purple-800/30 p-3 rounded-lg text-center">
                                <div class="text-2xl mb-1">üë®‚Äçüíª</div>
                                <h5 class="font-semibold text-cyan-300">Keanu</h5>
                                <p class="text-xs text-gray-400">Developer/Programmer</p>
                            </div>
                            <div class="bg-purple-800/30 p-3 rounded-lg text-center">
                                <div class="text-2xl mb-1">üé®</div>
                                <h5 class="font-semibold text-cyan-300">Rafa</h5>
                                <p class="text-xs text-gray-400">UI/UX Designer</p>
                            </div>
                            <div class="bg-purple-800/30 p-3 rounded-lg text-center">
                                <div class="text-2xl mb-1">üìñ</div>
                                <h5 class="font-semibold text-cyan-300">Ayatulhusna</h5>
                                <p class="text-xs text-gray-400">Narrative Designer</p>
                            </div>
                            <div class="bg-purple-800/30 p-3 rounded-lg text-center">
                                <div class="text-2xl mb-1">üìö</div>
                                <h5 class="font-semibold text-cyan-300">Nadinda</h5>
                                <p class="text-xs text-gray-400">Story Designer</p>
                            </div>
                            <div class="bg-purple-800/30 p-3 rounded-lg text-center">
                                <div class="text-2xl mb-1">üéÆ</div>
                                <h5 class="font-semibold text-cyan-300">Aura</h5>
                                <p class="text-xs text-gray-400">Game Designer</p>
                            </div>
                            <div class="bg-purple-800/30 p-3 rounded-lg text-center">
                                <div class="text-2xl mb-1">üéµ</div>
                                <h5 class="font-semibold text-cyan-300">Nabila</h5>
                                <p class="text-xs text-gray-400">Audio Designer</p>
                            </div>
                        </div>
                        <div class="text-center mt-4 pt-3 border-t border-cyan-400/30">
                            <p class="text-sm text-gray-300">
                                üåü Dibuat dengan ‚ù§Ô∏è untuk pendidikan anti-bullying
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Achievements Modal -->
    <div id="achievementsModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[60] hidden flex items-center justify-center p-4">
        <div class="modal-content bg-gradient-to-br from-yellow-900/90 to-orange-900/90 backdrop-blur-md rounded-2xl border border-yellow-400/30 max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="orbitron text-2xl font-bold neon-text">üèÜ Achievements</h2>
                    <button onclick="closeAchievements()" class="bg-red-600/50 hover:bg-red-500/60 px-3 py-1 rounded-lg text-sm panel-transition">Tutup</button>
                </div>
                
                <div id="achievementsList" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Achievements will be inserted here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Collectibles Modal -->
    <div id="collectiblesModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[60] hidden flex items-center justify-center p-4">
        <div class="modal-content bg-gradient-to-br from-purple-900/90 to-pink-900/90 backdrop-blur-md rounded-2xl border border-purple-400/30 max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="orbitron text-2xl font-bold neon-text">üíé Koleksi Item</h2>
                    <button onclick="closeCollectibles()" class="bg-red-600/50 hover:bg-red-500/60 px-3 py-1 rounded-lg text-sm panel-transition">Tutup</button>
                </div>
                
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4" id="collectiblesList">
                    <!-- Collectibles will be inserted here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Mini Game Modal -->
    <div id="miniGameModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[60] hidden flex items-center justify-center p-4">
        <div class="modal-content bg-gradient-to-br from-cyan-900/90 to-teal-900/90 backdrop-blur-md rounded-2xl border border-cyan-400/30 max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="orbitron text-2xl font-bold neon-text">üéØ Mini Game: Susun Kata</h2>
                    <button onclick="closeMiniGame()" class="bg-red-600/50 hover:bg-red-500/60 px-3 py-1 rounded-lg text-sm panel-transition">Tutup</button>
                </div>
                
                <div id="miniGameContent" class="space-y-6">
                    <!-- Mini game content will be inserted here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Bully Defender Modal -->
    <div id="bullyDefenderModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[60] hidden flex items-center justify-center p-4">
        <div class="modal-content bg-gradient-to-br from-red-900/90 to-orange-900/90 backdrop-blur-md rounded-2xl border border-red-400/30 max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="orbitron text-2xl font-bold neon-text">üõ°Ô∏è Bully Defender</h2>
                    <button onclick="closeBullyDefender()" class="bg-red-600/50 hover:bg-red-500/60 px-3 py-1 rounded-lg text-sm panel-transition">Tutup</button>
                </div>
                
                <div id="bullyDefenderContent" class="space-y-6">
                    <!-- Bully Defender content will be inserted here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Inventory Modal -->
    <div id="inventoryModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[60] hidden flex items-center justify-center p-4">
        <div class="modal-content bg-gradient-to-br from-indigo-900/90 to-purple-900/90 backdrop-blur-md rounded-2xl border border-indigo-400/30 max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="orbitron text-2xl font-bold neon-text">üéí Inventory</h2>
                    <button onclick="closeInventory()" class="bg-red-600/50 hover:bg-red-500/60 px-3 py-1 rounded-lg text-sm panel-transition">Tutup</button>
                </div>
                
                <div class="space-y-6">
                    <!-- Badges Section -->
                    <div>
                        <h3 class="orbitron text-lg font-bold mb-3 text-cyan-300">üèÖ Badges</h3>
                        <div class="grid grid-cols-3 md:grid-cols-6 gap-3" id="badgesList">
                            <!-- Badges will be inserted here -->
                        </div>
                    </div>
                    
                    <!-- Items Section -->
                    <div>
                        <h3 class="orbitron text-lg font-bold mb-3 text-cyan-300">üì¶ Items</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3" id="itemsList">
                            <!-- Items will be inserted here -->
                        </div>
                    </div>
                    
                    <!-- Story Endings Section -->
                    <div>
                        <h3 class="orbitron text-lg font-bold mb-3 text-cyan-300">üìö Story Endings</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3" id="endingsList">
                            <!-- Endings will be inserted here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Game State
        let gameState = {
            playerLevel: 1,
            kindnessPoints: 0,
            smartLevel: 1,
            mathPoints: 0,
            completedMissions: 0,
            currentLocation: null,
            currentMathCategory: null,
            currentQuestion: null,
            selectedAnswer: null,
            hasSeenTutorial: false,
            // New features
            dailyMissions: [],
            lastDailyReset: null,
            collectibles: [],
            achievements: [],
            storyProgress: {
                currentChapter: 1,
                completedChapters: [],
                unlockedEndings: [],
                currentPath: 'neutral',
                currentScenario: 'intro_1'
            },
            inventory: {
                badges: [],
                items: [],
                specialItems: []
            },
            // Lock system
            unlockedFeatures: {
                storyMode: false,
                mathTutor: false,
                miniGame: false,
                inventory: false,
                park: false,
                classroom: false
            },
            // UI State
            isPanelLocked: false,
            isMobileMapOpen: false,
            isSidebarOpen: false,
            recentActivity: []
        };

        // Panel lock state
        let isPanelLocked = false;
        
        // Auto-save timer
        let autoSaveTimer = 30;
        let autoSaveInterval = null;
        let autoSaveCountdown = null;

        // Daily missions data
        const dailyMissionTemplates = [
            {
                id: 'kindness_streak',
                title: 'üåü Streak Kebaikan',
                description: 'Dapatkan 3 pilihan positif berturut-turut',
                target: 3,
                reward: { type: 'collectible', item: 'golden_heart', points: 25 },
                difficulty: 'easy'
            },
            {
                id: 'math_master',
                title: 'üßÆ Master Matematika',
                description: 'Jawab 5 soal matematika dengan benar',
                target: 5,
                reward: { type: 'collectible', item: 'crystal_brain', points: 30 },
                difficulty: 'medium'
            },
            {
                id: 'hero_helper',
                title: 'ü¶∏‚Äç‚ôÇÔ∏è Hero Helper',
                description: 'Selesaikan 2 misi di lokasi berbeda',
                target: 2,
                reward: { type: 'collectible', item: 'hero_cape', points: 35 },
                difficulty: 'medium'
            },
            {
                id: 'perfect_score',
                title: '‚≠ê Skor Sempurna',
                description: 'Dapatkan pilihan terbaik (+15 poin atau lebih) sebanyak 3 kali',
                target: 3,
                reward: { type: 'collectible', item: 'diamond_star', points: 50 },
                difficulty: 'hard'
            },
            {
                id: 'story_explorer',
                title: 'üìñ Penjelajah Cerita',
                description: 'Mainkan Story Mode dan capai 1 ending',
                target: 1,
                reward: { type: 'collectible', item: 'ancient_scroll', points: 40 },
                difficulty: 'medium'
            }
        ];

        // Level titles
        const levelTitles = {
            1: "üå± Benih Kebaikan",
            2: "üåø Tunas Harapan", 
            3: "üå∏ Bunga Kasih",
            4: "üå≥ Pohon Kebijaksanaan",
            5: "‚≠ê Bintang Pemula",
            6: "üåü Cahaya Kebaikan",
            7: "‚ú® Pejuang Cahaya",
            8: "üî• Api Semangat",
            9: "‚ö° Kilat Keadilan",
            10: "üåà Pelangi Harapan",
            11: "ü¶ã Kupu-kupu Transformasi",
            12: "üïäÔ∏è Merpati Perdamaian",
            13: "üåä Gelombang Perubahan",
            14: "üèîÔ∏è Gunung Keteguhan",
            15: "üåô Bulan Kebijaksanaan",
            16: "‚òÄÔ∏è Matahari Kebaikan",
            17: "üåå Galaksi Inspirasi",
            18: "üëë Mahkota Kemuliaan",
            19: "üèÜ Juara Kemanusiaan",
            20: "üéñÔ∏è Legenda Kebaikan"
        };

        // Unlock requirements
        const unlockRequirements = {
            storyMode: { kindnessPoints: 30, level: 2, message: "Selesaikan 3 misi di Sekolah untuk membuka Story Mode" },
            mathTutor: { kindnessPoints: 20, level: 2, message: "Dapatkan 20 poin kebaikan untuk membuka Math Tutor" },
            miniGame: { kindnessPoints: 50, level: 3, message: "Capai level 3 untuk membuka Mini Game" },
            inventory: { kindnessPoints: 10, level: 1, message: "Dapatkan 10 poin kebaikan untuk membuka Inventory" },
            park: { completedMissions: 2, message: "Selesaikan 2 misi untuk membuka Taman" },
            classroom: { completedMissions: 4, message: "Selesaikan 4 misi untuk membuka Ruang Kelas" }
        };

        // Collectibles data
        const collectiblesData = {
            golden_heart: {
                name: 'Hati Emas',
                icon: 'üíõ',
                rarity: 'common',
                description: 'Simbol kebaikan yang tulus dari hati'
            },
            crystal_brain: {
                name: 'Otak Kristal',
                icon: 'üß†',
                rarity: 'uncommon',
                description: 'Kristal yang meningkatkan kemampuan berpikir'
            },
            hero_cape: {
                name: 'Jubah Hero',
                icon: 'ü¶∏‚Äç‚ôÇÔ∏è',
                rarity: 'rare',
                description: 'Jubah legendaris para hero kebaikan'
            },
            diamond_star: {
                name: 'Bintang Berlian',
                icon: 'üíé',
                rarity: 'epic',
                description: 'Bintang yang bersinar dengan cahaya kebaikan'
            },
            ancient_scroll: {
                name: 'Gulungan Kuno',
                icon: 'üìú',
                rarity: 'legendary',
                description: 'Berisi kisah-kisah hero masa lalu'
            },
            phoenix_feather: {
                name: 'Bulu Phoenix',
                icon: 'ü™∂',
                rarity: 'mythic',
                description: 'Bulu dari phoenix yang melambangkan kelahiran kembali'
            },
            // New collectibles
            silver_shield: {
                name: 'Perisai Perak',
                icon: 'üõ°Ô∏è',
                rarity: 'uncommon',
                description: 'Perisai yang melindungi dari kata-kata jahat'
            },
            rainbow_gem: {
                name: 'Permata Pelangi',
                icon: 'üåà',
                rarity: 'rare',
                description: 'Permata yang memancarkan keberagaman'
            },
            wisdom_owl: {
                name: 'Burung Hantu Bijak',
                icon: 'ü¶â',
                rarity: 'epic',
                description: 'Pembawa kebijaksanaan dan pengetahuan'
            },
            peace_dove: {
                name: 'Merpati Perdamaian',
                icon: 'üïäÔ∏è',
                rarity: 'legendary',
                description: 'Simbol perdamaian dan harmoni'
            },
            cosmic_crown: {
                name: 'Mahkota Kosmik',
                icon: 'üëë',
                rarity: 'mythic',
                description: 'Mahkota yang diberikan kepada hero terhebat'
            },
            friendship_ring: {
                name: 'Cincin Persahabatan',
                icon: 'üíç',
                rarity: 'common',
                description: 'Cincin yang memperkuat ikatan persahabatan'
            },
            courage_medal: {
                name: 'Medali Keberanian',
                icon: 'üèÖ',
                rarity: 'rare',
                description: 'Penghargaan untuk tindakan berani'
            },
            unity_torch: {
                name: 'Obor Persatuan',
                icon: 'üî•',
                rarity: 'epic',
                description: 'Obor yang menyatukan semua perbedaan'
            },
            magic_wand: {
                name: 'Tongkat Ajaib',
                icon: 'ü™Ñ',
                rarity: 'legendary',
                description: 'Tongkat yang mengubah kebencian menjadi cinta'
            },
            infinity_crystal: {
                name: 'Kristal Tak Terbatas',
                icon: 'üí†',
                rarity: 'mythic',
                description: 'Kristal dengan kekuatan kebaikan tak terbatas'
            }
        };

        // Achievements data
        const achievementsData = [
            {
                id: 'first_steps',
                title: 'üë∂ Langkah Pertama',
                description: 'Selesaikan misi pertama',
                icon: 'üåü',
                reward: { points: 10, badge: 'newcomer', item: 'friendship_ring' },
                unlocked: false
            },
            {
                id: 'kindness_warrior',
                title: '‚öîÔ∏è Pejuang Kebaikan',
                description: 'Kumpulkan 100 poin kebaikan',
                icon: 'üõ°Ô∏è',
                reward: { points: 50, badge: 'warrior', item: 'silver_shield' },
                unlocked: false
            },
            {
                id: 'math_genius',
                title: 'üß† Jenius Matematika',
                description: 'Capai Smart Level 10',
                icon: 'üéì',
                reward: { points: 75, badge: 'genius', item: 'wisdom_owl' },
                unlocked: false
            },
            {
                id: 'story_master',
                title: 'üìö Master Cerita',
                description: 'Kumpulkan semua ending di Story Mode',
                icon: 'üëë',
                reward: { points: 200, badge: 'story_master', item: 'ancient_scroll' },
                unlocked: false
            },
            {
                id: 'daily_champion',
                title: 'üèÜ Juara Harian',
                description: 'Selesaikan daily mission 7 hari berturut-turut',
                icon: 'üî•',
                reward: { points: 100, badge: 'champion', item: 'unity_torch' },
                unlocked: false
            },
            {
                id: 'perfect_hero',
                title: '‚ú® Hero Sempurna',
                description: 'Capai level 20 dengan 500+ poin kebaikan',
                icon: 'üåü',
                reward: { points: 300, badge: 'perfect', item: 'cosmic_crown' },
                unlocked: false
            },
            // New achievements
            {
                id: 'brave_heart',
                title: 'üí™ Hati Pemberani',
                description: 'Pilih tindakan berani 10 kali',
                icon: 'ü¶Å',
                reward: { points: 40, badge: 'brave', item: 'courage_medal' },
                unlocked: false
            },
            {
                id: 'peace_maker',
                title: 'üïäÔ∏è Pembuat Damai',
                description: 'Selesaikan 20 konflik dengan damai',
                icon: '‚òÆÔ∏è',
                reward: { points: 80, badge: 'peacemaker', item: 'peace_dove' },
                unlocked: false
            },
            {
                id: 'diversity_champion',
                title: 'üåà Juara Keberagaman',
                description: 'Bantu 15 orang dari latar belakang berbeda',
                icon: 'ü§ù',
                reward: { points: 60, badge: 'diversity', item: 'rainbow_gem' },
                unlocked: false
            },
            {
                id: 'word_master',
                title: 'üìù Master Kata',
                description: 'Selesaikan 10 mini game susun kata',
                icon: 'üéØ',
                reward: { points: 50, badge: 'wordsmith', item: 'magic_wand' },
                unlocked: false
            },
            {
                id: 'level_legend',
                title: 'üéñÔ∏è Legenda Level',
                description: 'Capai level maksimum (20)',
                icon: 'üëë',
                reward: { points: 500, badge: 'legend', item: 'infinity_crystal' },
                unlocked: false
            },
            {
                id: 'collector_supreme',
                title: 'üíé Kolektor Tertinggi',
                description: 'Kumpulkan 50 item collectible',
                icon: 'üèÜ',
                reward: { points: 200, badge: 'collector', item: 'phoenix_feather' },
                unlocked: false
            },
            {
                id: 'helper_hero',
                title: 'ü§ó Hero Penolong',
                description: 'Bantu 100 orang dalam cerita',
                icon: 'üíù',
                reward: { points: 150, badge: 'helper', item: 'golden_heart' },
                unlocked: false
            },
            {
                id: 'smart_cookie',
                title: 'üç™ Anak Pintar',
                description: 'Jawab 50 soal matematika dengan benar',
                icon: 'üßÆ',
                reward: { points: 70, badge: 'smart', item: 'crystal_brain' },
                unlocked: false
            },
            {
                id: 'anti_bully_champion',
                title: 'üõ°Ô∏è Juara Anti-Bullying',
                description: 'Hentikan 25 kasus bullying',
                icon: 'üö´',
                reward: { points: 120, badge: 'antibully', item: 'hero_cape' },
                unlocked: false
            }
        ];

        // Story Mode data - Expanded with full branching narratives
        const storyChapters = {
            1: {
                title: 'Hari Pertama di Sekolah Baru',
                description: 'Kamu adalah siswa baru di SMPN 20. Hari pertama selalu menentukan...',
                scenarios: {
                    // Starting scenario
                    'intro_1': {
                        title: 'Perkenalan di Kelas',
                        description: 'Guru memintamu memperkenalkan diri. Beberapa siswa terlihat ramah, tapi ada juga yang menatapmu dengan curiga. Kamu berdiri di depan kelas dengan 30 pasang mata menatapmu.',
                        character: 'üòä',
                        choices: [
                            { text: 'Memperkenalkan diri dengan percaya diri dan ramah', points: 10, path: 'confident', nextId: 'confident_1' },
                            { text: 'Memperkenalkan diri dengan sederhana dan rendah hati', points: 8, path: 'humble', nextId: 'humble_1' },
                            { text: 'Memperkenalkan diri dengan singkat karena gugup', points: 5, path: 'shy', nextId: 'shy_1' },
                            { text: 'Menolak memperkenalkan diri', points: -5, path: 'rebellious', nextId: 'rebel_1' }
                        ]
                    },
                    
                    // CONFIDENT PATH
                    'confident_1': {
                        title: 'Reaksi Teman Sekelas',
                        description: 'Perkenalan percaya dirimu mendapat reaksi beragam. Beberapa siswa terlihat terkesan, tapi ada juga yang berbisik-bisik. Saat istirahat, dua kelompok berbeda mendekatmu.',
                        character: 'ü§î',
                        choices: [
                            { text: 'Bergabung dengan kelompok populer yang mengajakmu', points: 5, path: 'confident', nextId: 'confident_2a' },
                            { text: 'Memilih duduk dengan siswa yang terlihat pendiam', points: 12, path: 'confident', nextId: 'confident_2b' },
                            { text: 'Mencoba berkenalan dengan semua kelompok', points: 15, path: 'confident', nextId: 'confident_2c' },
                            { text: 'Tetap sendirian dan mengamati situasi', points: 3, path: 'confident', nextId: 'confident_2d' }
                        ]
                    },
                    
                    'confident_2a': {
                        title: 'Bergabung dengan Kelompok Populer',
                        description: 'Kamu bergabung dengan kelompok populer. Mereka ramah tapi kamu mendengar mereka sering membicarakan siswa lain dengan tidak baik. Saat mereka mulai mengejek siswa berkacamata di pojok kelas, semua mata tertuju padamu.',
                        character: 'üò¨',
                        choices: [
                            { text: 'Ikut tertawa agar diterima kelompok', points: -10, path: 'confident', nextId: 'confident_3a' },
                            { text: 'Diam saja dan tidak ikut campur', points: -3, path: 'confident', nextId: 'confident_3b' },
                            { text: 'Mengalihkan pembicaraan ke topik lain', points: 8, path: 'confident', nextId: 'confident_3c' },
                            { text: 'Membela siswa yang diejek dengan tegas', points: 18, path: 'confident', nextId: 'confident_3d' }
                        ]
                    },
                    
                    'confident_2b': {
                        title: 'Memilih Teman yang Pendiam',
                        description: 'Kamu memilih duduk dengan Rina, siswa pendiam yang sering sendirian. Dia terkejut tapi senang ada yang mau berteman. Ternyata dia sangat pintar dan baik hati, hanya saja pemalu.',
                        character: 'üòä',
                        choices: [
                            { text: 'Mengajak Rina bergabung dengan aktivitas kelas', points: 15, path: 'confident', nextId: 'confident_3e' },
                            { text: 'Menjadi sahabat baik dan melindunginya', points: 12, path: 'confident', nextId: 'confident_3f' },
                            { text: 'Membantu Rina lebih percaya diri', points: 20, path: 'confident', nextId: 'confident_3g' },
                            { text: 'Berteman biasa saja', points: 5, path: 'confident', nextId: 'confident_3h' }
                        ]
                    },
                    
                    'confident_2c': {
                        title: 'Diplomat Kelas',
                        description: 'Kamu berhasil berkenalan dengan semua kelompok. Setiap orang merasa dihargai dan kamu menjadi jembatan antar kelompok. Namun, ada konflik antara dua kelompok yang berbeda dan mereka memintamu memilih sisi.',
                        character: 'ü§ù',
                        choices: [
                            { text: 'Memilih satu sisi yang lebih kuat', points: -5, path: 'confident', nextId: 'confident_3i' },
                            { text: 'Mencoba mendamaikan kedua kelompok', points: 25, path: 'confident', nextId: 'confident_3j' },
                            { text: 'Tetap netral dan tidak memihak', points: 8, path: 'confident', nextId: 'confident_3k' },
                            { text: 'Mengundurkan diri dari konflik', points: 0, path: 'confident', nextId: 'confident_3l' }
                        ]
                    },
                    
                    // HUMBLE PATH
                    'humble_1': {
                        title: 'Kesan Pertama yang Baik',
                        description: 'Perkenalan rendah hatimu membuat banyak siswa merasa nyaman. Guru juga terkesan dengan sikapmu. Saat jam makan siang, kamu melihat seorang siswa makan sendirian sambil membaca buku.',
                        character: 'üìö',
                        choices: [
                            { text: 'Mendekat dan mengajak berbicara tentang buku', points: 12, path: 'humble', nextId: 'humble_2a' },
                            { text: 'Mengajak bergabung makan bersama', points: 15, path: 'humble', nextId: 'humble_2b' },
                            { text: 'Memberikan makanan tambahan yang kamu bawa', points: 18, path: 'humble', nextId: 'humble_2c' },
                            { text: 'Menghormati privasi dan tidak mengganggu', points: 5, path: 'humble', nextId: 'humble_2d' }
                        ]
                    },
                    
                    'humble_2a': {
                        title: 'Diskusi Buku',
                        description: 'Ternyata dia bernama Dani, anak yang sangat cerdas tapi sering diabaikan karena tidak suka bersosialisasi. Kalian berdiskusi tentang buku dan kamu menemukan dia memiliki wawasan yang luar biasa.',
                        character: 'ü§ì',
                        choices: [
                            { text: 'Mengajak Dani berbagi pengetahuan dengan kelas', points: 20, path: 'humble', nextId: 'humble_3a' },
                            { text: 'Menjadi teman belajar yang baik', points: 15, path: 'humble', nextId: 'humble_3b' },
                            { text: 'Membantu Dani lebih terbuka dengan orang lain', points: 18, path: 'humble', nextId: 'humble_3c' },
                            { text: 'Menjaga persahabatan tetap privat', points: 8, path: 'humble', nextId: 'humble_3d' }
                        ]
                    },
                    
                    // SHY PATH
                    'shy_1': {
                        title: 'Perkenalan Singkat',
                        description: 'Perkenalan singkatmu membuat beberapa siswa penasaran, tapi ada juga yang menganggapmu sombong. Di koridor, kamu mendengar bisikan tentang dirimu. Seorang siswa mendekat dengan niat tidak baik.',
                        character: 'üòü',
                        choices: [
                            { text: 'Menghindar dan mencari tempat aman', points: 2, path: 'shy', nextId: 'shy_2a' },
                            { text: 'Menghadapi dengan berani meski takut', points: 15, path: 'shy', nextId: 'shy_2b' },
                            { text: 'Mencari bantuan guru atau senior', points: 10, path: 'shy', nextId: 'shy_2c' },
                            { text: 'Mencoba menjelaskan dengan baik-baik', points: 12, path: 'shy', nextId: 'shy_2d' }
                        ]
                    },
                    
                    // REBELLIOUS PATH
                    'rebel_1': {
                        title: 'Konsekuensi Penolakan',
                        description: 'Penolakanmu membuat suasana kelas menjadi tegang. Guru terlihat tidak senang dan beberapa siswa mulai memandangmu dengan negatif. Setelah kelas, guru memanggilmu untuk berbicara empat mata.',
                        character: 'üò§',
                        choices: [
                            { text: 'Tetap keras kepala dan tidak mau berubah', points: -15, path: 'rebellious', nextId: 'rebel_2a' },
                            { text: 'Menjelaskan alasan dengan jujur', points: 5, path: 'rebellious', nextId: 'rebel_2b' },
                            { text: 'Meminta maaf dan berjanji berubah', points: 12, path: 'rebellious', nextId: 'rebel_2c' },
                            { text: 'Menunjukkan sikap defensif', points: -8, path: 'rebellious', nextId: 'rebel_2d' }
                        ]
                    }
                }
            },
            
            2: {
                title: 'Menghadapi Tantangan',
                description: 'Minggu kedua di sekolah, kamu mulai menghadapi berbagai tantangan sosial...',
                scenarios: {
                    // Chapter 2 scenarios will continue from Chapter 1 choices
                    // This creates a truly branching narrative
                    'confident_chapter2': {
                        title: 'Ujian Kepemimpinan',
                        description: 'Berkat kepercayaan diri dan pilihan-pilihan baikmu, kamu terpilih sebagai ketua kelas. Namun, tanggung jawab ini membawa tantangan baru...',
                        character: 'üëë',
                        choices: [
                            { text: 'Memimpin dengan tegas dan adil', points: 20, path: 'confident', nextId: 'leader_path' },
                            { text: 'Memimpin dengan pendekatan demokratis', points: 18, path: 'confident', nextId: 'democratic_path' },
                            { text: 'Merasa terbebani dan ingin mundur', points: -5, path: 'confident', nextId: 'burden_path' }
                        ]
                    },
                    
                    'humble_chapter2': {
                        title: 'Menjadi Penengah',
                        description: 'Sikap rendah hati dan bijaksanamu membuat semua orang mempercayaimu. Ketika ada konflik besar di kelas, semua mata tertuju padamu untuk menyelesaikannya...',
                        character: '‚öñÔ∏è',
                        choices: [
                            { text: 'Mendengarkan semua pihak dengan sabar', points: 22, path: 'humble', nextId: 'mediator_path' },
                            { text: 'Mencari solusi kreatif yang menguntungkan semua', points: 25, path: 'humble', nextId: 'creative_solution' },
                            { text: 'Merasa tidak mampu dan meminta bantuan guru', points: 8, path: 'humble', nextId: 'seek_help' }
                        ]
                    }
                }
            },
            
            3: {
                title: 'Menjadi Hero Sejati',
                description: 'Saatnya membuktikan diri sebagai hero kebaikan yang sesungguhnya...',
                scenarios: {
                    'final_test': {
                        title: 'Ujian Terakhir Kebaikan',
                        description: 'Sekolah menghadapi krisis besar. Seorang siswa terancam dikeluarkan karena tuduhan yang belum tentu benar. Semua orang takut terlibat, tapi kamu tahu kebenaran...',
                        character: '‚ö°',
                        choices: [
                            { text: 'Berani bersaksi meski berisiko', points: 30, path: 'hero', nextId: 'true_hero' },
                            { text: 'Mencari bukti diam-diam', points: 20, path: 'detective', nextId: 'detective_hero' },
                            { text: 'Mengorganisir dukungan dari teman-teman', points: 25, path: 'leader', nextId: 'leader_hero' },
                            { text: 'Diam karena takut konsekuensi', points: -20, path: 'coward', nextId: 'missed_chance' }
                        ]
                    }
                }
            }
        };

        // Story endings
        const storyEndings = {
            'hero_legend': {
                title: 'üåü Legenda Hero',
                description: 'Kamu menjadi legenda di sekolah sebagai hero yang selalu membantu semua orang',
                requirements: { kindnessPoints: 200, path: 'confident', completedChapters: 3 },
                collectible: 'phoenix_feather'
            },
            'wise_guardian': {
                title: 'üßô‚Äç‚ôÇÔ∏è Penjaga Bijak',
                description: 'Kamu menjadi sosok yang dihormati karena kebijaksanaan dan kebaikanmu',
                requirements: { kindnessPoints: 150, smartLevel: 15, path: 'humble' },
                collectible: 'ancient_scroll'
            },
            'silent_hero': {
                title: 'ü§´ Hero Tersembunyi',
                description: 'Kamu membantu orang lain tanpa mencari pujian, menjadi hero dalam keheningan',
                requirements: { kindnessPoints: 100, path: 'shy', secretGoodDeeds: 10 },
                collectible: 'crystal_brain'
            },
            'redeemed_soul': {
                title: 'üí´ Jiwa yang Ditebus',
                description: 'Dari awal yang kelam, kamu berubah menjadi sosok yang menginspirasi',
                requirements: { kindnessPoints: 80, path: 'rebellious', redemptionActs: 5 },
                collectible: 'diamond_star'
            },
            'balanced_life': {
                title: '‚öñÔ∏è Kehidupan Seimbang',
                description: 'Kamu menemukan keseimbangan antara kebaikan, kepintaran, dan kebahagiaan',
                requirements: { kindnessPoints: 120, mathPoints: 100, completedChapters: 3 },
                collectible: 'golden_heart'
            }
        };

        // Tutorial data - Optimized for mobile and desktop
        const tutorialSteps = [
            {
                title: "üåü Selamat Datang, Hero!",
                animation: "tutorial-bounce",
                content: `
                    <div class="text-center">
                        <div class="text-4xl md:text-6xl mb-3 md:mb-4 tutorial-bounce">ü¶∏‚Äç‚ôÇÔ∏è</div>
                        <h3 class="text-lg md:text-xl font-bold text-cyan-300 mb-3 md:mb-4 tutorial-pulse">Selamat datang di Hero Kebaikan!</h3>
                        <div class="bg-gradient-to-r from-purple-900/40 to-indigo-900/40 p-3 md:p-4 rounded-xl border border-purple-400/30 mb-3 md:mb-4">
                            <div class="space-y-3 md:space-y-4">
                                <div class="text-left">
                                    <p class="text-sm md:text-base text-gray-200 leading-relaxed">
                                        <span class="text-lg md:text-xl">üéÆ</span> <strong class="text-cyan-300">Apa itu Hero Kebaikan?</strong>
                                    </p>
                                    <p class="text-xs md:text-sm text-gray-300 mt-1 ml-6 md:ml-8">
                                        Game edukasi yang mengajarkan cara melawan bullying dan menyebarkan kebaikan.
                                    </p>
                                </div>
                                <div class="text-left">
                                    <p class="text-sm md:text-base text-gray-200 leading-relaxed">
                                        <span class="text-lg md:text-xl">‚ö°</span> <strong class="text-cyan-300">Bagaimana cara bermain?</strong>
                                    </p>
                                    <p class="text-xs md:text-sm text-gray-300 mt-1 ml-6 md:ml-8">
                                        Hadapi situasi bullying, pilih tindakan terbaik, dan dapatkan poin kebaikan!
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-cyan-900/30 p-2 md:p-3 rounded-lg tutorial-glow">
                            <p class="text-cyan-300 font-semibold text-sm md:text-base">üöÄ Mari jadi Hero yang melindungi teman-teman!</p>
                        </div>
                    </div>
                `
            },
            {
                title: "üó∫Ô∏è Cara Memilih Lokasi",
                animation: "tutorial-slide-left",
                content: `
                    <div class="tutorial-slide-left">
                        <div class="bg-gradient-to-r from-blue-900/40 to-purple-900/40 p-3 md:p-4 rounded-xl border border-blue-400/30 mb-3 md:mb-4">
                            <h4 class="font-bold text-cyan-300 mb-2 md:mb-3 text-sm md:text-base">üìç Langkah 1: Pilih Lokasi</h4>
                            <p class="text-gray-200 mb-2 md:mb-3 text-xs md:text-sm">Klik salah satu lokasi untuk memulai cerita:</p>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-2 md:gap-4 mb-3 md:mb-4">
                            <div class="bg-purple-800/30 p-2 md:p-3 rounded-lg text-center tutorial-pulse border border-purple-400/30">
                                <div class="text-lg md:text-2xl mb-1 md:mb-2">üè´</div>
                                <h4 class="font-semibold text-purple-300 text-xs md:text-sm">Sekolah</h4>
                                <p class="text-xs text-gray-400 mt-1 hidden md:block">Koridor, kantin, kelas</p>
                                <p class="text-xs text-gray-400 mt-1 md:hidden">Selalu terbuka</p>
                            </div>
                            <div class="bg-green-800/30 p-2 md:p-3 rounded-lg text-center tutorial-pulse border border-green-400/30 opacity-60">
                                <div class="text-lg md:text-2xl mb-1 md:mb-2">üå≥</div>
                                <h4 class="font-semibold text-green-300 text-xs md:text-sm">Taman</h4>
                                <p class="text-xs text-gray-400 mt-1">üîí Perlu 2 misi</p>
                            </div>
                            <div class="bg-blue-800/30 p-2 md:p-3 rounded-lg text-center tutorial-pulse border border-blue-400/30 opacity-60">
                                <div class="text-lg md:text-2xl mb-1 md:mb-2">üìö</div>
                                <h4 class="font-semibold text-blue-300 text-xs md:text-sm">Ruang Kelas</h4>
                                <p class="text-xs text-gray-400 mt-1">üîí Perlu 4 misi</p>
                            </div>
                            <div class="bg-yellow-800/30 p-2 md:p-3 rounded-lg text-center tutorial-pulse border border-yellow-400/30 opacity-60">
                                <div class="text-lg md:text-2xl mb-1 md:mb-2">üßÆ</div>
                                <h4 class="font-semibold text-yellow-300 text-xs md:text-sm">Math Tutor</h4>
                                <p class="text-xs text-gray-400 mt-1">üîí Perlu 20 poin</p>
                            </div>
                        </div>
                        
                        <div class="bg-green-900/30 p-2 md:p-3 rounded-lg border border-green-400/20">
                            <p class="text-green-300 text-xs md:text-sm">
                                üí° <strong>Tips:</strong> Mulai dari Sekolah untuk membuka lokasi lain!
                            </p>
                        </div>
                    </div>
                `
            },
            {
                title: "üéØ Cara Memilih Tindakan",
                animation: "tutorial-slide-right",
                content: `
                    <div class="tutorial-slide-right">
                        <div class="bg-gradient-to-r from-orange-900/40 to-red-900/40 p-3 md:p-4 rounded-xl border border-orange-400/30 mb-3 md:mb-4">
                            <h4 class="font-bold text-cyan-300 mb-2 md:mb-3 text-sm md:text-base">‚ö° Langkah 2: Pilih Tindakan Terbaik</h4>
                        </div>
                        
                        <div class="bg-purple-900/30 p-3 md:p-4 rounded-xl border border-purple-400/20 mb-3 md:mb-4 tutorial-glow">
                            <h4 class="font-bold text-yellow-300 mb-2 text-sm md:text-base">üìñ Contoh Cerita:</h4>
                            <div class="text-center mb-2 md:mb-3">
                                <span class="text-2xl md:text-4xl tutorial-bounce">üò∞</span>
                            </div>
                            <p class="text-gray-200 mb-2 md:mb-3 bg-gray-800/30 p-2 rounded text-xs md:text-sm">
                                "Teman sedang diganggu. Mereka mengejek dan merebut tasnya..."
                            </p>
                            
                            <div class="space-y-1 md:space-y-2">
                                <div class="bg-green-800/30 p-2 rounded text-xs md:text-sm border border-green-400/30">
                                    <span class="block md:inline">‚úÖ <strong>Pilihan Bagus:</strong> Langsung membantu</span>
                                    <span class="text-green-300 block md:inline md:ml-2">(+15 poin)</span>
                                </div>
                                <div class="bg-blue-800/30 p-2 rounded text-xs md:text-sm border border-blue-400/30">
                                    <span class="block md:inline">‚úÖ <strong>Pilihan Baik:</strong> Melapor ke guru</span>
                                    <span class="text-blue-300 block md:inline md:ml-2">(+10 poin)</span>
                                </div>
                                <div class="bg-red-800/30 p-2 rounded text-xs md:text-sm border border-red-400/30">
                                    <span class="block md:inline">‚ùå <strong>Pilihan Buruk:</strong> Pura-pura tidak melihat</span>
                                    <span class="text-red-300 block md:inline md:ml-2">(-5 poin)</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-cyan-900/30 p-2 md:p-3 rounded-lg border border-cyan-400/20">
                            <p class="text-cyan-300 text-xs md:text-sm">
                                üåü <strong>Ingat:</strong> Pilihan baik = poin positif = Hero sejati!
                            </p>
                        </div>
                    </div>
                `
            },
            {
                title: "üßÆ Cara Bermain Math Tutor",
                animation: "tutorial-pulse",
                content: `
                    <div class="tutorial-pulse">
                        <div class="bg-gradient-to-r from-yellow-900/40 to-orange-900/40 p-3 md:p-4 rounded-xl border border-yellow-400/30 mb-3 md:mb-4">
                            <h4 class="font-bold text-cyan-300 mb-2 md:mb-3 text-sm md:text-base">üß† Langkah 3: Latihan Matematika</h4>
                            <p class="text-gray-200 text-xs md:text-sm">Selain jadi Hero Kebaikan, kamu juga bisa melatih kemampuan matematika!</p>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-2 md:gap-3 mb-3 md:mb-4">
                            <div class="bg-blue-800/30 p-2 md:p-3 rounded text-center tutorial-glow border border-blue-400/30">
                                <div class="text-lg md:text-xl mb-1">üî¢</div>
                                <div class="text-xs md:text-sm font-semibold text-blue-300">Dasar</div>
                                <p class="text-xs text-gray-400 mt-1 hidden md:block">Penjumlahan, pengurangan</p>
                            </div>
                            <div class="bg-purple-800/30 p-2 md:p-3 rounded text-center tutorial-glow border border-purple-400/30">
                                <div class="text-lg md:text-xl mb-1">üìê</div>
                                <div class="text-xs md:text-sm font-semibold text-purple-300">Aljabar</div>
                                <p class="text-xs text-gray-400 mt-1 hidden md:block">Persamaan, variabel</p>
                            </div>
                            <div class="bg-green-800/30 p-2 md:p-3 rounded text-center tutorial-glow border border-green-400/30">
                                <div class="text-lg md:text-xl mb-1">üìè</div>
                                <div class="text-xs md:text-sm font-semibold text-green-300">Geometri</div>
                                <p class="text-xs text-gray-400 mt-1 hidden md:block">Luas, keliling, volume</p>
                            </div>
                            <div class="bg-red-800/30 p-2 md:p-3 rounded text-center tutorial-glow border border-red-400/30">
                                <div class="text-lg md:text-xl mb-1">üß†</div>
                                <div class="text-xs md:text-sm font-semibold text-red-300">Lanjutan</div>
                                <p class="text-xs text-gray-400 mt-1 hidden md:block">Fungsi, logaritma</p>
                            </div>
                        </div>
                        
                        <div class="bg-indigo-900/30 p-2 md:p-3 rounded-lg border border-indigo-400/20 mb-2 md:mb-3">
                            <p class="text-indigo-300 text-xs md:text-sm">
                                üìù <strong>Cara bermain:</strong> Pilih kategori ‚Üí Jawab soal ‚Üí Dapatkan poin!
                            </p>
                        </div>
                        
                        <div class="bg-yellow-900/30 p-2 md:p-3 rounded-lg border border-yellow-400/20">
                            <p class="text-yellow-300 text-xs md:text-sm">
                                ‚≠ê <strong>Bonus:</strong> Jawaban benar meningkatkan Level Kepintaran!
                            </p>
                        </div>
                    </div>
                `
            },
            {
                title: "üèÜ Sistem Poin & Tips Bermain",
                animation: "tutorial-glow",
                content: `
                    <div class="tutorial-glow">
                        <div class="bg-gradient-to-r from-green-900/40 to-emerald-900/40 p-3 md:p-4 rounded-xl border border-green-400/30 mb-3 md:mb-4">
                            <h4 class="font-bold text-cyan-300 mb-2 md:mb-3 text-sm md:text-base">üéØ Langkah 4: Kumpulkan Poin & Naik Level</h4>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2 md:gap-4 mb-3 md:mb-4">
                            <div class="bg-green-900/30 p-2 md:p-3 rounded-lg border border-green-400/20 tutorial-pulse">
                                <h4 class="font-semibold text-green-300 mb-1 md:mb-2 text-xs md:text-sm">üåü Poin Kebaikan</h4>
                                <p class="text-xs md:text-sm text-gray-300 mb-1 md:mb-2">Dari pilihan baik dalam cerita</p>
                                <div class="text-xs bg-green-800/30 p-1 md:p-2 rounded">
                                    Contoh: Membantu teman = +15 poin
                                </div>
                            </div>
                            <div class="bg-blue-900/30 p-2 md:p-3 rounded-lg border border-blue-400/20 tutorial-pulse">
                                <h4 class="font-semibold text-blue-300 mb-1 md:mb-2 text-xs md:text-sm">üßÆ Poin Matematika</h4>
                                <p class="text-xs md:text-sm text-gray-300 mb-1 md:mb-2">Dari jawaban benar di Math Tutor</p>
                                <div class="text-xs bg-blue-800/30 p-1 md:p-2 rounded">
                                    Contoh: Soal benar = +5-20 poin
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-purple-900/30 p-3 md:p-4 rounded-lg border border-purple-400/20 mb-3 md:mb-4">
                            <h4 class="font-bold text-purple-300 mb-2 md:mb-3 text-sm md:text-base">üéÆ Tips Bermain:</h4>
                            <div class="space-y-1 md:space-y-2 text-xs md:text-sm">
                                <div class="flex items-start gap-2">
                                    <span class="text-green-400 text-sm">‚úÖ</span>
                                    <span class="text-gray-200">Selalu pilih tindakan yang membantu orang lain</span>
                                </div>
                                <div class="flex items-start gap-2">
                                    <span class="text-blue-400 text-sm">üöÄ</span>
                                    <span class="text-gray-200">Gunakan "Lanjut Cerita Lain" untuk main terus</span>
                                </div>
                                <div class="flex items-start gap-2">
                                    <span class="text-yellow-400 text-sm">üßÆ</span>
                                    <span class="text-gray-200">Latihan matematika untuk jadi Hero pintar</span>
                                </div>
                                <div class="flex items-start gap-2">
                                    <span class="text-purple-400 text-sm">üíæ</span>
                                    <span class="text-gray-200">Game otomatis tersimpan, progress aman</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="text-center p-3 md:p-4 bg-gradient-to-r from-cyan-900/30 to-blue-900/30 rounded-lg border border-cyan-400/20 tutorial-bounce">
                            <div class="text-3xl md:text-4xl mb-2">üåü</div>
                            <p class="text-cyan-300 font-bold text-base md:text-lg mb-2">Siap Jadi Hero Kebaikan?</p>
                            <p class="text-gray-200 text-xs md:text-sm">Klik "Mulai Bermain" dan mulai petualangan melawan bullying!</p>
                        </div>
                    </div>
                `
            }
        ];

        let currentTutorialStep = 0;

        // Initialize stars animation
        function createStars() {
            const starsContainer = document.getElementById('stars');
            const numStars = 100;
            
            for (let i = 0; i < numStars; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.width = Math.random() * 3 + 1 + 'px';
                star.style.height = star.style.width;
                star.style.animationDelay = Math.random() * 3 + 's';
                starsContainer.appendChild(star);
            }
        }

        // Scenarios data with missions
        const scenarios = {
            school: [
                {
                    title: "Situasi di Koridor Sekolah",
                    description: "Kamu melihat seorang teman sedang diganggu oleh sekelompok siswa. Mereka mengejek penampilannya dan merebut tasnya.",
                    character: "üò∞",
                    mission: {
                        title: "üõ°Ô∏è Pelindung Koridor",
                        description: "Lindungi teman dari bullying di koridor sekolah",
                        reward: "15 poin kebaikan + Badge Pelindung"
                    },
                    choices: [
                        { text: "Langsung membantu dan membela teman", points: 15, type: "kindness", isCorrect: true },
                        { text: "Melapor ke guru terdekat", points: 10, type: "kindness", isCorrect: true },
                        { text: "Mengajak teman lain untuk membantu", points: 12, type: "kindness", isCorrect: true },
                        { text: "Pura-pura tidak melihat", points: -5, type: "kindness", isCorrect: false }
                    ]
                },
                {
                    title: "Bullying di Kantin",
                    description: "Seorang siswa baru sedang makan sendirian, lalu sekelompok siswa datang dan mengejek makanannya sambil tertawa keras.",
                    character: "üòû",
                    mission: {
                        title: "ü§ù Teman Sejati",
                        description: "Bantu siswa baru merasa diterima di kantin",
                        reward: "18 poin kebaikan + Badge Persahabatan"
                    },
                    choices: [
                        { text: "Mengajak siswa baru untuk bergabung di mejamu", points: 18, type: "kindness", isCorrect: true },
                        { text: "Menegur kelompok yang mengejek", points: 15, type: "kindness", isCorrect: true },
                        { text: "Melapor ke guru piket", points: 12, type: "kindness", isCorrect: true },
                        { text: "Ikut tertawa agar tidak dijauhi", points: -8, type: "kindness", isCorrect: false }
                    ]
                },
                {
                    title: "Diskriminasi di Kelas",
                    description: "Guru meminta membuat kelompok, tapi tidak ada yang mau satu kelompok dengan siswa yang pendiam dan kurang percaya diri.",
                    character: "üòî",
                    mission: {
                        title: "üåü Inklusi Champion",
                        description: "Pastikan semua siswa mendapat kesempatan yang sama",
                        reward: "20 poin kebaikan + Badge Inklusi"
                    },
                    choices: [
                        { text: "Mengajak siswa tersebut bergabung di kelompokmu", points: 20, type: "kindness", isCorrect: true },
                        { text: "Membujuk teman lain untuk menerimanya", points: 16, type: "kindness", isCorrect: true },
                        { text: "Memberitahu guru tentang situasi ini", points: 14, type: "kindness", isCorrect: true },
                        { text: "Membiarkan saja karena bukan urusanmu", points: -6, type: "kindness", isCorrect: false }
                    ]
                },
                {
                    title: "Cyberbullying di Grup Chat",
                    description: "Di grup chat kelas, beberapa siswa mengirim meme yang mengejek salah satu teman sekelas. Semua orang tertawa kecuali korbannya.",
                    character: "üì±üò¢",
                    mission: {
                        title: "üõ°Ô∏è Digital Defender",
                        description: "Hentikan cyberbullying di grup chat kelas",
                        reward: "17 poin kebaikan + Badge Digital Hero"
                    },
                    choices: [
                        { text: "Membela korban di grup chat", points: 17, type: "kindness", isCorrect: true },
                        { text: "Mengirim pesan pribadi untuk menenangkan korban", points: 15, type: "kindness", isCorrect: true },
                        { text: "Melaporkan ke wali kelas", points: 13, type: "kindness", isCorrect: true },
                        { text: "Diam saja agar tidak jadi target selanjutnya", points: -7, type: "kindness", isCorrect: false }
                    ]
                },
                {
                    title: "Intimidasi di Toilet Sekolah",
                    description: "Kamu mendengar suara pertengkaran di toilet. Ternyata siswa kelas atas sedang mengintimidasi adik kelas dan meminta uang jajan.",
                    character: "üò®",
                    mission: {
                        title: "‚öîÔ∏è Pemberani Sejati",
                        description: "Hentikan intimidasi dan lindungi adik kelas",
                        reward: "22 poin kebaikan + Badge Keberanian"
                    },
                    choices: [
                        { text: "Langsung masuk dan menghentikan intimidasi", points: 22, type: "kindness", isCorrect: true },
                        { text: "Mencari guru atau satpam terdekat", points: 18, type: "kindness", isCorrect: true },
                        { text: "Berteriak untuk menarik perhatian orang lain", points: 16, type: "kindness", isCorrect: true },
                        { text: "Pergi dari sana karena takut", points: -10, type: "kindness", isCorrect: false }
                    ]
                }
            ],
            park: [
                {
                    title: "Kejadian di Taman",
                    description: "Seorang anak kecil menangis karena mainannya diambil oleh anak yang lebih besar. Orang tuanya tidak ada di sekitar.",
                    character: "üò¢",
                    mission: {
                        title: "üß∏ Pelindung Anak",
                        description: "Bantu anak kecil mendapatkan kembali mainannya",
                        reward: "15 poin kebaikan + Badge Pelindung"
                    },
                    choices: [
                        { text: "Mendekati dan menenangkan anak tersebut", points: 12, type: "kindness", isCorrect: true },
                        { text: "Mencari orang tua anak tersebut", points: 10, type: "kindness", isCorrect: true },
                        { text: "Menegur anak yang mengambil mainan", points: 15, type: "kindness", isCorrect: true },
                        { text: "Tidak ikut campur", points: -3, type: "kindness", isCorrect: false }
                    ]
                },
                {
                    title: "Diskriminasi di Area Bermain",
                    description: "Sekelompok anak menolak bermain dengan anak berkebutuhan khusus yang ingin bergabung. Mereka bilang 'dia berbeda, jangan main sama dia'.",
                    character: "‚ôøüòî",
                    mission: {
                        title: "üåà Inklusi Hero",
                        description: "Ciptakan lingkungan bermain yang inklusif untuk semua",
                        reward: "25 poin kebaikan + Badge Inklusi Master"
                    },
                    choices: [
                        { text: "Mengajak anak berkebutuhan khusus bermain bersamamu", points: 25, type: "kindness", isCorrect: true },
                        { text: "Menjelaskan pada anak-anak bahwa semua berhak bermain", points: 20, type: "kindness", isCorrect: true },
                        { text: "Mencari permainan yang bisa dimainkan semua anak", points: 18, type: "kindness", isCorrect: true },
                        { text: "Ikut menjauh karena merasa canggung", points: -12, type: "kindness", isCorrect: false }
                    ]
                },
                {
                    title: "Perundungan Fisik di Taman",
                    description: "Kamu melihat anak yang lebih besar mendorong dan mengejek anak yang lebih kecil hingga terjatuh dan menangis.",
                    character: "üò≠",
                    mission: {
                        title: "ü•ä Stop Kekerasan",
                        description: "Hentikan perundungan fisik dan lindungi korban",
                        reward: "20 poin kebaikan + Badge Anti-Kekerasan"
                    },
                    choices: [
                        { text: "Langsung membantu anak yang terjatuh dan menegur pelaku", points: 20, type: "kindness", isCorrect: true },
                        { text: "Memanggil orang dewasa terdekat", points: 16, type: "kindness", isCorrect: true },
                        { text: "Mengalihkan perhatian pelaku dengan cara lain", points: 14, type: "kindness", isCorrect: true },
                        { text: "Takut ikut campur karena pelakunya lebih besar", points: -8, type: "kindness", isCorrect: false }
                    ]
                },
                {
                    title: "Ejekan Penampilan di Taman",
                    description: "Sekelompok remaja mengejek penampilan seorang anak yang berpakaian sederhana dan sepatu lusuh. Anak itu terlihat malu dan ingin pergi.",
                    character: "üëïüòû",
                    mission: {
                        title: "üíé Inner Beauty",
                        description: "Tunjukkan bahwa penampilan tidak menentukan nilai seseorang",
                        reward: "19 poin kebaikan + Badge Beauty Within"
                    },
                    choices: [
                        { text: "Mendekati anak tersebut dan mengajaknya bermain", points: 19, type: "kindness", isCorrect: true },
                        { text: "Menegur kelompok yang mengejek", points: 17, type: "kindness", isCorrect: true },
                        { text: "Memberikan dukungan moral pada anak tersebut", points: 15, type: "kindness", isCorrect: true },
                        { text: "Pura-pura tidak melihat kejadian tersebut", points: -6, type: "kindness", isCorrect: false }
                    ]
                },
                {
                    title: "Isolasi Sosial di Taman",
                    description: "Seorang anak selalu bermain sendirian di sudut taman. Anak-anak lain sengaja menghindarinya karena menganggapnya 'aneh'.",
                    character: "üß∏üòî",
                    mission: {
                        title: "ü§ó Friendship Builder",
                        description: "Bangun jembatan persahabatan untuk anak yang terisolasi",
                        reward: "21 poin kebaikan + Badge Friendship"
                    },
                    choices: [
                        { text: "Mendekati dan mengajak bermain bersama", points: 21, type: "kindness", isCorrect: true },
                        { text: "Mengajak teman-teman untuk menerima anak tersebut", points: 18, type: "kindness", isCorrect: true },
                        { text: "Memberikan mainan atau berbagi cemilan", points: 16, type: "kindness", isCorrect: true },
                        { text: "Ikut menghindari karena takut dianggap aneh juga", points: -9, type: "kindness", isCorrect: false }
                    ]
                }
            ],
            classroom: [
                {
                    title: "Situasi di Kelas",
                    description: "Teman sebangkumu kesulitan memahami pelajaran dan terlihat frustasi. Guru sedang sibuk membantu siswa lain.",
                    character: "üòî",
                    mission: {
                        title: "üéì Tutor Baik Hati",
                        description: "Bantu teman yang kesulitan belajar",
                        reward: "15 poin kebaikan + Badge Mentor"
                    },
                    choices: [
                        { text: "Menawarkan bantuan menjelaskan materi", points: 15, type: "kindness", isCorrect: true },
                        { text: "Meminjamkan catatan yang lengkap", points: 10, type: "kindness", isCorrect: true },
                        { text: "Mengajak belajar bersama setelah sekolah", points: 12, type: "kindness", isCorrect: true },
                        { text: "Fokus pada tugas sendiri", points: -2, type: "kindness", isCorrect: false }
                    ]
                },
                {
                    title: "Pengucilan dalam Diskusi Kelas",
                    description: "Saat diskusi kelompok, ada siswa yang pendapatnya selalu diabaikan dan tidak pernah didengarkan oleh anggota lain.",
                    character: "üôã‚Äç‚ôÇÔ∏èüòû",
                    mission: {
                        title: "üó£Ô∏è Voice Amplifier",
                        description: "Pastikan setiap suara didengar dalam diskusi",
                        reward: "18 poin kebaikan + Badge Democracy"
                    },
                    choices: [
                        { text: "Meminta semua mendengarkan pendapatnya", points: 18, type: "kindness", isCorrect: true },
                        { text: "Mendukung dan mengembangkan idenya", points: 16, type: "kindness", isCorrect: true },
                        { text: "Mengajak bicara empat mata setelah diskusi", points: 14, type: "kindness", isCorrect: true },
                        { text: "Ikut mengabaikan karena pendapatnya memang kurang bagus", points: -7, type: "kindness", isCorrect: false }
                    ]
                },
                {
                    title: "Body Shaming di Kelas Olahraga",
                    description: "Saat pelajaran olahraga, beberapa siswa mengejek temannya yang gemuk dan tidak bisa berlari cepat. Korban terlihat sangat malu.",
                    character: "üèÉ‚Äç‚ôÇÔ∏èüò¢",
                    mission: {
                        title: "üí™ Body Positive Hero",
                        description: "Hentikan body shaming dan dukung body positivity",
                        reward: "20 poin kebaikan + Badge Body Positive"
                    },
                    choices: [
                        { text: "Membela korban dan menegur yang mengejek", points: 20, type: "kindness", isCorrect: true },
                        { text: "Memberikan semangat dan dukungan pada korban", points: 17, type: "kindness", isCorrect: true },
                        { text: "Mengajak korban untuk berolahraga bersama", points: 15, type: "kindness", isCorrect: true },
                        { text: "Diam saja karena takut jadi target ejekan", points: -8, type: "kindness", isCorrect: false }
                    ]
                },
                {
                    title: "Diskriminasi Ekonomi di Kelas",
                    description: "Saat ada acara kelas yang perlu iuran, beberapa siswa mengejek temannya yang tidak bisa bayar karena kondisi ekonomi keluarga.",
                    character: "üí∞üòî",
                    mission: {
                        title: "ü§ù Equality Fighter",
                        description: "Lawan diskriminasi ekonomi dan bantu yang membutuhkan",
                        reward: "22 poin kebaikan + Badge Equality"
                    },
                    choices: [
                        { text: "Menawarkan untuk membantu membayar iurannya", points: 22, type: "kindness", isCorrect: true },
                        { text: "Mengusulkan agar iuran dikurangi atau dibuat sukarela", points: 19, type: "kindness", isCorrect: true },
                        { text: "Menegur yang mengejek dan menjelaskan situasinya", points: 17, type: "kindness", isCorrect: true },
                        { text: "Ikut menjauh karena tidak mau terlibat masalah", points: -10, type: "kindness", isCorrect: false }
                    ]
                },
                {
                    title: "Bullying Akademik",
                    description: "Siswa pintar di kelas sering meremehkan dan mengejek siswa yang nilainya rendah, membuatnya semakin tidak percaya diri belajar.",
                    character: "üìöüòû",
                    mission: {
                        title: "üß† Smart & Kind",
                        description: "Tunjukkan bahwa kepintaran sejati adalah membantu orang lain",
                        reward: "20 poin kebaikan + Badge Wise Helper"
                    },
                    choices: [
                        { text: "Menawarkan bantuan belajar pada korban", points: 18, type: "kindness", isCorrect: true },
                        { text: "Menegur siswa pintar yang sombong", points: 16, type: "kindness", isCorrect: true },
                        { text: "Mengajak korban bergabung dalam kelompok belajar", points: 20, type: "kindness", isCorrect: true },
                        { text: "Tidak peduli karena bukan masalahmu", points: -6, type: "kindness", isCorrect: false }
                    ]
                },
                {
                    title: "Rasisme di Kelas",
                    description: "Ada siswa yang sering mengejek temannya karena perbedaan suku, agama, atau warna kulit dengan komentar yang menyakitkan.",
                    character: "üåçüò¢",
                    mission: {
                        title: "üåà Unity Champion",
                        description: "Lawan rasisme dan promosikan keberagaman",
                        reward: "25 poin kebaikan + Badge Unity"
                    },
                    choices: [
                        { text: "Tegas menentang rasisme dan membela korban", points: 25, type: "kindness", isCorrect: true },
                        { text: "Melaporkan ke guru dan wali kelas", points: 20, type: "kindness", isCorrect: true },
                        { text: "Memberikan dukungan moral pada korban", points: 18, type: "kindness", isCorrect: true },
                        { text: "Takut ikut campur karena isu sensitif", points: -12, type: "kindness", isCorrect: false }
                    ]
                }
            ]
        };

        // Enhanced math questions with level scaling
        const mathQuestions = {
            dasar: [
                // Level 1-3 (Easy)
                {
                    question: "Berapakah hasil dari 15 + 28 - 12?",
                    options: ["31", "29", "33", "27"],
                    correct: 0,
                    points: 5,
                    level: 1
                },
                {
                    question: "Hasil dari 8 √ó 7 = ?",
                    options: ["54", "56", "58", "52"],
                    correct: 1,
                    points: 5,
                    level: 1
                },
                // Level 4-6 (Medium)
                {
                    question: "Jika 144 √∑ 12 √ó 3, maka hasilnya adalah?",
                    options: ["36", "4", "48", "12"],
                    correct: 0,
                    points: 8,
                    level: 4
                },
                {
                    question: "Berapakah 25% dari 80?",
                    options: ["15", "25", "20", "30"],
                    correct: 2,
                    points: 8,
                    level: 4
                },
                // Level 7+ (Hard)
                {
                    question: "Hasil dari (-8) + 15 - 3 √ó 2 = ?",
                    options: ["1", "10", "6", "-4"],
                    correct: 0,
                    points: 12,
                    level: 7
                },
                {
                    question: "Jika 3x = 21, maka x = ?",
                    options: ["6", "7", "8", "9"],
                    correct: 1,
                    points: 5
                },
                {
                    question: "Hasil dari 144 √∑ 12 √ó 3 = ?",
                    options: ["36", "4", "48", "12"],
                    correct: 0,
                    points: 5
                },
                {
                    question: "Berapakah 25% dari 80?",
                    options: ["15", "25", "20", "30"],
                    correct: 2,
                    points: 6
                },
                {
                    question: "Jika 5y - 10 = 15, maka y = ?",
                    options: ["3", "5", "7", "4"],
                    correct: 1,
                    points: 6
                },
                {
                    question: "Hasil dari (-8) + 15 - 3 = ?",
                    options: ["4", "10", "6", "-4"],
                    correct: 0,
                    points: 5
                },
                {
                    question: "Berapakah 2¬≥ √ó 3¬≤ = ?",
                    options: ["72", "54", "36", "18"],
                    correct: 0,
                    points: 7
                },
                {
                    question: "Jika a = 4 dan b = 3, maka a¬≤ + b¬≤ = ?",
                    options: ["25", "49", "16", "12"],
                    correct: 0,
                    points: 6
                }
            ],
            aljabar: [
                {
                    question: "Sederhanakan: 2x + 3x - x",
                    options: ["4x", "5x", "6x", "3x"],
                    correct: 0,
                    points: 8
                },
                {
                    question: "Jika 2x + 5 = 17, maka x = ?",
                    options: ["5", "6", "7", "8"],
                    correct: 1,
                    points: 8
                },
                {
                    question: "Sederhanakan: 3(x + 4) - 2x",
                    options: ["x + 12", "5x + 12", "x + 4", "3x + 2"],
                    correct: 0,
                    points: 9
                },
                {
                    question: "Jika 4x - 7 = 2x + 9, maka x = ?",
                    options: ["8", "2", "4", "6"],
                    correct: 0,
                    points: 10
                },
                {
                    question: "Faktorkan: x¬≤ - 9",
                    options: ["(x-3)(x+3)", "(x-9)(x+1)", "(x-1)(x+9)", "(x-3)¬≤"],
                    correct: 0,
                    points: 12
                },
                {
                    question: "Jika x¬≤ - 5x + 6 = 0, maka nilai x adalah?",
                    options: ["x = 2 atau x = 3", "x = 1 atau x = 6", "x = -2 atau x = -3", "x = 0 atau x = 5"],
                    correct: 0,
                    points: 15
                },
                {
                    question: "Sederhanakan: (2x + 3)(x - 1)",
                    options: ["2x¬≤ + x - 3", "2x¬≤ - 2x + 3", "2x¬≤ + 5x - 3", "2x¬≤ - x + 3"],
                    correct: 0,
                    points: 12
                },
                {
                    question: "Jika y = 2x + 3 dan x = 4, maka y = ?",
                    options: ["11", "9", "7", "5"],
                    correct: 0,
                    points: 8
                }
            ],
            geometri: [
                {
                    question: "Luas persegi dengan sisi 8 cm adalah?",
                    options: ["64 cm¬≤", "32 cm¬≤", "16 cm¬≤", "48 cm¬≤"],
                    correct: 0,
                    points: 10
                },
                {
                    question: "Keliling lingkaran dengan jari-jari 7 cm adalah? (œÄ = 22/7)",
                    options: ["44 cm", "154 cm", "22 cm", "88 cm"],
                    correct: 0,
                    points: 12
                },
                {
                    question: "Luas segitiga dengan alas 12 cm dan tinggi 8 cm adalah?",
                    options: ["48 cm¬≤", "96 cm¬≤", "24 cm¬≤", "20 cm¬≤"],
                    correct: 0,
                    points: 10
                },
                {
                    question: "Volume kubus dengan sisi 5 cm adalah?",
                    options: ["125 cm¬≥", "25 cm¬≥", "75 cm¬≥", "100 cm¬≥"],
                    correct: 0,
                    points: 12
                },
                {
                    question: "Luas trapesium dengan sisi sejajar 8 cm dan 12 cm, tinggi 6 cm adalah?",
                    options: ["60 cm¬≤", "48 cm¬≤", "72 cm¬≤", "96 cm¬≤"],
                    correct: 0,
                    points: 14
                },
                {
                    question: "Jika sudut dalam segitiga adalah 60¬∞, 70¬∞, maka sudut ketiga adalah?",
                    options: ["50¬∞", "40¬∞", "30¬∞", "80¬∞"],
                    correct: 0,
                    points: 10
                },
                {
                    question: "Luas permukaan balok dengan p=6, l=4, t=3 adalah?",
                    options: ["108 cm¬≤", "72 cm¬≤", "144 cm¬≤", "96 cm¬≤"],
                    correct: 0,
                    points: 15
                },
                {
                    question: "Panjang diagonal persegi dengan sisi 6 cm adalah?",
                    options: ["6‚àö2 cm", "12 cm", "6‚àö3 cm", "9 cm"],
                    correct: 0,
                    points: 13
                }
            ],
            lanjutan: [
                {
                    question: "Jika f(x) = 2x¬≤ + 3x - 1, maka f(2) = ?",
                    options: ["13", "11", "15", "9"],
                    correct: 0,
                    points: 15
                },
                {
                    question: "Hasil dari ‚àõ64 + ‚àõ27 = ?",
                    options: ["7", "9", "5", "11"],
                    correct: 0,
                    points: 12
                },
                {
                    question: "Jika log‚ÇÇ 8 = x, maka x = ?",
                    options: ["3", "4", "2", "8"],
                    correct: 0,
                    points: 18
                },
                {
                    question: "Suku ke-5 dari barisan aritmatika 3, 7, 11, 15, ... adalah?",
                    options: ["19", "23", "21", "17"],
                    correct: 0,
                    points: 14
                },
                {
                    question: "Jika sin 30¬∞ = 1/2, maka cos 60¬∞ = ?",
                    options: ["1/2", "‚àö3/2", "‚àö2/2", "1"],
                    correct: 0,
                    points: 16
                },
                {
                    question: "Hasil dari (3‚Å¥ √ó 3¬≤) √∑ 3¬≥ = ?",
                    options: ["27", "9", "81", "3"],
                    correct: 0,
                    points: 15
                },
                {
                    question: "Jika matriks A = [2 3; 1 4], maka determinan A = ?",
                    options: ["5", "7", "8", "11"],
                    correct: 0,
                    points: 20
                },
                {
                    question: "Turunan dari f(x) = 3x¬≤ + 2x - 1 adalah?",
                    options: ["6x + 2", "3x + 2", "6x - 1", "3x¬≤ + 2"],
                    correct: 0,
                    points: 18
                }
            ]
        };

        // Mini Game data
        const miniGameWords = [
            {
                phrase: "BE KIND",
                hint: "Jadilah baik hati",
                category: "Kebaikan",
                reward: { points: 10, item: 'golden_heart' }
            },
            {
                phrase: "STOP BULLY",
                hint: "Hentikan perundungan!",
                category: "Anti-Bullying",
                reward: { points: 12, item: 'courage_medal' }
            },
            {
                phrase: "RESPECT",
                hint: "Hormati sesama",
                category: "Respect",
                reward: { points: 8, item: 'silver_shield' }
            },
            {
                phrase: "UNITY",
                hint: "Persatuan untuk semua",
                category: "Persatuan",
                reward: { points: 8, item: 'rainbow_gem' }
            },
            {
                phrase: "LOVE ALL",
                hint: "Cintai semua orang",
                category: "Cinta",
                reward: { points: 10, item: 'friendship_ring' }
            },
            {
                phrase: "BE BRAVE",
                hint: "Jadilah pemberani",
                category: "Keberanian",
                reward: { points: 10, item: 'wisdom_owl' }
            },
            {
                phrase: "STAND UP",
                hint: "Berdiri untuk kebenaran",
                category: "Keberanian",
                reward: { points: 10, item: 'unity_torch' }
            },
            {
                phrase: "PEACE",
                hint: "Kedamaian untuk semua",
                category: "Damai",
                reward: { points: 8, item: 'peace_dove' }
            },
            {
                phrase: "HELP",
                hint: "Bantu yang membutuhkan",
                category: "Bantuan",
                reward: { points: 6, item: 'golden_heart' }
            },
            {
                phrase: "CARE",
                hint: "Peduli pada sesama",
                category: "Kepedulian",
                reward: { points: 6, item: 'friendship_ring' }
            }
        ];

        let currentMiniGame = null;
        let miniGameProgress = [];
        let selectedLetters = [];

        // Sidebar functions
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            const toggleIcon = document.getElementById('sidebarToggleIcon');
            
            gameState.isSidebarOpen = !gameState.isSidebarOpen;
            
            if (gameState.isSidebarOpen) {
                sidebar.classList.add('sidebar-open');
                overlay.classList.add('sidebar-overlay-show');
                toggleIcon.textContent = '‚úï';
                updateSidebarContent();
            } else {
                sidebar.classList.remove('sidebar-open');
                overlay.classList.remove('sidebar-overlay-show');
                toggleIcon.textContent = '‚ò∞';
            }
            
            saveGameState();
        }

        // Close sidebar when clicking overlay
        document.addEventListener('DOMContentLoaded', () => {
            const overlay = document.getElementById('sidebarOverlay');
            const toggleButton = document.getElementById('sidebarToggle');
            
            overlay.addEventListener('click', () => {
                if (gameState.isSidebarOpen) {
                    toggleSidebar();
                }
            });
            
            toggleButton.addEventListener('click', toggleSidebar);
        });

        // Update sidebar content
        function updateSidebarContent() {
            // Update stats
            document.getElementById('sidebarLevel').textContent = gameState.playerLevel;
            document.getElementById('sidebarKindness').textContent = gameState.kindnessPoints;
            document.getElementById('sidebarSmart').textContent = gameState.smartLevel;
            document.getElementById('sidebarMath').textContent = gameState.mathPoints;
            
            // Update progress bars
            const levelProgress = Math.min((gameState.kindnessPoints % 100) / 100 * 100, 100);
            document.getElementById('sidebarLevelProgress').textContent = `${gameState.kindnessPoints % 100}/100`;
            document.getElementById('sidebarLevelBar').style.width = `${levelProgress}%`;
            
            const completedDailies = gameState.dailyMissions.filter(m => m.completed).length;
            const dailyProgress = (completedDailies / 3) * 100;
            document.getElementById('sidebarDailyProgress').textContent = `${completedDailies}/3`;
            document.getElementById('sidebarDailyBar').style.width = `${dailyProgress}%`;
            
            const achievementProgress = (gameState.achievements.length / achievementsData.length) * 100;
            document.getElementById('sidebarAchievements').textContent = `${gameState.achievements.length}/${achievementsData.length}`;
            document.getElementById('sidebarAchievementBar').style.width = `${achievementProgress}%`;
            
            // Update auto-save indicators
            const sidebarAutoSaveIndicator = document.getElementById('sidebarAutoSaveIndicator');
            const sidebarAutoSaveTimer = document.getElementById('sidebarAutoSaveTimer');
            const mainAutoSaveIndicator = document.getElementById('autoSaveIndicator');
            const mainAutoSaveTimer = document.getElementById('autoSaveTimer');
            
            if (sidebarAutoSaveIndicator && mainAutoSaveIndicator) {
                sidebarAutoSaveIndicator.textContent = mainAutoSaveIndicator.textContent;
                sidebarAutoSaveIndicator.className = mainAutoSaveIndicator.className;
            }
            if (sidebarAutoSaveTimer && mainAutoSaveTimer) {
                sidebarAutoSaveTimer.textContent = mainAutoSaveTimer.textContent;
                sidebarAutoSaveTimer.className = mainAutoSaveTimer.className;
            }
            
            // Update recent activity
            updateSidebarActivity();
            
            // Update quick action buttons based on unlocked features
            updateSidebarQuickActions();
        }

        // Update sidebar activity log
        function updateSidebarActivity() {
            const activityContainer = document.getElementById('sidebarActivity');
            if (!activityContainer) return;
            
            if (gameState.recentActivity.length === 0) {
                activityContainer.innerHTML = '<div class="text-xs text-gray-400 text-center">No recent activity</div>';
                return;
            }
            
            const recentItems = gameState.recentActivity.slice(-5).reverse();
            activityContainer.innerHTML = recentItems.map(activity => `
                <div class="text-xs text-gray-300 mb-1 p-1 bg-purple-800/20 rounded">
                    <span class="text-purple-300">${activity.time}</span>
                    <div class="text-gray-200">${activity.action}</div>
                </div>
            `).join('');
        }

        // Add activity to log
        function addActivity(action) {
            const now = new Date();
            const timeString = now.toLocaleTimeString('id-ID', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            gameState.recentActivity.push({
                time: timeString,
                action: action,
                timestamp: now.getTime()
            });
            
            // Keep only last 10 activities
            if (gameState.recentActivity.length > 10) {
                gameState.recentActivity = gameState.recentActivity.slice(-10);
            }
            
            // Update sidebar if open
            if (gameState.isSidebarOpen) {
                updateSidebarActivity();
            }
        }

        // Update sidebar quick actions based on unlocked features
        function updateSidebarQuickActions() {
            // This will be called when features are unlocked
            // The template literals in the HTML will be evaluated when the sidebar is created
        }

        // Quick action functions for sidebar
        function quickSelectLocation(location) {
            const unlocks = gameState.unlockedFeatures;
            
            if (location === 'park' && !unlocks.park) {
                showLockMessage(unlockRequirements.park.message);
                return;
            }
            if (location === 'classroom' && !unlocks.classroom) {
                showLockMessage(unlockRequirements.classroom.message);
                return;
            }
            
            addActivity(`üó∫Ô∏è Pindah ke ${getLocationName(location)}`);
            selectLocationWithAutoLock(location);
            toggleSidebar(); // Close sidebar after action
        }

        function quickShowMathMode() {
            if (!gameState.unlockedFeatures.mathTutor) {
                showLockMessage(unlockRequirements.mathTutor.message);
                return;
            }
            
            addActivity('üßÆ Membuka Math Tutor');
            showMathMode();
            toggleSidebar(); // Close sidebar after action
        }

        function quickShowStoryMode() {
            if (!gameState.unlockedFeatures.storyMode) {
                showLockMessage(unlockRequirements.storyMode.message);
                return;
            }
            
            addActivity('üìñ Membuka Story Mode');
            showStoryMode();
            toggleSidebar(); // Close sidebar after action
        }

        function quickShowMiniGame() {
            if (!gameState.unlockedFeatures.miniGame) {
                showLockMessage(unlockRequirements.miniGame.message);
                return;
            }
            
            addActivity('üéØ Membuka Mini Games');
            showMiniGame();
            toggleSidebar(); // Close sidebar after action
        }

        // Initialize game
        function initGame() {
            createStars();
            const isNewPlayer = loadGameState();
            initializeDailyMissions();
            checkUnlocks();
            updateLocationGrid();
            updateMobileLocationGrid();
            updateUI();
            updateDailyMissionsUI();
            startAutoSave();
            
            // Handle new player experience
            if (isNewPlayer) {
                handleNewPlayer();
            }
            
            // Restore panel lock state
            if (gameState.isPanelLocked) {
                isPanelLocked = true;
                const body = document.body;
                const lockButton = document.getElementById('panelLockButton');
                const mobileMapTrigger = document.getElementById('mobileMapTrigger');
                
                body.classList.add('panel-locked');
                lockButton.textContent = 'üîí';
                lockButton.title = 'Buka Kunci Panel';
                mobileMapTrigger.classList.add('hidden');
            }
            
            // Restore mobile map state
            if (gameState.isMobileMapOpen) {
                const popup = document.getElementById('mobileMapPopup');
                popup.classList.add('show');
            }
            
            // Restore sidebar state
            if (gameState.isSidebarOpen) {
                const sidebar = document.getElementById('sidebar');
                const overlay = document.getElementById('sidebarOverlay');
                const toggleIcon = document.getElementById('sidebarToggleIcon');
                
                sidebar.classList.add('sidebar-open');
                overlay.classList.add('sidebar-overlay-show');
                toggleIcon.textContent = '‚úï';
                updateSidebarContent();
            }
            
            // Initialize activity log
            if (!gameState.recentActivity) {
                gameState.recentActivity = [];
            }
            
            addActivity('üåü Game dimulai');
        }

        // Handle new player experience
        function handleNewPlayer() {
            // Welcome message for new players
            setTimeout(() => {
                showNotification(`üåü Selamat datang, Hero baru!\nGame akan otomatis tersimpan setiap 30 detik.\nMari mulai petualangan kebaikan!`);
            }, 1000);
            
            // Auto-start first mission after welcome
            setTimeout(() => {
                showNotification(`üè´ Mari mulai dari Sekolah!\nKamu akan otomatis masuk ke misi pertama...`);
                
                // Auto-select school and start first mission
                setTimeout(() => {
                    selectLocationWithAutoLock('school');
                }, 2000);
            }, 3000);
        }

        // Check what features should be unlocked
        function checkUnlocks() {
            const unlocks = gameState.unlockedFeatures;
            
            // Check Story Mode
            if (!unlocks.storyMode) {
                const req = unlockRequirements.storyMode;
                if (gameState.kindnessPoints >= req.kindnessPoints && gameState.playerLevel >= req.level) {
                    unlocks.storyMode = true;
                    addActivity('üîì Story Mode terbuka!');
                    showNotification(`üîì Story Mode Unlocked!\nSekarang kamu bisa main cerita interaktif!`);
                }
            }
            
            // Check Math Tutor
            if (!unlocks.mathTutor) {
                const req = unlockRequirements.mathTutor;
                if (gameState.kindnessPoints >= req.kindnessPoints && gameState.playerLevel >= req.level) {
                    unlocks.mathTutor = true;
                    addActivity('üîì Math Tutor terbuka!');
                    showNotification(`üîì Math Tutor Unlocked!\nLatih kemampuan matematikamu!`);
                }
            }
            
            // Check Mini Game
            if (!unlocks.miniGame) {
                const req = unlockRequirements.miniGame;
                if (gameState.kindnessPoints >= req.kindnessPoints && gameState.playerLevel >= req.level) {
                    unlocks.miniGame = true;
                    addActivity('üîì Mini Game terbuka!');
                    showNotification(`üîì Mini Game Unlocked!\nSusun kata-kata kebaikan!`);
                }
            }
            
            // Check Inventory
            if (!unlocks.inventory) {
                const req = unlockRequirements.inventory;
                if (gameState.kindnessPoints >= req.kindnessPoints) {
                    unlocks.inventory = true;
                    addActivity('üîì Inventory terbuka!');
                    showNotification(`üîì Inventory Unlocked!\nLihat koleksi badge dan itemmu!`);
                }
            }
            
            // Check Park
            if (!unlocks.park) {
                const req = unlockRequirements.park;
                if (gameState.completedMissions >= req.completedMissions) {
                    unlocks.park = true;
                    addActivity('üîì Taman terbuka!');
                    showNotification(`üîì Taman Unlocked!\nLokasi baru tersedia untuk dijelajahi!`);
                }
            }
            
            // Check Classroom
            if (!unlocks.classroom) {
                const req = unlockRequirements.classroom;
                if (gameState.completedMissions >= req.completedMissions) {
                    unlocks.classroom = true;
                    addActivity('üîì Ruang Kelas terbuka!');
                    showNotification(`üîì Ruang Kelas Unlocked!\nLokasi pembelajaran baru terbuka!`);
                }
            }
        }

        // Toggle mobile map popup
        function toggleMobileMap() {
            const popup = document.getElementById('mobileMapPopup');
            const trigger = document.getElementById('mobileMapTrigger');
            
            gameState.isMobileMapOpen = !gameState.isMobileMapOpen;
            
            if (gameState.isMobileMapOpen) {
                popup.classList.add('show');
                trigger.style.transform = 'scale(0.8)';
                updateMobileLocationGrid();
            } else {
                popup.classList.remove('show');
                trigger.style.transform = 'scale(1)';
            }
            
            saveGameState();
        }

        // Toggle panel lock
        function togglePanelLock() {
            const panel = document.getElementById('scenarioHeroPanel');
            const lockButton = document.getElementById('panelLockButton');
            const body = document.body;
            
            isPanelLocked = !isPanelLocked;
            gameState.isPanelLocked = isPanelLocked;
            
            if (isPanelLocked) {
                // Lock panel
                body.classList.add('panel-locked');
                lockButton.textContent = 'üîí';
                lockButton.title = 'Buka Kunci Panel';
                
                // Hide mobile map trigger when panel is locked
                const mobileMapTrigger = document.getElementById('mobileMapTrigger');
                mobileMapTrigger.classList.add('hidden');
                
                showNotification('üîí Panel terkunci!\nFokus pada soal/misi saat ini.');
            } else {
                // Unlock panel
                body.classList.remove('panel-locked');
                lockButton.textContent = 'üîì';
                lockButton.title = 'Kunci Panel';
                
                // Show mobile map trigger when panel is unlocked
                const mobileMapTrigger = document.getElementById('mobileMapTrigger');
                mobileMapTrigger.classList.remove('hidden');
                
                showNotification('üîì Panel dibuka!\nKamu bisa navigasi bebas lagi.');
            }
            
            saveGameState();
        }

        // Update mobile location grid
        function updateMobileLocationGrid() {
            const mobileLocationGrid = document.getElementById('mobileLocationGrid');
            const mobileMiniGameButton = document.getElementById('mobileMiniGameButton');
            const unlocks = gameState.unlockedFeatures;
            
            const locations = [
                {
                    id: 'school',
                    name: 'Sekolah',
                    icon: 'üè´',
                    colors: 'from-purple-800/50 to-indigo-900/50 hover:from-purple-700/60 hover:to-indigo-800/60',
                    borderColor: 'border-purple-400/30 hover:border-cyan-400/50',
                    unlocked: true,
                    action: "selectLocationMobile('school')"
                },
                {
                    id: 'park',
                    name: 'Taman',
                    icon: 'üå≥',
                    colors: 'from-green-800/50 to-emerald-900/50 hover:from-green-700/60 hover:to-emerald-800/60',
                    borderColor: 'border-green-400/30 hover:border-cyan-400/50',
                    unlocked: unlocks.park,
                    action: "selectLocationMobile('park')",
                    requirement: unlockRequirements.park.message
                },
                {
                    id: 'classroom',
                    name: 'Ruang Kelas',
                    icon: 'üìö',
                    colors: 'from-blue-800/50 to-cyan-900/50 hover:from-blue-700/60 hover:to-cyan-800/60',
                    borderColor: 'border-blue-400/30 hover:border-cyan-400/50',
                    unlocked: unlocks.classroom,
                    action: "selectLocationMobile('classroom')",
                    requirement: unlockRequirements.classroom.message
                },
                {
                    id: 'mathTutor',
                    name: 'Math Tutor',
                    icon: 'üßÆ',
                    colors: 'from-yellow-800/50 to-orange-900/50 hover:from-yellow-700/60 hover:to-orange-800/60',
                    borderColor: 'border-yellow-400/30 hover:border-cyan-400/50',
                    unlocked: unlocks.mathTutor,
                    action: "showMathModeMobile()",
                    requirement: unlockRequirements.mathTutor.message
                },
                {
                    id: 'storyMode',
                    name: 'Story Mode',
                    icon: 'üìñ',
                    colors: 'from-pink-800/50 to-rose-900/50 hover:from-pink-700/60 hover:to-rose-800/60',
                    borderColor: 'border-pink-400/30 hover:border-cyan-400/50',
                    unlocked: unlocks.storyMode,
                    action: "showStoryModeMobile()",
                    requirement: unlockRequirements.storyMode.message
                },
                {
                    id: 'inventory',
                    name: 'Inventory',
                    icon: 'üéí',
                    colors: 'from-orange-800/50 to-red-900/50 hover:from-orange-700/60 hover:to-red-800/60',
                    borderColor: 'border-orange-400/30 hover:border-cyan-400/50',
                    unlocked: unlocks.inventory,
                    action: "showInventoryMobile()",
                    requirement: unlockRequirements.inventory.message
                }
            ];
            
            mobileLocationGrid.innerHTML = locations.map(location => {
                const isLocked = !location.unlocked;
                const lockClass = isLocked ? 'opacity-50 grayscale cursor-not-allowed' : '';
                const clickAction = isLocked ? `showLockMessage('${location.requirement}')` : location.action;
                
                return `
                    <button onclick="${clickAction}" class="location-btn bg-gradient-to-br ${location.colors} p-3 rounded-xl border ${location.borderColor} panel-transition neon-glow ${lockClass}">
                        <div class="text-xl mb-1">${location.icon}</div>
                        <div class="font-semibold text-sm">${location.name}</div>
                        ${isLocked ? '<div class="text-xs text-red-300 mt-1">üîí Locked</div>' : ''}
                    </button>
                `;
            }).join('');
            
            // Update mobile mini game button
            const miniGameUnlocked = unlocks.miniGame;
            const miniGameLockClass = !miniGameUnlocked ? 'opacity-50 grayscale cursor-not-allowed' : '';
            const miniGameAction = !miniGameUnlocked ? `showLockMessage('${unlockRequirements.miniGame.message}')` : 'showMiniGameMobile()';
            
            mobileMiniGameButton.innerHTML = `
                <div class="space-y-2">
                    <button onclick="${miniGameAction}" class="bg-gradient-to-r from-cyan-800/50 to-teal-900/50 hover:from-cyan-700/60 hover:to-teal-800/60 px-4 py-3 rounded-xl border border-cyan-400/30 hover:border-cyan-400/50 panel-transition neon-glow ${miniGameLockClass} w-full">
                        <div class="text-xl mb-1">üéØ</div>
                        <div class="font-semibold text-sm">Mini Game: Susun Kata</div>
                        <div class="text-xs text-cyan-300 mt-1">${!miniGameUnlocked ? 'üîí Locked' : 'Susun slogan anti-bullying!'}</div>
                    </button>
                    <button onclick="${!miniGameUnlocked ? `showLockMessage('${unlockRequirements.miniGame.message}')` : 'showBullyDefenderMobile()'}" class="bg-gradient-to-r from-red-800/50 to-orange-900/50 hover:from-red-700/60 hover:to-orange-800/60 px-4 py-3 rounded-xl border border-red-400/30 hover:border-red-400/50 panel-transition neon-glow ${miniGameLockClass} w-full">
                        <div class="text-xl mb-1">üõ°Ô∏è</div>
                        <div class="font-semibold text-sm">Bully Defender</div>
                        <div class="text-xs text-red-300 mt-1">${!miniGameUnlocked ? 'üîí Locked' : 'Lindungi teman dari bullying!'}</div>
                    </button>
                </div>
            `;
        }

        // Mobile action functions
        function selectLocationMobile(location) {
            toggleMobileMap(); // Close popup
            selectLocation(location);
        }

        function showMathModeMobile() {
            toggleMobileMap(); // Close popup
            showMathMode();
        }

        function showStoryModeMobile() {
            toggleMobileMap(); // Close popup
            showStoryMode();
        }

        function showInventoryMobile() {
            toggleMobileMap(); // Close popup
            showInventory();
        }

        function showMiniGameMobile() {
            toggleMobileMap(); // Close popup
            showMiniGame();
        }

        function showBullyDefenderMobile() {
            toggleMobileMap(); // Close popup
            showBullyDefender();
        }

        // Bully Defender Game Data
        const bullyDefenderScenarios = [
            {
                id: 1,
                title: "Koridor Sekolah",
                description: "Kamu melihat seorang siswa kecil sedang dikerumuni oleh 3 siswa yang lebih besar. Mereka mengambil tas dan mengejeknya.",
                background: "üè´",
                victim: "üò∞",
                bullies: ["üò†", "üò§", "üò°"],
                timeLimit: 10,
                actions: [
                    { text: "Langsung menghampiri dan menegur", points: 20, speed: "fast", result: "Kamu berhasil menghentikan bullying dengan berani!" },
                    { text: "Memanggil guru terdekat", points: 15, speed: "medium", result: "Guru datang dan menangani situasi dengan baik." },
                    { text: "Mengajak teman lain untuk membantu", points: 18, speed: "medium", result: "Bersama teman, kalian berhasil membantu korban." },
                    { text: "Berteriak untuk menarik perhatian", points: 12, speed: "fast", result: "Perhatian orang lain membuat bully menghentikan aksinya." }
                ]
            },
            {
                id: 2,
                title: "Kantin Sekolah",
                description: "Di kantin, sekelompok siswa sengaja menumpahkan minuman ke siswa yang sedang makan sendirian sambil tertawa.",
                background: "üçΩÔ∏è",
                victim: "üò¢",
                bullies: ["üòà", "üòè", "üôÑ"],
                timeLimit: 8,
                actions: [
                    { text: "Membantu membersihkan dan menghibur korban", points: 22, speed: "medium", result: "Korban merasa terbantu dan tidak sendirian." },
                    { text: "Menegur pelaku dengan tegas", points: 18, speed: "fast", result: "Pelaku merasa malu dan meminta maaf." },
                    { text: "Melaporkan ke petugas kantin", points: 16, speed: "slow", result: "Petugas kantin memberikan teguran kepada pelaku." },
                    { text: "Mengajak korban pindah tempat", points: 14, speed: "medium", result: "Korban merasa aman di tempat yang baru." }
                ]
            },
            {
                id: 3,
                title: "Lapangan Olahraga",
                description: "Saat pelajaran olahraga, beberapa siswa sengaja tidak memilih seorang siswa untuk tim mereka dan mengejek kemampuannya.",
                background: "‚öΩ",
                victim: "üòî",
                bullies: ["üèÉ‚Äç‚ôÇÔ∏è", "ü§æ‚Äç‚ôÇÔ∏è", "üèãÔ∏è‚Äç‚ôÇÔ∏è"],
                timeLimit: 12,
                actions: [
                    { text: "Memilih korban untuk tim kamu", points: 25, speed: "fast", result: "Korban merasa dihargai dan bermain dengan baik!" },
                    { text: "Mengusulkan pembagian tim yang adil", points: 20, speed: "medium", result: "Semua siswa mendapat kesempatan bermain yang sama." },
                    { text: "Memberikan semangat pada korban", points: 15, speed: "fast", result: "Korban menjadi lebih percaya diri." },
                    { text: "Berbicara dengan guru olahraga", points: 18, speed: "slow", result: "Guru mengatur ulang pembagian tim dengan adil." }
                ]
            },
            {
                id: 4,
                title: "Kelas Saat Istirahat",
                description: "Beberapa siswa sedang mengejek penampilan dan pakaian seorang teman sekelas yang berasal dari keluarga kurang mampu.",
                background: "üìö",
                victim: "üòû",
                bullies: ["üíÖ", "üëó", "üíÑ"],
                timeLimit: 9,
                actions: [
                    { text: "Membela korban dan menjelaskan bahwa penampilan tidak penting", points: 24, speed: "medium", result: "Kamu berhasil mengubah pandangan teman-teman." },
                    { text: "Mengalihkan pembicaraan ke hal positif tentang korban", points: 20, speed: "fast", result: "Fokus berubah ke hal-hal baik tentang korban." },
                    { text: "Mengajak korban bergabung dengan aktivitas kamu", points: 18, speed: "medium", result: "Korban merasa diterima dan bahagia." },
                    { text: "Mengingatkan tentang nilai-nilai toleransi", points: 22, speed: "slow", result: "Teman-teman mulai menyadari kesalahan mereka." }
                ]
            },
            {
                id: 5,
                title: "Grup Chat Kelas",
                description: "Di grup chat, beberapa siswa mengirim meme yang mengejek salah satu teman dan mengajaknya keluar dari grup.",
                background: "üì±",
                victim: "üò≠",
                bullies: ["üòÇ", "ü§£", "üòÜ"],
                timeLimit: 15,
                actions: [
                    { text: "Membela korban di grup chat", points: 20, speed: "fast", result: "Kamu menunjukkan dukungan yang berani di depan semua." },
                    { text: "Mengirim pesan pribadi untuk menghibur korban", points: 18, speed: "medium", result: "Korban merasa ada yang peduli dengannya." },
                    { text: "Melaporkan perilaku cyberbullying ke wali kelas", points: 22, speed: "slow", result: "Wali kelas menangani masalah dengan serius." },
                    { text: "Mengajak teman lain untuk mendukung korban", points: 25, speed: "medium", result: "Banyak teman yang akhirnya membela korban." }
                ]
            }
        ];

        let currentBullyDefender = null;
        let bullyDefenderTimer = null;
        let bullyDefenderTimeLeft = 0;

        // Bully Defender functions
        function showBullyDefender() {
            document.getElementById('bullyDefenderModal').classList.remove('hidden');
            startNewBullyDefender();
            
            // Auto-lock panel when entering bully defender
            if (!isPanelLocked) {
                setTimeout(() => {
                    togglePanelLock();
                    showNotification(`üîí Panel terkunci otomatis\nFokus pada Bully Defender!`);
                }, 500);
            }
        }

        function closeBullyDefender() {
            document.getElementById('bullyDefenderModal').classList.add('hidden');
            if (bullyDefenderTimer) {
                clearInterval(bullyDefenderTimer);
                bullyDefenderTimer = null;
            }
            currentBullyDefender = null;
        }

        function startNewBullyDefender() {
            const randomScenario = bullyDefenderScenarios[Math.floor(Math.random() * bullyDefenderScenarios.length)];
            currentBullyDefender = { ...randomScenario };
            bullyDefenderTimeLeft = currentBullyDefender.timeLimit;
            
            updateBullyDefenderUI();
            startBullyDefenderTimer();
        }

        function updateBullyDefenderUI() {
            if (!currentBullyDefender) return;
            
            const content = document.getElementById('bullyDefenderContent');
            content.innerHTML = `
                <div class="text-center mb-6">
                    <div class="bg-gradient-to-r from-red-900/30 to-orange-900/30 p-4 rounded-xl border border-red-400/20 mb-4">
                        <h3 class="font-bold text-red-300 mb-3 text-lg">${currentBullyDefender.background} ${currentBullyDefender.title}</h3>
                        <div class="bg-yellow-900/30 p-3 rounded-lg border border-yellow-400/20 mb-3">
                            <p class="text-yellow-100 text-base">${currentBullyDefender.description}</p>
                        </div>
                        <div class="flex justify-center items-center gap-4 mb-3">
                            <div class="text-center">
                                <div class="text-4xl mb-1">${currentBullyDefender.victim}</div>
                                <div class="text-xs text-gray-300">Korban</div>
                            </div>
                            <div class="text-2xl">VS</div>
                            <div class="flex gap-2">
                                ${currentBullyDefender.bullies.map(bully => `
                                    <div class="text-center">
                                        <div class="text-3xl mb-1">${bully}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        <div class="bg-red-900/30 p-2 rounded border border-red-400/20">
                            <div class="text-red-300 font-bold">‚è∞ Waktu Tersisa: <span id="bullyDefenderTimer">${bullyDefenderTimeLeft}</span> detik</div>
                            <div class="text-xs text-gray-300 mt-1">Bertindak cepat untuk menyelamatkan korban!</div>
                        </div>
                    </div>
                </div>
                
                <div class="mb-6">
                    <h4 class="text-center text-orange-300 font-bold mb-4 text-lg">üö® Pilih Tindakan Cepat:</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        ${currentBullyDefender.actions.map((action, index) => {
                            const speedColors = {
                                fast: 'from-green-700/50 to-emerald-800/50 border-green-400/30',
                                medium: 'from-yellow-700/50 to-orange-800/50 border-yellow-400/30',
                                slow: 'from-red-700/50 to-pink-800/50 border-red-400/30'
                            };
                            const speedIcons = {
                                fast: '‚ö°',
                                medium: '‚è±Ô∏è',
                                slow: 'üêå'
                            };
                            
                            return `
                                <button onclick="selectBullyDefenderAction(${index})" 
                                        class="bg-gradient-to-br ${speedColors[action.speed]} border-2 rounded-xl p-4 hover:scale-105 transition-all duration-300 text-left">
                                    <div class="flex items-start gap-3">
                                        <div class="text-2xl">${speedIcons[action.speed]}</div>
                                        <div class="flex-1">
                                            <div class="font-semibold text-white mb-1">${action.text}</div>
                                            <div class="text-xs text-gray-300">
                                                Kecepatan: ${action.speed}
                                            </div>
                                        </div>
                                    </div>
                                </button>
                            `;
                        }).join('')}
                    </div>
                </div>
                
                <div class="text-center">
                    <button onclick="startNewBullyDefender()" class="bg-gradient-to-r from-blue-600/50 to-cyan-600/50 hover:from-blue-500/60 hover:to-cyan-500/60 px-6 py-3 rounded-lg font-semibold panel-transition">
                        üîÑ Skenario Baru
                    </button>
                </div>
            `;
        }

        function startBullyDefenderTimer() {
            if (bullyDefenderTimer) clearInterval(bullyDefenderTimer);
            
            bullyDefenderTimer = setInterval(() => {
                bullyDefenderTimeLeft--;
                const timerElement = document.getElementById('bullyDefenderTimer');
                if (timerElement) {
                    timerElement.textContent = bullyDefenderTimeLeft;
                    
                    // Change color based on time left
                    if (bullyDefenderTimeLeft <= 3) {
                        timerElement.className = 'text-red-300 animate-pulse';
                    } else if (bullyDefenderTimeLeft <= 6) {
                        timerElement.className = 'text-yellow-300';
                    }
                }
                
                if (bullyDefenderTimeLeft <= 0) {
                    clearInterval(bullyDefenderTimer);
                    showBullyDefenderTimeout();
                }
            }, 1000);
        }

        function selectBullyDefenderAction(actionIndex) {
            if (bullyDefenderTimer) {
                clearInterval(bullyDefenderTimer);
                bullyDefenderTimer = null;
            }
            
            const action = currentBullyDefender.actions[actionIndex];
            
            // Add points
            gameState.kindnessPoints += action.points;
            
            // Track bully defender completion for achievements
            if (!gameState.bullyDefenderCompleted) gameState.bullyDefenderCompleted = 0;
            gameState.bullyDefenderCompleted++;
            
            // Track bullying stopped
            if (!gameState.bullyingsStopped) gameState.bullyingsStopped = 0;
            gameState.bullyingsStopped++;
            
            checkAchievements();
            updateUI();
            
            // AUTO-SAVE: Save after bully defender action
            saveGameState();
            showAutoSaveNotification('üíæ Bully Defender selesai! Progress tersimpan otomatis.');
            
            showBullyDefenderResult(action);
        }

        function showBullyDefenderResult(action) {
            const content = document.getElementById('bullyDefenderContent');
            content.innerHTML = `
                <div class="text-center">
                    <div class="text-6xl mb-4 emoji-bounce">üõ°Ô∏è</div>
                    <h3 class="text-2xl font-bold text-green-300 mb-2">Misi Berhasil!</h3>
                    <p class="text-lg text-cyan-300 mb-4">"${action.text}"</p>
                    <div class="bg-green-900/30 p-4 rounded-xl border border-green-400/20 mb-4">
                        <p class="text-green-300 mb-2">‚úÖ ${action.result}</p>
                        <p class="text-green-300">üéÅ Hadiah: +${action.points} poin kebaikan</p>
                        <p class="text-green-300">üèÜ Kamu telah melindungi teman dari bullying!</p>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-3 justify-center">
                        <button onclick="startNewBullyDefender()" class="bg-gradient-to-r from-blue-600/50 to-cyan-600/50 hover:from-blue-500/60 hover:to-cyan-500/60 px-6 py-2 rounded-lg font-semibold panel-transition">
                            üöÄ Misi Berikutnya
                        </button>
                        <button onclick="closeBullyDefender()" class="bg-gradient-to-r from-gray-600/50 to-gray-700/50 hover:from-gray-500/60 hover:to-gray-600/60 px-6 py-2 rounded-lg font-semibold panel-transition">
                            üè† Kembali
                        </button>
                    </div>
                </div>
            `;
            
            showNotification(`üõ°Ô∏è Misi Berhasil!\n${action.result}\n+${action.points} poin kebaikan`);
        }

        function showBullyDefenderTimeout() {
            const content = document.getElementById('bullyDefenderContent');
            content.innerHTML = `
                <div class="text-center">
                    <div class="text-6xl mb-4 emoji-shake">‚è∞</div>
                    <h3 class="text-2xl font-bold text-red-300 mb-2">Waktu Habis!</h3>
                    <p class="text-lg text-gray-300 mb-4">Kamu terlambat bertindak. Korban masih membutuhkan bantuan.</p>
                    <div class="bg-red-900/30 p-4 rounded-xl border border-red-400/20 mb-4">
                        <p class="text-red-300 mb-2">üòî Bullying berlanjut karena tidak ada yang bertindak</p>
                        <p class="text-yellow-300">üí° Ingat: Dalam situasi bullying, setiap detik sangat berharga!</p>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-3 justify-center">
                        <button onclick="startNewBullyDefender()" class="bg-gradient-to-r from-orange-600/50 to-red-600/50 hover:from-orange-500/60 hover:to-red-500/60 px-6 py-2 rounded-lg font-semibold panel-transition">
                            üîÑ Coba Lagi
                        </button>
                        <button onclick="closeBullyDefender()" class="bg-gradient-to-r from-gray-600/50 to-gray-700/50 hover:from-gray-500/60 hover:to-gray-600/60 px-6 py-2 rounded-lg font-semibold panel-transition">
                            üè† Kembali
                        </button>
                    </div>
                </div>
            `;
            
            // Still save progress even on timeout
            saveGameState();
            showAutoSaveNotification('üíæ Progress tersimpan meski waktu habis.');
            
            showNotification(`‚è∞ Waktu Habis!\nBertindak lebih cepat untuk melindungi korban bullying.`);
        }

        // Update location grid with lock system
        function updateLocationGrid() {
            const locationGrid = document.getElementById('locationGrid');
            const miniGameButton = document.getElementById('miniGameButton');
            const unlocks = gameState.unlockedFeatures;
            
            const locations = [
                {
                    id: 'school',
                    name: 'Sekolah',
                    icon: 'üè´',
                    colors: 'from-purple-800/50 to-indigo-900/50 hover:from-purple-700/60 hover:to-indigo-800/60',
                    borderColor: 'border-purple-400/30 hover:border-cyan-400/50',
                    unlocked: true,
                    action: "selectLocationWithAutoLock('school')"
                },
                {
                    id: 'park',
                    name: 'Taman',
                    icon: 'üå≥',
                    colors: 'from-green-800/50 to-emerald-900/50 hover:from-green-700/60 hover:to-emerald-800/60',
                    borderColor: 'border-green-400/30 hover:border-cyan-400/50',
                    unlocked: unlocks.park,
                    action: "selectLocationWithAutoLock('park')",
                    requirement: unlockRequirements.park.message
                },
                {
                    id: 'classroom',
                    name: 'Ruang Kelas',
                    icon: 'üìö',
                    colors: 'from-blue-800/50 to-cyan-900/50 hover:from-blue-700/60 hover:to-cyan-800/60',
                    borderColor: 'border-blue-400/30 hover:border-cyan-400/50',
                    unlocked: unlocks.classroom,
                    action: "selectLocationWithAutoLock('classroom')",
                    requirement: unlockRequirements.classroom.message
                },
                {
                    id: 'mathTutor',
                    name: 'Math Tutor',
                    icon: 'üßÆ',
                    colors: 'from-yellow-800/50 to-orange-900/50 hover:from-yellow-700/60 hover:to-orange-800/60',
                    borderColor: 'border-yellow-400/30 hover:border-cyan-400/50',
                    unlocked: unlocks.mathTutor,
                    action: "showMathMode()",
                    requirement: unlockRequirements.mathTutor.message
                },
                {
                    id: 'storyMode',
                    name: 'Story Mode',
                    icon: 'üìñ',
                    colors: 'from-pink-800/50 to-rose-900/50 hover:from-pink-700/60 hover:to-rose-800/60',
                    borderColor: 'border-pink-400/30 hover:border-cyan-400/50',
                    unlocked: unlocks.storyMode,
                    action: "showStoryMode()",
                    requirement: unlockRequirements.storyMode.message
                },
                {
                    id: 'inventory',
                    name: 'Inventory',
                    icon: 'üéí',
                    colors: 'from-orange-800/50 to-red-900/50 hover:from-orange-700/60 hover:to-red-800/60',
                    borderColor: 'border-orange-400/30 hover:border-cyan-400/50',
                    unlocked: unlocks.inventory,
                    action: "showInventory()",
                    requirement: unlockRequirements.inventory.message
                }
            ];
            
            locationGrid.innerHTML = locations.map(location => {
                const isLocked = !location.unlocked;
                const lockClass = isLocked ? 'opacity-50 grayscale cursor-not-allowed' : '';
                const clickAction = isLocked ? `showLockMessage('${location.requirement}')` : location.action;
                
                return `
                    <button onclick="${clickAction}" class="location-btn bg-gradient-to-br ${location.colors} p-3 md:p-4 rounded-xl border ${location.borderColor} panel-transition neon-glow ${lockClass}">
                        <div class="text-xl md:text-2xl mb-1 md:mb-2">${location.icon}</div>
                        <div class="font-semibold text-sm md:text-base">${location.name}</div>
                        ${isLocked ? '<div class="text-xs text-red-300 mt-1">üîí Locked</div>' : ''}
                    </button>
                `;
            }).join('');
            
            // Update mini game button
            const miniGameUnlocked = unlocks.miniGame;
            const miniGameLockClass = !miniGameUnlocked ? 'opacity-50 grayscale cursor-not-allowed' : '';
            const miniGameAction = !miniGameUnlocked ? `showLockMessage('${unlockRequirements.miniGame.message}')` : 'showMiniGame()';
            
            miniGameButton.innerHTML = `
                <div class="flex flex-col md:flex-row gap-4 justify-center">
                    <button onclick="${miniGameAction}" class="interactive-hint bg-gradient-to-r from-cyan-800/50 to-teal-900/50 hover:from-cyan-700/60 hover:to-teal-800/60 px-6 py-3 rounded-xl border border-cyan-400/30 hover:border-cyan-400/50 panel-transition neon-glow ${miniGameLockClass}">
                        <div class="text-2xl mb-1 emoji-bounce">üéØ</div>
                        <div class="font-semibold">Mini Game: Susun Kata</div>
                        <div class="text-xs text-cyan-300 mt-1">${!miniGameUnlocked ? 'üîí Locked - ' + unlockRequirements.miniGame.message : 'Susun slogan anti-bullying!'}</div>
                    </button>
                    <button onclick="${!miniGameUnlocked ? `showLockMessage('${unlockRequirements.miniGame.message}')` : 'showBullyDefender()'}" class="interactive-hint bg-gradient-to-r from-red-800/50 to-orange-900/50 hover:from-red-700/60 hover:to-orange-800/60 px-6 py-3 rounded-xl border border-red-400/30 hover:border-red-400/50 panel-transition neon-glow ${miniGameLockClass}">
                        <div class="text-2xl mb-1 emoji-pulse">üõ°Ô∏è</div>
                        <div class="font-semibold">Bully Defender</div>
                        <div class="text-xs text-red-300 mt-1">${!miniGameUnlocked ? 'üîí Locked - ' + unlockRequirements.miniGame.message : 'Lindungi teman dari bullying!'}</div>
                    </button>
                </div>
            `;
        }

        // Show lock message
        function showLockMessage(message) {
            showNotification(`üîí Fitur Terkunci\n${message}`);
        }

        // Daily missions functions
        function initializeDailyMissions() {
            const today = new Date().toDateString();
            if (!gameState.lastDailyReset || gameState.lastDailyReset !== today) {
                generateDailyMissions();
                gameState.lastDailyReset = today;
                saveGameState();
            }
        }

        function generateDailyMissions() {
            const shuffled = [...dailyMissionTemplates].sort(() => 0.5 - Math.random());
            gameState.dailyMissions = shuffled.slice(0, 3).map(template => ({
                ...template,
                progress: 0,
                completed: false,
                id: template.id + '_' + Date.now()
            }));
        }

        function updateDailyMissionsUI() {
            const container = document.getElementById('dailyMissionsList');
            if (!container) return;
            
            container.innerHTML = gameState.dailyMissions.map(mission => {
                const progressPercent = Math.min((mission.progress / mission.target) * 100, 100);
                const isCompleted = mission.completed;
                
                return `
                    <div class="bg-gradient-to-r ${isCompleted ? 'from-green-900/30 to-emerald-900/30 border-green-400/20' : 'from-blue-900/30 to-purple-900/30 border-blue-400/20'} p-3 rounded-lg border">
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="font-semibold text-sm ${isCompleted ? 'text-green-300' : 'text-blue-300'}">${mission.title}</h4>
                            <span class="text-xs px-2 py-1 rounded ${isCompleted ? 'bg-green-600' : 'bg-blue-600'}">${isCompleted ? 'Selesai' : 'Aktif'}</span>
                        </div>
                        <p class="text-xs text-gray-300 mb-2">${mission.description}</p>
                        <div class="flex justify-between items-center mb-2">
                            <div class="flex-1 bg-gray-700 rounded-full h-2 mr-2">
                                <div class="bg-gradient-to-r from-blue-500 to-purple-500 h-2 rounded-full transition-all duration-300" style="width: ${progressPercent}%"></div>
                            </div>
                            <span class="text-xs text-gray-400">${mission.progress}/${mission.target}</span>
                        </div>
                        <div class="text-xs text-purple-300">
                            üéÅ ${collectiblesData[mission.reward.item]?.icon || 'üéÅ'} ${collectiblesData[mission.reward.item]?.name || 'Hadiah'} + ${mission.reward.points} poin
                        </div>
                    </div>
                `;
            }).join('');
        }

        function checkDailyMissionProgress(type, value = 1) {
            let updated = false;
            
            gameState.dailyMissions.forEach(mission => {
                if (mission.completed) return;
                
                let shouldProgress = false;
                
                switch (mission.id.split('_')[0]) {
                    case 'kindness':
                        if (type === 'positive_choice' && value >= 10) shouldProgress = true;
                        break;
                    case 'math':
                        if (type === 'math_correct') shouldProgress = true;
                        break;
                    case 'hero':
                        if (type === 'mission_complete') shouldProgress = true;
                        break;
                    case 'perfect':
                        if (type === 'perfect_choice' && value >= 15) shouldProgress = true;
                        break;
                    case 'story':
                        if (type === 'story_ending') shouldProgress = true;
                        break;
                }
                
                if (shouldProgress) {
                    mission.progress = Math.min(mission.progress + 1, mission.target);
                    if (mission.progress >= mission.target && !mission.completed) {
                        mission.completed = true;
                        completeDailyMission(mission);
                        updated = true;
                    }
                }
            });
            
            if (updated) {
                updateDailyMissionsUI();
                saveGameState();
            }
        }

        function completeDailyMission(mission) {
            // Add collectible to inventory
            if (!gameState.collectibles.includes(mission.reward.item)) {
                gameState.collectibles.push(mission.reward.item);
            }
            
            // Add points
            gameState.kindnessPoints += mission.reward.points;
            
            // Show completion notification
            showNotification(`üéâ Daily Mission Complete!\n${mission.title}\n+${collectiblesData[mission.reward.item]?.icon || 'üéÅ'} ${collectiblesData[mission.reward.item]?.name || 'Item'}`);
            
            // Check achievements
            checkAchievements();
        }

        function refreshDailyMissions() {
            const today = new Date().toDateString();
            if (gameState.lastDailyReset === today) {
                showNotification('‚è∞ Daily missions sudah di-refresh hari ini!\nCoba lagi besok.');
                return;
            }
            
            generateDailyMissions();
            gameState.lastDailyReset = today;
            updateDailyMissionsUI();
            saveGameState();
            showNotification('üîÑ Daily missions berhasil di-refresh!');
        }

        // Achievements system
        function checkAchievements() {
            achievementsData.forEach(achievement => {
                if (gameState.achievements.includes(achievement.id)) return;
                
                let unlocked = false;
                
                switch (achievement.id) {
                    case 'first_steps':
                        if (gameState.completedMissions >= 1) unlocked = true;
                        break;
                    case 'kindness_warrior':
                        if (gameState.kindnessPoints >= 100) unlocked = true;
                        break;
                    case 'math_genius':
                        if (gameState.smartLevel >= 10) unlocked = true;
                        break;
                    case 'story_master':
                        if (gameState.storyProgress.unlockedEndings.length >= 5) unlocked = true;
                        break;
                    case 'daily_champion':
                        // Check if completed daily missions 7 days in a row (simplified)
                        if (gameState.dailyMissions.every(m => m.completed)) unlocked = true;
                        break;
                    case 'perfect_hero':
                        if (gameState.playerLevel >= 20 && gameState.kindnessPoints >= 500) unlocked = true;
                        break;
                    case 'brave_heart':
                        if (!gameState.braveActions) gameState.braveActions = 0;
                        if (gameState.braveActions >= 10) unlocked = true;
                        break;
                    case 'peace_maker':
                        if (!gameState.peacefulResolutions) gameState.peacefulResolutions = 0;
                        if (gameState.peacefulResolutions >= 20) unlocked = true;
                        break;
                    case 'diversity_champion':
                        if (!gameState.diversityHelps) gameState.diversityHelps = 0;
                        if (gameState.diversityHelps >= 15) unlocked = true;
                        break;
                    case 'word_master':
                        if (!gameState.miniGamesCompleted) gameState.miniGamesCompleted = 0;
                        if (gameState.miniGamesCompleted >= 10) unlocked = true;
                        break;
                    case 'level_legend':
                        if (gameState.playerLevel >= 20) unlocked = true;
                        break;
                    case 'collector_supreme':
                        if (gameState.collectibles.length >= 10) unlocked = true; // Adjusted for available collectibles
                        break;
                    case 'helper_hero':
                        if (gameState.completedMissions >= 50) unlocked = true; // Simplified metric
                        break;
                    case 'smart_cookie':
                        if (!gameState.mathCorrectAnswers) gameState.mathCorrectAnswers = 0;
                        if (gameState.mathCorrectAnswers >= 50) unlocked = true;
                        break;
                    case 'anti_bully_champion':
                        if (!gameState.bullyingsStopped) gameState.bullyingsStopped = 0;
                        if (gameState.bullyingsStopped >= 25) unlocked = true;
                        break;
                }
                
                if (unlocked) {
                    unlockAchievement(achievement);
                }
            });
        }

        function unlockAchievement(achievement) {
            gameState.achievements.push(achievement.id);
            
            // Add activity log
            addActivity(`üèÜ Achievement: ${achievement.title}`);
            
            // Add rewards
            if (achievement.reward.points) {
                gameState.kindnessPoints += achievement.reward.points;
                addActivity(`üéÅ Bonus: +${achievement.reward.points} poin`);
            }
            if (achievement.reward.badge) {
                if (!gameState.inventory.badges.includes(achievement.reward.badge)) {
                    gameState.inventory.badges.push(achievement.reward.badge);
                    addActivity(`üèÖ Badge baru: ${achievement.reward.badge}`);
                }
            }
            if (achievement.reward.item) {
                if (!gameState.collectibles.includes(achievement.reward.item)) {
                    gameState.collectibles.push(achievement.reward.item);
                    const itemName = collectiblesData[achievement.reward.item]?.name || 'Item';
                    addActivity(`üíé Item baru: ${itemName}`);
                }
            }
            
            showNotification(`üèÜ Achievement Unlocked!\n${achievement.title}\n${achievement.description}`);
            updateSidebarContent(); // Update sidebar with new achievement count
            saveGameState();
        }

        // Story Mode functions
        function showStoryMode() {
            document.getElementById('storyMode').classList.add('hidden');
            document.getElementById('mathMode').classList.add('hidden');
            document.getElementById('storyModePanel').classList.remove('hidden');
            updateStoryModeUI();
            
            // Auto-lock panel when entering story mode
            if (!isPanelLocked) {
                setTimeout(() => {
                    togglePanelLock();
                    showNotification(`üîí Panel terkunci otomatis\nFokus pada Story Mode!`);
                }, 500);
            }
        }

        function hideStoryMode() {
            // Auto-unlock panel when closing story mode
            if (isPanelLocked) {
                togglePanelLock();
                showNotification('üîì Panel dibuka otomatis\nKamu keluar dari Story Mode!');
            }
            
            document.getElementById('storyModePanel').classList.add('hidden');
            document.getElementById('storyMode').classList.remove('hidden');
        }

        function updateStoryModeUI() {
            const currentChapter = gameState.storyProgress.currentChapter;
            const completedChapters = gameState.storyProgress.completedChapters.length;
            const unlockedEndings = gameState.storyProgress.unlockedEndings.length;
            
            document.getElementById('currentChapterTitle').textContent = 
                `Chapter ${currentChapter}: ${storyChapters[currentChapter]?.title || 'Unknown'}`;
            document.getElementById('storyProgress').textContent = 
                `Progress: ${completedChapters}/3 Chapters`;
            document.getElementById('endingsCount').textContent = `${unlockedEndings}/5`;
            document.getElementById('currentPath').textContent = 
                gameState.storyProgress.currentPath.charAt(0).toUpperCase() + gameState.storyProgress.currentPath.slice(1);
        }

        function startStoryMode() {
            const chapter = storyChapters[gameState.storyProgress.currentChapter];
            if (chapter && chapter.scenarios) {
                // Start with intro scenario or continue from current scenario
                const startScenario = gameState.storyProgress.currentScenario || 'intro_1';
                if (chapter.scenarios[startScenario]) {
                    showStoryScenario(chapter.scenarios[startScenario]);
                } else {
                    // If scenario doesn't exist, start from beginning
                    showStoryScenario(chapter.scenarios['intro_1']);
                }
            }
        }

        function showStoryScenario(scenario) {
            const storyContent = document.getElementById('storyContent');
            
            // Determine emoji animation based on character emotion
            let emojiAnimation = 'emoji-bounce';
            if (scenario.character.includes('üòü') || scenario.character.includes('üò¨')) {
                emojiAnimation = 'emoji-shake';
            } else if (scenario.character.includes('ü§î') || scenario.character.includes('‚öñÔ∏è')) {
                emojiAnimation = 'emoji-pulse';
            } else if (scenario.character.includes('üëë') || scenario.character.includes('‚ö°')) {
                emojiAnimation = 'emoji-spin';
            }
            
            storyContent.innerHTML = `
                <div class="bg-purple-900/30 p-4 rounded-xl border border-purple-400/20 fade-slide-in">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="font-bold text-cyan-300">${scenario.title}</h4>
                        <div class="text-xs bg-pink-600/50 px-2 py-1 rounded">
                            Chapter ${gameState.storyProgress.currentChapter}
                        </div>
                    </div>
                    <div class="text-center mb-4">
                        <span class="text-5xl ${emojiAnimation}">${scenario.character}</span>
                    </div>
                    <p class="text-gray-200 mb-4 text-center italic leading-relaxed">"${scenario.description}"</p>
                    
                    <div class="mb-3 text-center">
                        <p class="text-sm text-purple-300">üí≠ Pilih tindakanmu dengan bijak...</p>
                    </div>
                    
                    <div class="space-y-3">
                        ${scenario.choices.map((choice, index) => `
                            <button onclick="makeStoryChoice(${index})" class="choice-button w-full text-left bg-gradient-to-r from-pink-800/30 to-purple-800/30 hover:from-pink-700/40 hover:to-purple-700/40 p-4 rounded-lg border border-pink-400/20 hover:border-cyan-400/40 panel-transition">
                                <div class="flex items-start gap-3">
                                    <span class="text-cyan-300 font-bold text-lg">${String.fromCharCode(65 + index)}.</span>
                                    <div class="flex-1">
                                        <span class="block">${choice.text}</span>
                                    </div>
                                    <span class="text-xs text-purple-300">üëÜ</span>
                                </div>
                            </button>
                        `).join('')}
                    </div>
                    
                    <div class="mt-4 text-center">
                        <p class="text-xs text-gray-400">üí° Setiap pilihan akan mempengaruhi jalan ceritamu</p>
                    </div>
                </div>
            `;
            gameState.currentStoryScenario = scenario;
        }

        function makeStoryChoice(choiceIndex) {
            const choice = gameState.currentStoryScenario.choices[choiceIndex];
            const scenario = gameState.currentStoryScenario;
            
            // Add points
            gameState.kindnessPoints += choice.points;
            gameState.storyProgress.currentPath = choice.path;
            
            // Show choice result first
            showStoryChoiceResult(choice, scenario);
            
            // Check for story ending
            checkStoryEnding();
            
            // Update progress
            gameState.storyProgress.currentScenario = choice.nextId;
            
            updateUI();
            updateStoryModeUI();
            saveGameState();
        }

        function showStoryChoiceResult(choice, scenario) {
            const storyContent = document.getElementById('storyContent');
            const pointsText = choice.points > 0 ? `+${choice.points}` : `${choice.points}`;
            const pointsColor = choice.points > 0 ? 'text-green-300' : 'text-red-300';
            
            let resultMessage = '';
            let resultIcon = '';
            let resultColor = '';
            
            if (choice.points >= 15) {
                resultMessage = 'Pilihan Heroik!';
                resultIcon = 'üåü';
                resultColor = 'from-green-900/30 to-emerald-900/30 border-green-400/20';
            } else if (choice.points >= 8) {
                resultMessage = 'Pilihan Baik!';
                resultIcon = '‚≠ê';
                resultColor = 'from-blue-900/30 to-cyan-900/30 border-blue-400/20';
            } else if (choice.points >= 0) {
                resultMessage = 'Pilihan Netral';
                resultIcon = 'üòê';
                resultColor = 'from-yellow-900/30 to-orange-900/30 border-yellow-400/20';
            } else {
                resultMessage = 'Pilihan Kurang Baik';
                resultIcon = 'üòî';
                resultColor = 'from-red-900/30 to-pink-900/30 border-red-400/20';
            }
            
            storyContent.innerHTML = `
                <div class="bg-gradient-to-br ${resultColor} p-4 rounded-xl fade-slide-in">
                    <div class="text-center">
                        <span class="text-4xl mb-3 block">${resultIcon}</span>
                        <h4 class="font-bold text-cyan-300 mb-2">${resultMessage}</h4>
                        <p class="text-gray-200 mb-3 italic">"${choice.text}"</p>
                        <div class="text-lg font-bold ${pointsColor} mb-2">
                            ${pointsText} Poin Kebaikan
                        </div>
                        <div class="text-sm text-purple-300 mb-4">
                            Path: ${choice.path.charAt(0).toUpperCase() + choice.path.slice(1)}
                        </div>
                        
                        <div class="flex flex-col sm:flex-row gap-3 mt-4">
                            <button onclick="continueStoryMode()" class="bg-gradient-to-r from-pink-600 to-purple-600 hover:from-pink-500 hover:to-purple-500 px-6 py-2 rounded-lg font-semibold panel-transition neon-glow">
                                üìñ Lanjut Cerita
                            </button>
                            <button onclick="restartStoryChapter()" class="bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 px-6 py-2 rounded-lg font-semibold panel-transition neon-glow">
                                üîÑ Ulang Chapter
                            </button>
                            <button onclick="hideStoryMode()" class="bg-gradient-to-r from-gray-600 to-gray-700 hover:from-gray-500 hover:to-gray-600 px-6 py-2 rounded-lg font-semibold panel-transition">
                                üè† Kembali
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function continueStoryMode() {
            const currentChapter = gameState.storyProgress.currentChapter;
            const nextScenarioId = gameState.storyProgress.currentScenario;
            
            // Check if next scenario exists in current chapter
            if (storyChapters[currentChapter] && storyChapters[currentChapter].scenarios[nextScenarioId]) {
                showStoryScenario(storyChapters[currentChapter].scenarios[nextScenarioId]);
            } else {
                // Try to progress to next chapter
                const nextChapter = currentChapter + 1;
                if (storyChapters[nextChapter]) {
                    gameState.storyProgress.currentChapter = nextChapter;
                    gameState.storyProgress.completedChapters.push(currentChapter);
                    
                    // Determine next scenario based on path
                    let nextScenario = 'intro_1';
                    const path = gameState.storyProgress.currentPath;
                    
                    if (nextChapter === 2) {
                        if (path === 'confident') nextScenario = 'confident_chapter2';
                        else if (path === 'humble') nextScenario = 'humble_chapter2';
                        else nextScenario = 'confident_chapter2'; // Default
                    } else if (nextChapter === 3) {
                        nextScenario = 'final_test';
                    }
                    
                    gameState.storyProgress.currentScenario = nextScenario;
                    
                    if (storyChapters[nextChapter].scenarios[nextScenario]) {
                        showStoryScenario(storyChapters[nextChapter].scenarios[nextScenario]);
                        showNotification(`üìö Chapter ${nextChapter} Unlocked!\n${storyChapters[nextChapter].title}`);
                    } else {
                        showStoryComplete();
                    }
                } else {
                    // Story complete
                    showStoryComplete();
                }
            }
            
            updateStoryModeUI();
            saveGameState();
        }

        function showStoryComplete() {
            const storyContent = document.getElementById('storyContent');
            const path = gameState.storyProgress.currentPath;
            const totalPoints = gameState.kindnessPoints;
            
            let completionMessage = '';
            let completionIcon = '';
            
            if (totalPoints >= 200) {
                completionMessage = 'Kamu telah menjadi Hero Kebaikan Legendaris!';
                completionIcon = 'üëë';
            } else if (totalPoints >= 100) {
                completionMessage = 'Kamu telah menjadi Hero Kebaikan yang Hebat!';
                completionIcon = 'üåü';
            } else {
                completionMessage = 'Kamu telah menyelesaikan perjalanan sebagai Hero Kebaikan!';
                completionIcon = '‚≠ê';
            }
            
            storyContent.innerHTML = `
                <div class="bg-gradient-to-br from-purple-900/30 to-pink-900/30 p-6 rounded-xl border border-purple-400/20 text-center">
                    <div class="text-6xl mb-4 emoji-bounce">${completionIcon}</div>
                    <h3 class="text-2xl font-bold text-cyan-300 mb-4">Story Mode Complete!</h3>
                    <p class="text-lg text-purple-300 mb-4">${completionMessage}</p>
                    
                    <div class="bg-black/30 p-4 rounded-lg mb-4">
                        <h4 class="font-bold text-yellow-300 mb-2">üìä Statistik Perjalanan:</h4>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <span class="text-gray-300">Total Poin:</span>
                                <span class="font-bold text-green-300">${totalPoints}</span>
                            </div>
                            <div>
                                <span class="text-gray-300">Path:</span>
                                <span class="font-bold text-cyan-300">${path.charAt(0).toUpperCase() + path.slice(1)}</span>
                            </div>
                            <div>
                                <span class="text-gray-300">Chapters:</span>
                                <span class="font-bold text-purple-300">${gameState.storyProgress.completedChapters.length + 1}/3</span>
                            </div>
                            <div>
                                <span class="text-gray-300">Endings:</span>
                                <span class="font-bold text-pink-300">${gameState.storyProgress.unlockedEndings.length}/5</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex flex-col sm:flex-row gap-3 justify-center">
                        <button onclick="restartStoryMode()" class="bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-500 hover:to-emerald-500 px-6 py-2 rounded-lg font-semibold panel-transition neon-glow">
                            üîÑ Main Lagi
                        </button>
                        <button onclick="hideStoryMode()" class="bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 px-6 py-2 rounded-lg font-semibold panel-transition neon-glow">
                            üè† Kembali ke Menu
                        </button>
                    </div>
                </div>
            `;
        }

        function restartStoryChapter() {
            gameState.storyProgress.currentScenario = 'intro_1';
            startStoryMode();
        }

        function restartStoryMode() {
            gameState.storyProgress = {
                currentChapter: 1,
                completedChapters: [],
                unlockedEndings: [],
                currentPath: 'neutral',
                currentScenario: 'intro_1'
            };
            updateStoryModeUI();
            startStoryMode();
            saveGameState();
        }

        function checkStoryEnding() {
            Object.entries(storyEndings).forEach(([endingId, ending]) => {
                if (gameState.storyProgress.unlockedEndings.includes(endingId)) return;
                
                let canUnlock = true;
                
                if (ending.requirements.kindnessPoints && gameState.kindnessPoints < ending.requirements.kindnessPoints) {
                    canUnlock = false;
                }
                if (ending.requirements.smartLevel && gameState.smartLevel < ending.requirements.smartLevel) {
                    canUnlock = false;
                }
                if (ending.requirements.path && gameState.storyProgress.currentPath !== ending.requirements.path) {
                    canUnlock = false;
                }
                
                if (canUnlock) {
                    unlockStoryEnding(endingId, ending);
                }
            });
        }

        function unlockStoryEnding(endingId, ending) {
            gameState.storyProgress.unlockedEndings.push(endingId);
            
            if (ending.collectible && !gameState.collectibles.includes(ending.collectible)) {
                gameState.collectibles.push(ending.collectible);
            }
            
            showNotification(`üìö New Ending Unlocked!\n${ending.title}\n${ending.description}`);
            checkDailyMissionProgress('story_ending');
            updateStoryModeUI();
            saveGameState();
        }

        // Modal functions
        function showAchievements() {
            document.getElementById('achievementsModal').classList.remove('hidden');
            updateAchievementsUI();
        }

        function closeAchievements() {
            document.getElementById('achievementsModal').classList.add('hidden');
        }

        function updateAchievementsUI() {
            const container = document.getElementById('achievementsList');
            container.innerHTML = achievementsData.map(achievement => {
                const isUnlocked = gameState.achievements.includes(achievement.id);
                return `
                    <div class="bg-gradient-to-r ${isUnlocked ? 'from-yellow-900/30 to-orange-900/30 border-yellow-400/20' : 'from-gray-900/30 to-gray-800/30 border-gray-600/20'} p-4 rounded-xl border">
                        <div class="text-center mb-3">
                            <span class="text-3xl ${isUnlocked ? '' : 'grayscale opacity-50'}">${achievement.icon}</span>
                        </div>
                        <h4 class="font-bold text-center mb-2 ${isUnlocked ? 'text-yellow-300' : 'text-gray-400'}">${achievement.title}</h4>
                        <p class="text-sm text-center mb-3 ${isUnlocked ? 'text-gray-200' : 'text-gray-500'}">${achievement.description}</p>
                        <div class="text-center">
                            <span class="text-xs px-2 py-1 rounded ${isUnlocked ? 'bg-yellow-600 text-yellow-100' : 'bg-gray-600 text-gray-300'}">${isUnlocked ? 'Unlocked' : 'Locked'}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function showCollectibles() {
            document.getElementById('collectiblesModal').classList.remove('hidden');
            updateCollectiblesUI();
        }

        function closeCollectibles() {
            document.getElementById('collectiblesModal').classList.add('hidden');
        }

        function updateCollectiblesUI() {
            const container = document.getElementById('collectiblesList');
            container.innerHTML = Object.entries(collectiblesData).map(([itemId, item]) => {
                const isOwned = gameState.collectibles.includes(itemId);
                const rarityColors = {
                    common: 'from-gray-700 to-gray-800 border-gray-500',
                    uncommon: 'from-green-700 to-green-800 border-green-500',
                    rare: 'from-blue-700 to-blue-800 border-blue-500',
                    epic: 'from-purple-700 to-purple-800 border-purple-500',
                    legendary: 'from-yellow-700 to-yellow-800 border-yellow-500',
                    mythic: 'from-red-700 to-red-800 border-red-500'
                };
                
                return `
                    <div class="bg-gradient-to-br ${rarityColors[item.rarity] || rarityColors.common} p-4 rounded-xl border ${isOwned ? '' : 'opacity-50 grayscale'}">
                        <div class="text-center mb-2">
                            <span class="text-3xl">${item.icon}</span>
                        </div>
                        <h4 class="font-bold text-center text-sm mb-1 text-white">${item.name}</h4>
                        <p class="text-xs text-center text-gray-300 mb-2">${item.description}</p>
                        <div class="text-center">
                            <span class="text-xs px-2 py-1 rounded bg-black/30 text-white capitalize">${item.rarity}</span>
                        </div>
                        ${!isOwned ? '<div class="text-center mt-2"><span class="text-xs text-red-300">üîí Locked</span></div>' : ''}
                    </div>
                `;
            }).join('');
        }

        function showInventory() {
            document.getElementById('inventoryModal').classList.remove('hidden');
            updateInventoryUI();
        }

        function closeInventory() {
            document.getElementById('inventoryModal').classList.add('hidden');
        }

        function updateInventoryUI() {
            // Update badges
            const badgesContainer = document.getElementById('badgesList');
            badgesContainer.innerHTML = gameState.inventory.badges.map(badge => `
                <div class="bg-gradient-to-br from-yellow-700 to-orange-800 p-3 rounded-lg border border-yellow-500 text-center">
                    <div class="text-2xl mb-1">üèÖ</div>
                    <div class="text-xs font-semibold text-yellow-100 capitalize">${badge}</div>
                </div>
            `).join('') || '<div class="col-span-full text-center text-gray-400 text-sm">Belum ada badge</div>';
            
            // Update items (collectibles owned)
            const itemsContainer = document.getElementById('itemsList');
            itemsContainer.innerHTML = gameState.collectibles.map(itemId => {
                const item = collectiblesData[itemId];
                return `
                    <div class="bg-gradient-to-br from-purple-700 to-indigo-800 p-3 rounded-lg border border-purple-500 text-center">
                        <div class="text-2xl mb-1">${item.icon}</div>
                        <div class="text-xs font-semibold text-purple-100">${item.name}</div>
                    </div>
                `;
            }).join('') || '<div class="col-span-full text-center text-gray-400 text-sm">Belum ada item</div>';
            
            // Update story endings
            const endingsContainer = document.getElementById('endingsList');
            endingsContainer.innerHTML = gameState.storyProgress.unlockedEndings.map(endingId => {
                const ending = storyEndings[endingId];
                return `
                    <div class="bg-gradient-to-br from-pink-700 to-purple-800 p-3 rounded-lg border border-pink-500">
                        <h4 class="font-bold text-pink-100 text-sm mb-1">${ending.title}</h4>
                        <p class="text-xs text-pink-200">${ending.description}</p>
                    </div>
                `;
            }).join('') || '<div class="col-span-full text-center text-gray-400 text-sm">Belum ada ending yang terbuka</div>';
        }

        // Enhanced math question selection based on level
        function selectMathCategory(category) {
            gameState.currentMathCategory = category;
            const questions = mathQuestions[category];
            if (questions && questions.length > 0) {
                // Filter questions based on player's smart level
                const availableQuestions = questions.filter(q => 
                    !q.level || q.level <= gameState.smartLevel + 2
                );
                
                if (availableQuestions.length > 0) {
                    const question = availableQuestions[Math.floor(Math.random() * availableQuestions.length)];
                    showMathQuestion(question);
                } else {
                    // Fallback to any question if none match level
                    const question = questions[Math.floor(Math.random() * questions.length)];
                    showMathQuestion(question);
                }
            }
        }

        // Enhanced notification system
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-20 right-4 bg-gradient-to-r from-purple-600/90 to-indigo-600/90 text-white px-4 py-3 rounded-lg z-50 fade-slide-in max-w-sm';
            notification.innerHTML = `
                <div class="flex items-start gap-2">
                    <span class="text-lg">üéâ</span>
                    <div class="text-sm whitespace-pre-line">${message}</div>
                </div>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 4000);
        }

        // Update UI elements
        function updateUI() {
            document.getElementById('playerLevel').textContent = gameState.playerLevel;
            document.getElementById('kindnessPoints').textContent = gameState.kindnessPoints;
            document.getElementById('smartLevel').textContent = gameState.smartLevel;
            document.getElementById('mathPoints').textContent = gameState.mathPoints;
            document.getElementById('heroLevel').textContent = gameState.playerLevel;
            document.getElementById('heroKindness').textContent = gameState.kindnessPoints;
            document.getElementById('heroSmart').textContent = gameState.smartLevel;
            document.getElementById('heroMath').textContent = gameState.mathPoints;
            document.getElementById('completedMissions').textContent = gameState.completedMissions;
            
            // Update hero title with level-based titles
            const heroTitle = document.getElementById('heroTitle');
            const levelTitle = levelTitles[gameState.playerLevel] || "üåü Hero Kebaikan";
            heroTitle.textContent = levelTitle;
        }

        // Select location with auto-lock functionality
        function selectLocationWithAutoLock(location) {
            selectLocation(location);
            
            // Auto-lock panel after selecting location
            if (!isPanelLocked) {
                setTimeout(() => {
                    togglePanelLock();
                    showNotification(`üîí Panel terkunci otomatis\nFokus pada misi di ${getLocationName(location)}!`);
                    
                    // Smooth scroll to scenario panel
                    const panel = document.getElementById('scenarioHeroPanel');
                    if (panel) {
                        panel.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }, 500);
            } else {
                // If already locked, just show notification about location change
                showNotification(`üìç Pindah ke ${getLocationName(location)}\nPanel tetap terkunci untuk fokus!`);
            }
        }

        // Select location and show scenario
        function selectLocation(location) {
            gameState.currentLocation = location;
            const locationScenarios = scenarios[location];
            if (locationScenarios && locationScenarios.length > 0) {
                const scenario = locationScenarios[Math.floor(Math.random() * locationScenarios.length)];
                showScenario(scenario);
            }
        }

        // Get location display name
        function getLocationName(location) {
            const locationNames = {
                'school': 'Sekolah',
                'park': 'Taman',
                'classroom': 'Ruang Kelas'
            };
            return locationNames[location] || location;
        }

        // Randomize scenario choices
        function randomizeChoices(scenario) {
            const choices = [...scenario.choices];
            
            // Fisher-Yates shuffle algorithm
            for (let i = choices.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [choices[i], choices[j]] = [choices[j], choices[i]];
            }
            
            return {
                ...scenario,
                choices: choices
            };
        }

        // Show scenario
        function showScenario(scenario) {
            // Randomize choices order
            const randomizedScenario = randomizeChoices(scenario);
            
            // Determine emoji animation based on character emotion
            let emojiAnimation = 'emoji-bounce';
            if (randomizedScenario.character.includes('üò∞') || randomizedScenario.character.includes('üò¢')) {
                emojiAnimation = 'emoji-shake';
            } else if (randomizedScenario.character.includes('üòû') || randomizedScenario.character.includes('üòî')) {
                emojiAnimation = 'emoji-pulse';
            } else if (randomizedScenario.character.includes('üì±')) {
                emojiAnimation = 'emoji-spin';
            }
            
            const scenarioContent = document.getElementById('scenarioContent');
            scenarioContent.innerHTML = `
                <div class="bg-purple-900/30 p-4 rounded-xl border border-purple-400/20 fade-slide-in">
                    <!-- Mission Info -->
                    <div class="bg-gradient-to-r from-yellow-900/30 to-orange-900/30 p-3 rounded-lg border border-yellow-400/20 mb-4 interactive-hint">
                        <h5 class="font-bold text-yellow-300 text-sm mb-1">${randomizedScenario.mission.title}</h5>
                        <p class="text-xs text-gray-300 mb-2">${randomizedScenario.mission.description}</p>
                        <div class="text-xs text-orange-300">üèÜ ${randomizedScenario.mission.reward}</div>
                    </div>
                    
                    <h4 class="font-bold text-cyan-300 mb-3">${randomizedScenario.title}</h4>
                    <div class="text-center mb-4">
                        <span class="text-5xl ${emojiAnimation}">${randomizedScenario.character}</span>
                    </div>
                    <p class="text-gray-200 mb-4 text-center italic">"${randomizedScenario.description}"</p>
                    
                    <div class="mb-3 text-center">
                        <p class="text-sm text-purple-300">üí≠ Apa yang akan kamu lakukan?</p>
                    </div>
                    
                    <div class="space-y-3">
                        ${randomizedScenario.choices.map((choice, index) => `
                            <button onclick="makeChoice(${index})" class="choice-button w-full text-left bg-gradient-to-r from-indigo-800/30 to-purple-800/30 hover:from-indigo-700/40 hover:to-purple-700/40 p-4 rounded-lg border border-indigo-400/20 hover:border-cyan-400/40 panel-transition">
                                <div class="flex items-start gap-3">
                                    <span class="text-cyan-300 font-bold text-lg">${String.fromCharCode(65 + index)}.</span>
                                    <span class="flex-1">${choice.text}</span>
                                    <span class="text-xs text-purple-300">üëÜ</span>
                                </div>
                            </button>
                        `).join('')}
                    </div>
                    
                    <div class="mt-4 text-center">
                        <p class="text-xs text-gray-400">üí° Pilih tindakan yang paling baik untuk situasi ini</p>
                    </div>
                </div>
            `;
            gameState.currentScenario = randomizedScenario;
            
            // Update mission panel
            updateMissionPanel(randomizedScenario.mission);
        }

        // Update mission panel
        function updateMissionPanel(mission) {
            const missionList = document.getElementById('missionList');
            missionList.innerHTML = `
                <div class="bg-gradient-to-r from-yellow-900/30 to-orange-900/30 p-3 rounded-lg border border-yellow-400/20">
                    <h4 class="font-semibold text-yellow-300 text-sm">${mission.title}</h4>
                    <p class="text-xs text-gray-300 mt-1">${mission.description}</p>
                    <div class="flex justify-between items-center mt-2">
                        <span class="text-xs text-orange-300">üèÜ ${mission.reward}</span>
                        <span class="text-xs bg-yellow-600 px-2 py-1 rounded">Aktif</span>
                    </div>
                </div>
            `;
        }

        // Make choice in scenario
        function makeChoice(choiceIndex) {
            const choice = gameState.currentScenario.choices[choiceIndex];
            gameState.kindnessPoints += choice.points;
            
            // Add activity log
            const pointsText = choice.points > 0 ? `+${choice.points}` : `${choice.points}`;
            addActivity(`‚ö° Pilihan: ${pointsText} poin`);
            
            // Track specific achievement metrics
            if (choice.points >= 15) {
                if (!gameState.braveActions) gameState.braveActions = 0;
                gameState.braveActions++;
                addActivity('üí™ Tindakan berani!');
            }
            
            if (choice.text.toLowerCase().includes('damai') || choice.text.toLowerCase().includes('lapor')) {
                if (!gameState.peacefulResolutions) gameState.peacefulResolutions = 0;
                gameState.peacefulResolutions++;
                addActivity('üïäÔ∏è Resolusi damai');
            }
            
            if (choice.text.toLowerCase().includes('berbeda') || choice.text.toLowerCase().includes('keberagaman')) {
                if (!gameState.diversityHelps) gameState.diversityHelps = 0;
                gameState.diversityHelps++;
                addActivity('üåà Mendukung keberagaman');
            }
            
            if (choice.text.toLowerCase().includes('bully') || choice.text.toLowerCase().includes('ganggu')) {
                if (!gameState.bullyingsStopped) gameState.bullyingsStopped = 0;
                gameState.bullyingsStopped++;
                addActivity('üõ°Ô∏è Menghentikan bullying');
            }
            
            let missionCompleted = false;
            if (choice.points > 0) {
                gameState.completedMissions++;
                missionCompleted = true;
                addActivity('üèÜ Misi selesai!');
                
                if (gameState.kindnessPoints >= gameState.playerLevel * 20) {
                    const oldLevel = gameState.playerLevel;
                    gameState.playerLevel++;
                    addActivity(`üÜô Level up! ${oldLevel} ‚Üí ${gameState.playerLevel}`);
                }
                
                // Check daily mission progress
                if (choice.points >= 10) {
                    checkDailyMissionProgress('positive_choice', choice.points);
                }
                if (choice.points >= 15) {
                    checkDailyMissionProgress('perfect_choice', choice.points);
                }
                checkDailyMissionProgress('mission_complete');
            }
            
            // Check for new unlocks
            checkUnlocks();
            updateLocationGrid();
            
            // Check achievements
            checkAchievements();
            
            showChoiceResult(choice, missionCompleted);
            updateUI();
            updateSidebarContent(); // Update sidebar with new stats
            saveGameState();
        }

        // Show choice result
        function showChoiceResult(choice, missionCompleted) {
            const scenarioContent = document.getElementById('scenarioContent');
            const pointsText = choice.points > 0 ? `+${choice.points}` : `${choice.points}`;
            const pointsColor = choice.points > 0 ? 'text-green-300' : 'text-red-300';
            const isCorrectChoice = choice.isCorrect;
            
            let resultMessage = '';
            let resultIcon = '';
            let resultColor = '';
            
            if (isCorrectChoice && choice.points > 0) {
                resultMessage = 'Pilihan Tepat! Misi Berhasil!';
                resultIcon = 'üåü';
                resultColor = 'from-green-900/30 to-emerald-900/30 border-green-400/20';
            } else if (isCorrectChoice && choice.points <= 0) {
                resultMessage = 'Pilihan Benar, tapi bisa lebih baik!';
                resultIcon = '‚≠ê';
                resultColor = 'from-yellow-900/30 to-orange-900/30 border-yellow-400/20';
            } else {
                resultMessage = 'Pilihan Kurang Tepat';
                resultIcon = 'üòî';
                resultColor = 'from-red-900/30 to-pink-900/30 border-red-400/20';
            }
            
            scenarioContent.innerHTML = `
                <div class="bg-gradient-to-br ${resultColor} p-4 rounded-xl fade-slide-in">
                    <div class="text-center">
                        <span class="text-4xl mb-3 block">${resultIcon}</span>
                        <h4 class="font-bold text-cyan-300 mb-2">${resultMessage}</h4>
                        <p class="text-gray-200 mb-3">${choice.text}</p>
                        <div class="text-lg font-bold ${pointsColor} mb-2">
                            ${pointsText} Poin Kebaikan
                        </div>
                        ${missionCompleted ? '<div class="text-sm text-green-300 mb-3">üèÜ Misi Selesai!</div>' : ''}
                        <div class="flex flex-col sm:flex-row gap-3 mt-4">
                            <button onclick="continueToNextStory()" class="bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-500 hover:to-emerald-500 px-6 py-2 rounded-lg font-semibold panel-transition neon-glow">
                                üöÄ Lanjut Cerita Lain
                            </button>
                            <button onclick="backToMap()" class="bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-500 hover:to-indigo-500 px-6 py-2 rounded-lg font-semibold panel-transition neon-glow">
                                üó∫Ô∏è Kembali ke Peta
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Update mission panel to show completion
            if (missionCompleted) {
                const missionList = document.getElementById('missionList');
                missionList.innerHTML = `
                    <div class="bg-gradient-to-r from-green-900/30 to-emerald-900/30 p-3 rounded-lg border border-green-400/20">
                        <h4 class="font-semibold text-green-300 text-sm">üèÜ Misi Selesai!</h4>
                        <p class="text-xs text-gray-300 mt-1">Pilih lokasi lain untuk misi baru</p>
                        <div class="flex justify-between items-center mt-2">
                            <span class="text-xs text-green-300">Berhasil!</span>
                            <span class="text-xs bg-green-600 px-2 py-1 rounded">Selesai</span>
                        </div>
                    </div>
                `;
            }
        }

        // Continue to next story in same location
        function continueToNextStory() {
            if (gameState.currentLocation && scenarios[gameState.currentLocation]) {
                const locationScenarios = scenarios[gameState.currentLocation];
                const scenario = locationScenarios[Math.floor(Math.random() * locationScenarios.length)];
                showScenario(scenario);
            } else {
                // If no current location, show random scenario from all locations
                const allLocations = Object.keys(scenarios);
                const randomLocation = allLocations[Math.floor(Math.random() * allLocations.length)];
                const locationScenarios = scenarios[randomLocation];
                const scenario = locationScenarios[Math.floor(Math.random() * locationScenarios.length)];
                gameState.currentLocation = randomLocation;
                showScenario(scenario);
            }
        }

        // Back to map
        function backToMap() {
            // Auto-unlock panel when returning to map
            if (isPanelLocked) {
                togglePanelLock();
                showNotification('üîì Panel dibuka otomatis\nKamu kembali ke peta lokasi!');
            }
            
            const scenarioContent = document.getElementById('scenarioContent');
            scenarioContent.innerHTML = `
                <div class="bg-purple-900/30 p-4 rounded-xl border border-purple-400/20">
                    <p class="text-gray-200 mb-3">Pilih lokasi untuk melanjutkan petualangan kebaikan mu!</p>
                    <div class="text-center">
                        <span class="text-4xl">üåü</span>
                        <p class="text-sm text-purple-300 mt-2">Pilih lokasi untuk memulai misi</p>
                    </div>
                </div>
            `;
            
            // Reset mission panel
            const missionList = document.getElementById('missionList');
            missionList.innerHTML = `
                <div class="bg-gradient-to-r from-green-900/30 to-emerald-900/30 p-3 rounded-lg border border-green-400/20">
                    <h4 class="font-semibold text-green-300 text-sm">Misi Pemula</h4>
                    <p class="text-xs text-gray-300 mt-1">Pilih lokasi untuk memulai misi baru</p>
                    <div class="flex justify-between items-center mt-2">
                        <span class="text-xs text-purple-300">Hadiah: Bervariasi</span>
                        <span class="text-xs bg-blue-600 px-2 py-1 rounded">Siap</span>
                    </div>
                </div>
            `;
        }

        // Show math mode
        function showMathMode() {
            document.getElementById('storyMode').classList.add('hidden');
            document.getElementById('mathMode').classList.remove('hidden');
            document.getElementById('mathMode').classList.add('fade-slide-in');
            
            // Auto-lock panel when entering math mode
            if (!isPanelLocked) {
                setTimeout(() => {
                    togglePanelLock();
                    showNotification(`üîí Panel terkunci otomatis\nFokus pada Math Tutor!`);
                }, 500);
            }
        }

        // Hide math mode
        function hideMathMode() {
            // Auto-unlock panel when closing math mode
            if (isPanelLocked) {
                togglePanelLock();
                showNotification('üîì Panel dibuka otomatis\nKamu keluar dari Math Mode!');
            }
            
            document.getElementById('mathMode').classList.add('hidden');
            document.getElementById('mathQuestion').classList.add('hidden');
            document.getElementById('storyMode').classList.remove('hidden');
        }

        // Select math category
        function selectMathCategory(category) {
            gameState.currentMathCategory = category;
            const questions = mathQuestions[category];
            if (questions && questions.length > 0) {
                const question = questions[Math.floor(Math.random() * questions.length)];
                showMathQuestion(question);
            }
        }

        // Randomize answer options
        function randomizeAnswers(question) {
            const correctAnswer = question.options[question.correct];
            const shuffledOptions = [...question.options];
            
            // Fisher-Yates shuffle algorithm
            for (let i = shuffledOptions.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffledOptions[i], shuffledOptions[j]] = [shuffledOptions[j], shuffledOptions[i]];
            }
            
            // Find new correct index
            const newCorrectIndex = shuffledOptions.indexOf(correctAnswer);
            
            return {
                ...question,
                options: shuffledOptions,
                correct: newCorrectIndex
            };
        }

        // Show math question
        function showMathQuestion(question) {
            // Randomize the answer options
            const randomizedQuestion = randomizeAnswers(question);
            gameState.currentQuestion = randomizedQuestion;
            gameState.selectedAnswer = null;
            
            document.getElementById('questionTitle').textContent = `Soal ${gameState.currentMathCategory.charAt(0).toUpperCase() + gameState.currentMathCategory.slice(1)}`;
            document.getElementById('questionText').textContent = randomizedQuestion.question;
            
            const optionsContainer = document.getElementById('mathOptions');
            optionsContainer.innerHTML = randomizedQuestion.options.map((option, index) => `
                <button onclick="selectMathAnswer(${index})" class="math-option w-full text-left bg-gradient-to-r from-indigo-800/30 to-purple-800/30 hover:from-indigo-700/40 hover:to-purple-700/40 p-3 rounded-lg border border-indigo-400/20 hover:border-cyan-400/40 panel-transition" data-index="${index}">
                    ${String.fromCharCode(65 + index)}. ${option}
                </button>
            `).join('');
            
            document.getElementById('mathQuestion').classList.remove('hidden');
            document.getElementById('mathQuestion').classList.add('fade-slide-in');
        }

        // Select math answer
        function selectMathAnswer(index) {
            gameState.selectedAnswer = index;
            
            // Update visual selection
            document.querySelectorAll('.math-option').forEach((btn, i) => {
                if (i === index) {
                    btn.classList.add('border-cyan-400', 'bg-cyan-900/30');
                } else {
                    btn.classList.remove('border-cyan-400', 'bg-cyan-900/30');
                }
            });
        }

        // Submit math answer
        function submitMathAnswer() {
            if (gameState.selectedAnswer === null) {
                showNotification('‚ö†Ô∏è Pilih jawaban terlebih dahulu!');
                return;
            }
            
            const question = gameState.currentQuestion;
            const isCorrect = gameState.selectedAnswer === question.correct;
            
            if (isCorrect) {
                gameState.mathPoints += question.points;
                const oldSmartLevel = gameState.smartLevel;
                gameState.smartLevel = Math.floor(gameState.mathPoints / 20) + 1;
                
                // Add activity log
                addActivity(`üßÆ Soal benar: +${question.points} poin`);
                if (gameState.smartLevel > oldSmartLevel) {
                    addActivity(`üß† Smart Level up! ${oldSmartLevel} ‚Üí ${gameState.smartLevel}`);
                }
                
                // Track math correct answers for achievements
                if (!gameState.mathCorrectAnswers) gameState.mathCorrectAnswers = 0;
                gameState.mathCorrectAnswers++;
                
                // Check daily mission progress
                checkDailyMissionProgress('math_correct');
                
                // Check achievements
                checkAchievements();
                
                showNotification(`‚úÖ Benar!\n+${question.points} poin matematika\nSmart Level: ${gameState.smartLevel}`);
            } else {
                addActivity('‚ùå Soal salah');
                showNotification(`‚ùå Salah!\nJawaban yang benar: ${question.options[question.correct]}`);
            }
            
            updateUI();
            updateSidebarContent(); // Update sidebar with new stats
            saveGameState();
            document.getElementById('mathQuestion').classList.add('hidden');
        }

        // Save game state (internal function)
        function saveGameState() {
            try {
                // Add timestamp to save data
                gameState.lastSaved = new Date().toISOString();
                localStorage.setItem('heroKebaikanGame', JSON.stringify(gameState));
                showAutoSaveIndicator();
                return true;
            } catch (error) {
                console.error('Error saving game:', error);
                showAutoSaveNotification('‚ùå Error menyimpan game!');
                return false;
            }
        }

        // Manual save game
        function saveGameManual() {
            const success = saveGameState();
            if (success) {
                showSaveNotification('üíæ Game berhasil disimpan manual!', 'success');
                // Reset auto-save timer
                resetAutoSaveTimer();
            } else {
                showSaveNotification('‚ùå Gagal menyimpan game!', 'error');
            }
        }

        // Manual load game
        function loadGameManual() {
            try {
                const saved = localStorage.getItem('heroKebaikanGame');
                if (saved) {
                    const savedData = JSON.parse(saved);
                    
                    // Show confirmation dialog
                    const confirmLoad = confirm(`üîÑ Muat Game?\n\nData tersimpan:\nüìÖ ${new Date(savedData.lastSaved || Date.now()).toLocaleString('id-ID')}\n‚≠ê Level: ${savedData.playerLevel || 1}\nüíö Poin Kebaikan: ${savedData.kindnessPoints || 0}\nüß† Smart Level: ${savedData.smartLevel || 1}\n\nProgress saat ini akan hilang. Lanjutkan?`);
                    
                    if (confirmLoad) {
                        gameState = { ...gameState, ...savedData };
                        
                        // Refresh UI
                        updateUI();
                        updateLocationGrid();
                        updateMobileLocationGrid();
                        updateDailyMissionsUI();
                        checkUnlocks();
                        
                        // Reset panel state if needed
                        if (gameState.isPanelLocked && !isPanelLocked) {
                            togglePanelLock();
                        } else if (!gameState.isPanelLocked && isPanelLocked) {
                            togglePanelLock();
                        }
                        
                        showSaveNotification(`üíæ Game berhasil dimuat!\nTerakhir disimpan: ${new Date(savedData.lastSaved || Date.now()).toLocaleString('id-ID')}`, 'success');
                        
                        // Reset auto-save timer
                        resetAutoSaveTimer();
                    }
                } else {
                    showSaveNotification('‚ö†Ô∏è Tidak ada data tersimpan!', 'warning');
                }
            } catch (error) {
                console.error('Error loading game:', error);
                showSaveNotification('‚ùå Error memuat game!', 'error');
            }
        }

        // Reset game
        function resetGame() {
            const confirmReset = confirm(`üîÑ Reset Game?\n\n‚ö†Ô∏è PERINGATAN: Semua progress akan hilang!\n\nüìä Progress saat ini:\n‚≠ê Level: ${gameState.playerLevel}\nüíö Poin Kebaikan: ${gameState.kindnessPoints}\nüß† Smart Level: ${gameState.smartLevel}\nüèÜ Misi Selesai: ${gameState.completedMissions}\nüíé Collectibles: ${gameState.collectibles.length}\n\nYakin ingin reset dan mulai dari awal?`);
            
            if (confirmReset) {
                const doubleConfirm = confirm(`üö® KONFIRMASI TERAKHIR!\n\nSemua progress akan HILANG PERMANEN!\nTidak bisa dikembalikan!\n\nBenar-benar yakin reset game?`);
                
                if (doubleConfirm) {
                    // Clear localStorage
                    localStorage.removeItem('heroKebaikanGame');
                    
                    // Show reset notification
                    showSaveNotification('üîÑ Game direset! Halaman akan dimuat ulang...', 'warning');
                    
                    // Reload page after short delay
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                }
            }
        }

        // Show save/load notification with different types
        function showSaveNotification(message, type = 'success') {
            const colors = {
                success: 'bg-green-600/90',
                error: 'bg-red-600/90',
                warning: 'bg-yellow-600/90',
                info: 'bg-blue-600/90'
            };
            
            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            };
            
            const notification = document.createElement('div');
            notification.className = `fixed top-20 right-4 ${colors[type]} text-white px-4 py-3 rounded-lg z-50 fade-slide-in max-w-sm`;
            notification.innerHTML = `
                <div class="flex items-start gap-2">
                    <span class="text-lg">${icons[type]}</span>
                    <div class="text-sm whitespace-pre-line">${message}</div>
                </div>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, type === 'error' ? 5000 : 3000);
        }

        // Show auto-save notification
        function showAutoSaveNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'fixed bottom-4 right-4 bg-blue-600/90 text-white px-3 py-2 rounded-lg z-40 fade-slide-in text-sm max-w-xs';
            notification.innerHTML = `
                <div class="flex items-start gap-2">
                    <span class="text-sm">üíæ</span>
                    <div class="text-xs whitespace-pre-line">${message}</div>
                </div>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Show auto-save indicator
        function showAutoSaveIndicator() {
            const indicator = document.getElementById('autoSaveIndicator');
            indicator.textContent = '‚úÖ';
            indicator.className = 'text-xs text-green-300';
            
            setTimeout(() => {
                indicator.textContent = 'üîÑ';
                indicator.className = 'text-xs';
            }, 1000);
        }

        // Update auto-save timer display
        function updateAutoSaveTimer() {
            const timerElement = document.getElementById('autoSaveTimer');
            if (timerElement) {
                timerElement.textContent = `${autoSaveTimer}s`;
                
                // Change color based on time remaining
                if (autoSaveTimer <= 5) {
                    timerElement.className = 'hidden md:inline text-xs ml-1 text-red-300';
                } else if (autoSaveTimer <= 10) {
                    timerElement.className = 'hidden md:inline text-xs ml-1 text-yellow-300';
                } else {
                    timerElement.className = 'hidden md:inline text-xs ml-1';
                }
            }
        }

        // Reset auto-save timer
        function resetAutoSaveTimer() {
            autoSaveTimer = 30;
            updateAutoSaveTimer();
        }

        // Auto-save with countdown timer
        function startAutoSave() {
            // Clear existing intervals
            if (autoSaveInterval) clearInterval(autoSaveInterval);
            if (autoSaveCountdown) clearInterval(autoSaveCountdown);
            
            // Auto-save every 30 seconds
            autoSaveInterval = setInterval(() => {
                const success = saveGameState();
                if (success) {
                    showAutoSaveNotification('üíæ Auto-save berhasil!\nProgress tersimpan otomatis.');
                }
                resetAutoSaveTimer();
            }, 30000);
            
            // Countdown timer (updates every second)
            autoSaveCountdown = setInterval(() => {
                autoSaveTimer--;
                updateAutoSaveTimer();
                
                if (autoSaveTimer <= 0) {
                    autoSaveTimer = 30;
                }
            }, 1000);
            
            // Initialize timer display
            updateAutoSaveTimer();
            
            // Save when user leaves the page
            window.addEventListener('beforeunload', () => {
                saveGameState();
            });
            
            // Save when user switches tabs
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    saveGameState();
                }
            });
            
            // Save when window loses focus
            window.addEventListener('blur', () => {
                saveGameState();
            });
        }

        // Load game state
        function loadGameState() {
            try {
                const saved = localStorage.getItem('heroKebaikanGame');
                if (saved) {
                    const savedData = JSON.parse(saved);
                    gameState = { ...gameState, ...savedData };
                    
                    // Show load notification with timestamp
                    if (savedData.lastSaved) {
                        const lastSaved = new Date(savedData.lastSaved);
                        showAutoSaveNotification(`üíæ Game dimuat!\nTerakhir disimpan: ${lastSaved.toLocaleString('id-ID')}`);
                    } else {
                        showAutoSaveNotification('üíæ Game dimuat!\nProgress berhasil dipulihkan.');
                    }
                    
                    return false; // Not a new player
                } else {
                    // New player
                    showAutoSaveNotification('üåü Pemain baru terdeteksi!\nSelamat datang di Hero Kebaikan!');
                    return true; // New player
                }
            } catch (error) {
                console.error('Error loading game:', error);
                showAutoSaveNotification('‚ö†Ô∏è Error loading game, starting fresh.');
                return true; // Treat as new player if error
            }
        }

        // Tutorial functions
        function showTutorial() {
            currentTutorialStep = 0;
            document.getElementById('tutorialModal').classList.remove('hidden');
            updateTutorialContent();
        }

        function closeTutorial() {
            document.getElementById('tutorialModal').classList.add('hidden');
            gameState.hasSeenTutorial = true;
            saveGameState();
        }

        function updateTutorialContent() {
            const step = tutorialSteps[currentTutorialStep];
            document.getElementById('tutorialContent').innerHTML = `
                <div class="bg-purple-900/30 p-6 rounded-xl border border-purple-400/20 fade-slide-in ${step.animation || ''}">
                    <h3 class="orbitron text-xl font-bold mb-4 text-cyan-300 ${step.animation || ''}">${step.title}</h3>
                    ${step.content}
                </div>
            `;
            
            document.getElementById('tutorialProgress').textContent = `${currentTutorialStep + 1} / ${tutorialSteps.length}`;
            
            // Update navigation buttons
            const prevBtn = document.getElementById('prevTutorialBtn');
            const nextBtn = document.getElementById('nextTutorialBtn');
            
            prevBtn.disabled = currentTutorialStep === 0;
            prevBtn.className = currentTutorialStep === 0 
                ? 'bg-gray-600/30 px-4 py-2 rounded-lg panel-transition opacity-50 cursor-not-allowed'
                : 'bg-gray-600/50 hover:bg-gray-500/60 px-4 py-2 rounded-lg panel-transition';
            
            if (currentTutorialStep === tutorialSteps.length - 1) {
                nextBtn.textContent = 'Mulai Bermain! üöÄ';
                nextBtn.className = 'bg-green-600/50 hover:bg-green-500/60 px-4 py-2 rounded-lg panel-transition';
            } else {
                nextBtn.textContent = 'Selanjutnya ‚û°Ô∏è';
                nextBtn.className = 'bg-purple-600/50 hover:bg-purple-500/60 px-4 py-2 rounded-lg panel-transition';
            }
        }

        function nextTutorialStep() {
            if (currentTutorialStep < tutorialSteps.length - 1) {
                currentTutorialStep++;
                updateTutorialContent();
            } else {
                closeTutorial();
            }
        }

        function prevTutorialStep() {
            if (currentTutorialStep > 0) {
                currentTutorialStep--;
                updateTutorialContent();
            }
        }

        // Game info functions
        function showGameInfo() {
            document.getElementById('gameInfoModal').classList.remove('hidden');
        }

        function closeGameInfo() {
            document.getElementById('gameInfoModal').classList.add('hidden');
        }

        // Check if first time player
        function checkFirstTimePlayer() {
            if (!gameState.hasSeenTutorial) {
                setTimeout(() => {
                    showTutorial();
                }, 1000); // Show tutorial after 1 second
            }
        }

        // Mini Game functions
        function showMiniGame() {
            document.getElementById('miniGameModal').classList.remove('hidden');
            startNewMiniGame();
            
            // Auto-lock panel when entering mini game
            if (!isPanelLocked) {
                setTimeout(() => {
                    togglePanelLock();
                    showNotification(`üîí Panel terkunci otomatis\nFokus pada Mini Game!`);
                }, 500);
            }
        }

        function closeMiniGame() {
            document.getElementById('miniGameModal').classList.add('hidden');
            currentMiniGame = null;
            miniGameProgress = [];
            selectedLetters = [];
        }

        function startNewMiniGame() {
            const randomWord = miniGameWords[Math.floor(Math.random() * miniGameWords.length)];
            currentMiniGame = { ...randomWord }; // Create a copy
            
            // Initialize progress array with proper spaces
            const phrase = randomWord.phrase;
            miniGameProgress = new Array(phrase.length).fill('');
            for (let i = 0; i < phrase.length; i++) {
                if (phrase[i] === ' ') {
                    miniGameProgress[i] = ' ';
                }
            }
            selectedLetters = [];
            
            // Reset game letters
            currentMiniGame.gameLetters = null;
            
            updateMiniGameUI();
        }

        function updateMiniGameUI() {
            if (!currentMiniGame) return;
            
            const content = document.getElementById('miniGameContent');
            const phrase = currentMiniGame.phrase;
            const letters = phrase.replace(/\s/g, '').split('');
            const shuffledLetters = [...letters].sort(() => Math.random() - 0.5);
            
            // Add some extra random letters to make it challenging
            const extraLetters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('').filter(l => !letters.includes(l));
            const randomExtras = extraLetters.sort(() => Math.random() - 0.5).slice(0, Math.min(3, extraLetters.length));
            const allLetters = [...shuffledLetters, ...randomExtras].sort(() => Math.random() - 0.5);
            
            // Store letters for reference
            if (!currentMiniGame.gameLetters) {
                currentMiniGame.gameLetters = allLetters;
            }
            
            content.innerHTML = `
                <div class="text-center mb-6">
                    <div class="bg-gradient-to-r from-teal-900/30 to-cyan-900/30 p-4 rounded-xl border border-teal-400/20 mb-4">
                        <h3 class="font-bold text-teal-300 mb-3 text-lg">üìù ${currentMiniGame.category}</h3>
                        <div class="bg-yellow-900/30 p-3 rounded-lg border border-yellow-400/20 mb-3">
                            <p class="text-yellow-300 font-semibold text-base mb-1">üí° PETUNJUK:</p>
                            <p class="text-yellow-100 text-lg">${currentMiniGame.hint}</p>
                        </div>
                        <div class="text-sm text-teal-300 bg-teal-900/30 p-2 rounded">
                            üéÅ Hadiah: +${currentMiniGame.reward.points} poin + ${collectiblesData[currentMiniGame.reward.item]?.icon || 'üéÅ'} ${collectiblesData[currentMiniGame.reward.item]?.name || 'Item'}
                        </div>
                    </div>
                </div>
                
                <!-- Word Display -->
                <div class="mb-6">
                    <h4 class="text-center text-cyan-300 font-bold mb-4 text-lg">üéØ Susun Kata/Slogan:</h4>
                    <div class="flex flex-wrap justify-center gap-2 mb-4">
                        ${phrase.split('').map((char, index) => {
                            if (char === ' ') {
                                return `<div class="w-4 h-14"></div>`; // Space between words
                            }
                            const isCompleted = miniGameProgress[index] && miniGameProgress[index] !== '' && miniGameProgress[index] !== ' ';
                            const isFirstLetter = index === 0 || (index > 0 && phrase[index - 1] === ' ');
                            const shouldShowHint = isFirstLetter && currentMiniGame.firstLetter && !isCompleted;
                            
                            return `
                                <div class="word-slot ${isCompleted ? 'filled' : ''} w-14 h-14 bg-gray-800/50 border-2 ${isCompleted ? 'border-green-400/50 bg-green-900/30' : 'border-cyan-400/30'} rounded-lg flex items-center justify-center text-white font-bold text-xl transition-all duration-300 relative">
                                    ${miniGameProgress[index] === ' ' ? '' : (miniGameProgress[index] || '')}
                                    ${shouldShowHint ? `<div class="absolute -bottom-6 text-xs text-yellow-300 font-normal">üí°${currentMiniGame.firstLetter}</div>` : ''}
                                </div>
                            `;
                        }).join('')}
                    </div>
                    <div class="text-center text-sm text-gray-400 mb-2">
                        üí° Huruf pertama setiap kata sudah diberi petunjuk di bawah kotak
                    </div>
                </div>
                
                <!-- Letter Buttons -->
                <div class="mb-6">
                    <h4 class="text-center text-purple-300 font-bold mb-3 text-lg">üî§ Pilih Huruf:</h4>
                    <div class="grid grid-cols-6 md:grid-cols-8 gap-2">
                        ${currentMiniGame.gameLetters.map((letter, index) => {
                            const isUsed = selectedLetters.includes(index);
                            return `
                                <button onclick="selectLetter('${letter}', ${index})" 
                                        class="letter-button w-14 h-14 bg-gradient-to-br ${isUsed ? 'from-green-700/50 to-emerald-800/50' : 'from-purple-700/50 to-indigo-800/50 hover:from-purple-600/60 hover:to-indigo-700/60'} border border-purple-400/30 rounded-lg text-white font-bold text-xl transition-all duration-300"
                                        ${isUsed ? 'disabled' : ''}>
                                    ${letter}
                                </button>
                            `;
                        }).join('')}
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="flex flex-col sm:flex-row gap-3 justify-center">
                    <button onclick="clearMiniGame()" class="bg-gradient-to-r from-red-600/50 to-pink-600/50 hover:from-red-500/60 hover:to-pink-500/60 px-6 py-3 rounded-lg font-semibold panel-transition">
                        üóëÔ∏è Hapus Semua
                    </button>
                    <button onclick="checkMiniGameAnswer()" class="bg-gradient-to-r from-green-600/50 to-emerald-600/50 hover:from-green-500/60 hover:to-emerald-500/60 px-6 py-3 rounded-lg font-semibold panel-transition">
                        ‚úÖ Periksa Jawaban
                    </button>
                    <button onclick="startNewMiniGame()" class="bg-gradient-to-r from-blue-600/50 to-cyan-600/50 hover:from-blue-500/60 hover:to-cyan-500/60 px-6 py-3 rounded-lg font-semibold panel-transition">
                        üîÑ Kata Baru
                    </button>
                </div>
            `;
        }

        function selectLetter(letter, buttonIndex) {
            if (selectedLetters.includes(buttonIndex)) return;
            
            const phrase = currentMiniGame.phrase;
            
            // Find next empty slot (skip spaces)
            let targetIndex = -1;
            for (let i = 0; i < phrase.length; i++) {
                if (phrase[i] === ' ') {
                    continue; // Skip spaces
                }
                if (miniGameProgress[i] === '' || miniGameProgress[i] === undefined) {
                    targetIndex = i;
                    break;
                }
            }
            
            if (targetIndex === -1) return; // All slots filled
            
            miniGameProgress[targetIndex] = letter;
            selectedLetters.push(buttonIndex);
            
            updateMiniGameUI();
        }

        function clearMiniGame() {
            const phrase = currentMiniGame.phrase;
            miniGameProgress = new Array(phrase.length).fill('');
            // Initialize spaces properly
            for (let i = 0; i < phrase.length; i++) {
                if (phrase[i] === ' ') {
                    miniGameProgress[i] = ' ';
                }
            }
            selectedLetters = [];
            
            // Force UI update by regenerating the content
            updateMiniGameUI();
        }

        function checkMiniGameAnswer() {
            const userAnswer = miniGameProgress.join('');
            const correctAnswer = currentMiniGame.phrase;
            
            if (userAnswer === correctAnswer) {
                // Correct answer
                gameState.kindnessPoints += currentMiniGame.reward.points;
                
                if (!gameState.collectibles.includes(currentMiniGame.reward.item)) {
                    gameState.collectibles.push(currentMiniGame.reward.item);
                }
                
                // Track mini game completion for achievements
                if (!gameState.miniGamesCompleted) gameState.miniGamesCompleted = 0;
                gameState.miniGamesCompleted++;
                
                checkAchievements();
                updateUI();
                
                // AUTO-SAVE: Save after mini game win
                saveGameState();
                showAutoSaveNotification('üíæ Mini game selesai! Progress tersimpan otomatis.');
                
                showNotification(`üéâ Benar!\n"${currentMiniGame.phrase}"\n+${currentMiniGame.reward.points} poin + ${collectiblesData[currentMiniGame.reward.item]?.icon || 'üéÅ'} ${collectiblesData[currentMiniGame.reward.item]?.name || 'Item'}`);
                
                // Show success animation
                const content = document.getElementById('miniGameContent');
                content.innerHTML = `
                    <div class="text-center">
                        <div class="text-6xl mb-4 emoji-bounce">üéâ</div>
                        <h3 class="text-2xl font-bold text-green-300 mb-2">Selamat!</h3>
                        <p class="text-lg text-cyan-300 mb-4">"${currentMiniGame.phrase}"</p>
                        <p class="text-gray-300 mb-4">${currentMiniGame.hint}</p>
                        <div class="bg-green-900/30 p-4 rounded-xl border border-green-400/20 mb-4">
                            <p class="text-green-300">üéÅ Hadiah: +${currentMiniGame.reward.points} poin kebaikan</p>
                            <p class="text-green-300">üíé Item: ${collectiblesData[currentMiniGame.reward.item]?.icon || 'üéÅ'} ${collectiblesData[currentMiniGame.reward.item]?.name || 'Item'}</p>
                        </div>
                        <button onclick="startNewMiniGame()" class="bg-gradient-to-r from-blue-600/50 to-cyan-600/50 hover:from-blue-500/60 hover:to-cyan-500/60 px-6 py-2 rounded-lg font-semibold panel-transition">
                            üöÄ Main Lagi
                        </button>
                    </div>
                `;
            } else {
                // Wrong answer - still save progress
                saveGameState();
                showAutoSaveNotification('üíæ Progress tersimpan meski jawaban belum benar.');
                
                showNotification(`‚ùå Belum benar!\nCoba lagi atau gunakan petunjuk.`);
                
                // Add shake animation to wrong letters
                document.querySelectorAll('.letter-button.selected').forEach(btn => {
                    btn.classList.add('wrong');
                    setTimeout(() => btn.classList.remove('wrong'), 500);
                });
            }
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // ESC key to unlock panel or close sidebar
            if (e.key === 'Escape') {
                if (gameState.isSidebarOpen) {
                    toggleSidebar();
                } else if (isPanelLocked) {
                    togglePanelLock();
                }
            }
            
            // Ctrl/Cmd + B to toggle sidebar
            if ((e.ctrlKey || e.metaKey) && e.key === 'b') {
                e.preventDefault();
                toggleSidebar();
            }
            
            // Ctrl/Cmd + L to toggle panel lock
            if ((e.ctrlKey || e.metaKey) && e.key === 'l') {
                e.preventDefault();
                togglePanelLock();
            }
            
            // Ctrl/Cmd + S to save game manually
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                saveGameManual();
            }
            
            // Ctrl/Cmd + O to load game manually
            if ((e.ctrlKey || e.metaKey) && e.key === 'o') {
                e.preventDefault();
                loadGameManual();
            }
            
            // Ctrl/Cmd + R to reset game (with additional confirmation)
            if ((e.ctrlKey || e.metaKey) && e.key === 'r' && e.shiftKey) {
                e.preventDefault();
                resetGame();
            }
            
            // M key to toggle mobile map (mobile only)
            if (e.key === 'm' || e.key === 'M') {
                if (window.innerWidth < 768) {
                    toggleMobileMap();
                }
            }
            
            // Tab key to toggle sidebar (alternative)
            if (e.key === 'Tab' && e.altKey) {
                e.preventDefault();
                toggleSidebar();
            }
        });

        // Initialize game when page loads
        document.addEventListener('DOMContentLoaded', () => {
            initGame();
            checkFirstTimePlayer();
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96e868b1f3543e02',t:'MTc1NTA5MDE2OS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
