<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hero Kebaikan - Petualangan Anti-Bullying</title>
    
    <!-- Favicon Hero Emoji -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ü¶∏‚Äç‚ôÄÔ∏è</text></svg>">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    screens: {
                        'xs': '475px',
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka+One:wght@400&family=Comic+Neue:wght@400;700&display=swap');
        
        body {
            font-family: 'Comic Neue', cursive;
        }
        
        .game-title {
            font-family: 'Fredoka One', cursive;
        }
        
        .bounce-in {
            animation: bounceIn 0.8s ease-out;
        }
        
        @keyframes bounceIn {
            0% { transform: scale(0.3) rotate(-10deg); opacity: 0; }
            50% { transform: scale(1.1) rotate(5deg); }
            70% { transform: scale(0.9) rotate(-2deg); }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }
        
        .float {
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        .pulse-glow {
            animation: pulseGlow 2s infinite;
        }
        
        @keyframes pulseGlow {
            0%, 100% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.6); }
            50% { box-shadow: 0 0 40px rgba(255, 215, 0, 1); }
        }
        
        .shake {
            animation: shake 0.5s ease-in-out;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        .level-up {
            animation: levelUp 1s ease-out;
        }
        
        @keyframes levelUp {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        .mission-complete {
            animation: missionComplete 0.8s ease-out;
        }
        
        @keyframes missionComplete {
            0% { transform: scale(0.8) rotate(-5deg); opacity: 0; }
            50% { transform: scale(1.1) rotate(2deg); }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }
        
        .fade-out {
            animation: fadeOut 0.5s ease-out forwards;
        }
        
        @keyframes fadeOut {
            0% { opacity: 1; transform: scale(1); }
            100% { opacity: 0; transform: scale(0.95); }
        }
        
        .fade-in {
            animation: fadeIn 0.6s ease-out forwards;
        }
        
        @keyframes fadeIn {
            0% { opacity: 0; transform: scale(1.05); }
            100% { opacity: 1; transform: scale(1); }
        }
        
        .slide-in-left {
            animation: slideInLeft 0.8s ease-out;
        }
        
        @keyframes slideInLeft {
            0% { transform: translateX(-100%); opacity: 0; }
            100% { transform: translateX(0); opacity: 1; }
        }
        
        .slide-in-right {
            animation: slideInRight 0.8s ease-out;
        }
        
        @keyframes slideInRight {
            0% { transform: translateX(100%); opacity: 0; }
            100% { transform: translateX(0); opacity: 1; }
        }
        
        .slide-in-up {
            animation: slideInUp 0.8s ease-out;
        }
        
        @keyframes slideInUp {
            0% { transform: translateY(50px); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }
        
        .location-transition {
            position: relative;
            overflow: hidden;
        }
        
        .location-transition::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.8), transparent);
            transition: left 0.8s ease-out;
            z-index: 10;
        }
        
        .location-transition.transitioning::before {
            left: 100%;
        }
        
        .mission-card {
            transition: all 0.3s ease;
        }
        
        .mission-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .mission-completed {
            background: linear-gradient(135deg, #10B981, #059669);
            color: white;
        }
        
        .mission-locked {
            opacity: 0.6;
            filter: grayscale(50%);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-400 via-pink-300 to-blue-400 min-h-screen">
    <!-- Game Header -->
    <div class="fixed top-0 w-full z-50 bg-gradient-to-r from-yellow-400 to-orange-400 p-3 md:p-4 shadow-lg">
        <div class="max-w-6xl mx-auto">
            <!-- Mobile Header -->
            <div class="flex flex-col space-y-3 md:hidden">
                <div class="flex justify-between items-center">
                    <h1 class="game-title text-xl text-white drop-shadow-lg">ü¶∏‚Äç‚ôÄÔ∏è HERO KEBAIKAN</h1>
                    <div class="flex space-x-2">
                        <button id="infoBtn" class="bg-white hover:bg-gray-100 text-purple-600 font-bold py-2 px-3 rounded-full shadow-lg transform hover:scale-105 transition-all duration-300">
                            <span class="text-base">‚ÑπÔ∏è</span>
                        </button>
                        <button id="saveMenuBtn" class="bg-white hover:bg-gray-100 text-purple-600 font-bold py-2 px-3 rounded-full shadow-lg transform hover:scale-105 transition-all duration-300">
                            <span class="text-base">üíæ</span>
                        </button>
                    </div>
                </div>
                
                <!-- Mobile Stats -->
                <div class="grid grid-cols-2 gap-2 mb-2">
                    <div class="bg-white rounded-full px-2 py-1 shadow-lg text-center">
                        <span class="text-xs font-bold text-purple-600">Lv: </span>
                        <span id="playerLevel" class="text-sm font-bold text-green-600">1</span>
                    </div>
                    <div class="bg-white rounded-full px-2 py-1 shadow-lg text-center">
                        <span class="text-xs font-bold text-purple-600">üíñ </span>
                        <span id="kindnessPoints" class="text-sm font-bold text-red-500">0</span>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <div class="bg-white rounded-full px-2 py-1 shadow-lg text-center">
                        <span class="text-xs font-bold text-purple-600">üß† </span>
                        <span id="intelligenceLevel" class="text-sm font-bold text-blue-600">1</span>
                    </div>
                    <div class="bg-white rounded-full px-2 py-1 shadow-lg text-center">
                        <span class="text-xs font-bold text-purple-600">üìä </span>
                        <span id="mathPoints" class="text-sm font-bold text-indigo-600">0</span>
                    </div>
                </div>
            </div>
            
            <!-- Desktop Header -->
            <div class="hidden md:flex justify-between items-center">
                <h1 class="game-title text-2xl lg:text-3xl text-white drop-shadow-lg">ü¶∏‚Äç‚ôÄÔ∏è HERO KEBAIKAN ü¶∏‚Äç‚ôÇÔ∏è</h1>
                
                <!-- Desktop Stats -->
                <div class="flex space-x-2 lg:space-x-3 items-center">
                    <div class="bg-white rounded-full px-2 lg:px-3 py-2 shadow-lg">
                        <span class="text-xs lg:text-sm font-bold text-purple-600">Lv: </span>
                        <span id="playerLevelDesktop" class="text-sm lg:text-lg font-bold text-green-600">1</span>
                    </div>
                    <div class="bg-white rounded-full px-2 lg:px-3 py-2 shadow-lg">
                        <span class="text-xs lg:text-sm font-bold text-purple-600">üíñ </span>
                        <span id="kindnessPointsDesktop" class="text-sm lg:text-lg font-bold text-red-500">0</span>
                    </div>
                    <div class="bg-white rounded-full px-2 lg:px-3 py-2 shadow-lg">
                        <span class="text-xs lg:text-sm font-bold text-purple-600">üß† </span>
                        <span id="intelligenceLevelDesktop" class="text-sm lg:text-lg font-bold text-blue-600">1</span>
                    </div>
                    <div class="bg-white rounded-full px-2 lg:px-3 py-2 shadow-lg">
                        <span class="text-xs lg:text-sm font-bold text-purple-600">üìä </span>
                        <span id="mathPointsDesktop" class="text-sm lg:text-lg font-bold text-indigo-600">0</span>
                    </div>
                    
                    <!-- Info and Save Menu Buttons -->
                    <button id="infoBtnDesktop" class="bg-white hover:bg-gray-100 text-purple-600 font-bold py-2 px-4 rounded-full shadow-lg transform hover:scale-105 transition-all duration-300 mr-2">
                        <span class="text-lg">‚ÑπÔ∏è</span>
                        <span class="text-sm ml-1">Info</span>
                    </button>
                    <button id="saveMenuBtnDesktop" class="bg-white hover:bg-gray-100 text-purple-600 font-bold py-2 px-4 rounded-full shadow-lg transform hover:scale-105 transition-all duration-300">
                        <span class="text-lg">üíæ</span>
                        <span class="text-sm ml-1">Save</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="SIZEX" class="h-[160px]"></div>
    
    <div class="max-w-6xl mx-auto p-4">
        <!-- Game World Map -->
        <div class="bg-gradient-to-b from-sky-200 to-green-200 rounded-2xl md:rounded-3xl p-4 md:p-6 mb-4 md:mb-6 shadow-2xl relative overflow-hidden">
            <h2 class="text-xl md:text-2xl font-bold text-center text-purple-800 mb-4">üó∫Ô∏è Peta Petualangan Kebaikan</h2>
            
            <!-- Location Buttons -->
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 md:gap-4 mb-4 md:mb-6">
                <button id="schoolBtn" class="location-btn bg-red-400 hover:bg-red-500 text-white font-bold py-4 md:py-6 px-4 rounded-xl md:rounded-2xl shadow-lg transform hover:scale-105 transition-all duration-300 active:scale-95">
                    <div class="text-3xl md:text-4xl mb-2">üè´</div>
                    <div class="text-base md:text-lg">Sekolah</div>
                    <div class="text-xs opacity-80">8 Misi Tersedia</div>
                </button>
                
                <button id="playgroundBtn" class="location-btn bg-green-400 hover:bg-green-500 text-white font-bold py-4 md:py-6 px-4 rounded-xl md:rounded-2xl shadow-lg transform hover:scale-105 transition-all duration-300 active:scale-95">
                    <div class="text-3xl md:text-4xl mb-2">üå≥</div>
                    <div class="text-base md:text-lg">Taman</div>
                    <div class="text-xs opacity-80">6 Misi Tersedia</div>
                </button>
                
                <button id="classroomBtn" class="location-btn bg-blue-400 hover:bg-blue-500 text-white font-bold py-4 md:py-6 px-4 rounded-xl md:rounded-2xl shadow-lg transform hover:scale-105 transition-all duration-300 active:scale-95">
                    <div class="text-3xl md:text-4xl mb-2">üìö</div>
                    <div class="text-base md:text-lg">Ruang Kelas</div>
                    <div class="text-xs opacity-80">7 Misi Tersedia</div>
                </button>
                
                <button id="mathTutorBtn" class="location-btn bg-gradient-to-b from-indigo-500 to-purple-600 hover:from-indigo-600 hover:to-purple-700 text-white font-bold py-4 md:py-6 px-4 rounded-xl md:rounded-2xl shadow-lg transform hover:scale-105 transition-all duration-300 active:scale-95">
                    <div class="text-3xl md:text-4xl mb-2">üßÆ</div>
                    <div class="text-base md:text-lg">Math Tutor</div>
                    <div class="text-xs opacity-80">Bantu Teman Belajar</div>
                </button>
            </div>
        </div>

        <!-- Current Scene -->
        <div id="gameScene" class="bg-white rounded-2xl md:rounded-3xl p-4 md:p-8 mb-4 md:mb-6 shadow-2xl location-transition">
            <div id="sceneContent">
                <!-- Default Welcome Scene -->
                <div class="text-center">
                    <div class="text-6xl md:text-8xl mb-4 float">üåü</div>
                    <h3 class="text-xl md:text-3xl font-bold text-purple-800 mb-4">Selamat Datang, Hero Kebaikan!</h3>
                    <p class="text-base md:text-lg text-gray-700 mb-6 px-2">Pilih lokasi untuk memulai petualangan dan membantu teman-teman yang membutuhkan!</p>
                    
                    <!-- Hero Character -->
                    <div class="flex justify-center space-x-4 md:space-x-8 mb-6">
                        <div class="text-center">
                            <div class="text-4xl md:text-6xl mb-2">üòä</div>
                            <div class="bg-purple-500 text-white px-3 py-1 rounded-full text-xs md:text-sm font-bold">KAMU</div>
                            <div class="text-xs text-purple-600 mt-1">Hero Kebaikan Level 1</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sound Effects (Web Audio API) -->
        <div id="soundEffects" class="hidden">
            <!-- Sound effects will be generated programmatically -->
        </div>

        <!-- Action Panel -->
        <div id="actionPanel" class="bg-gradient-to-r from-purple-500 to-pink-500 rounded-2xl md:rounded-3xl p-4 md:p-6 shadow-2xl hidden">
            <h3 class="text-lg md:text-2xl font-bold text-white text-center mb-4 md:mb-6">‚ö° Panel Aksi Hero</h3>
            <div id="actionButtons" class="grid grid-cols-1 xs:grid-cols-2 lg:grid-cols-4 gap-3 md:gap-4">
                <!-- Action buttons will be dynamically added here -->
            </div>
        </div>

        <!-- Mission Panel -->
        <div class="bg-gradient-to-r from-yellow-400 to-orange-400 rounded-2xl md:rounded-3xl p-4 md:p-6 mt-4 md:mt-6 shadow-2xl">
            <h3 class="text-lg md:text-2xl font-bold text-white text-center mb-4 md:mb-6">üéØ Misi Hero Kebaikan</h3>
            
            <div id="activeMissions" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3 md:gap-4">
                <!-- Missions will be dynamically generated -->
            </div>
        </div>

        <!-- Level Up Panel -->
        <div id="levelUpPanel" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
            <div class="bg-gradient-to-r from-yellow-400 to-orange-400 rounded-3xl p-8 shadow-2xl max-w-md mx-4 text-center">
                <div class="text-8xl mb-4">üéâ</div>
                <h3 class="text-3xl font-bold text-white mb-4">LEVEL UP!</h3>
                <p class="text-lg text-white mb-6">Selamat! Empati kamu meningkat!</p>
                <div id="levelUpReward" class="bg-white rounded-2xl p-4 mb-6">
                    <!-- Reward content will be added here -->
                </div>
                <button id="closeLevelUp" class="bg-white text-orange-600 font-bold py-3 px-8 rounded-full shadow-lg hover:bg-gray-100 transform hover:scale-105 transition-all duration-300">
                    Lanjutkan Petualangan! üöÄ
                </button>
            </div>
        </div>

        <!-- Info Panel -->
        <div id="infoPanel" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
            <div class="bg-gradient-to-r from-blue-500 to-purple-600 rounded-2xl md:rounded-3xl p-4 md:p-8 shadow-2xl max-w-lg w-full max-h-screen overflow-y-auto">
                <div class="text-center mb-4 md:mb-6">
                    <div class="text-4xl md:text-6xl mb-2 md:mb-4">‚ÑπÔ∏è</div>
                    <h3 class="text-xl md:text-3xl font-bold text-white mb-2">Informasi Game</h3>
                    <p class="text-sm md:text-base text-white opacity-90">Hero Kebaikan - Petualangan Anti-Bullying</p>
                </div>

                <!-- Game Info -->
                <div class="bg-white rounded-xl md:rounded-2xl p-3 md:p-4 mb-4 md:mb-6">
                    <h4 class="font-bold text-purple-800 mb-3 text-sm md:text-base">üéÆ Tentang Game</h4>
                    <div class="text-xs md:text-sm text-gray-700 space-y-2">
                        <p>Game edukasi interaktif yang mengajarkan nilai-nilai kebaikan dan empati untuk melawan bullying.</p>
                        <p>Pemain berperan sebagai Hero Kebaikan yang membantu teman-teman dalam berbagai situasi di sekolah.</p>
                    </div>
                </div>

                <!-- Developer Info -->
                <div class="bg-white rounded-xl md:rounded-2xl p-3 md:p-4 mb-4 md:mb-6">
                    <h4 class="font-bold text-purple-800 mb-3 text-sm md:text-base">üë• Tim Pengembang</h4>
                    <div class="text-center mb-4">
                        <div class="text-2xl md:text-3xl font-bold text-purple-600 mb-2">Kelas 9B Kelompok 2</div>
                        <div class="text-xs md:text-sm text-gray-600">Proyek Game Edukasi Anti-Bullying</div>
                        <div class="text-xs text-gray-500 mt-1">SMPN 20 Surakarta</div>
                    </div>
                    
                    <!-- Member Table -->
                    <div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg p-3">
                        <h5 class="font-bold text-purple-700 mb-2 text-xs md:text-sm text-center">üåü Anggota Kelompok</h5>
                        <div class="grid grid-cols-2 gap-2 text-xs md:text-sm">
                            <div class="bg-white rounded-lg p-2 text-center shadow-sm">
                                <div class="text-purple-600 font-bold">üë®‚Äçüíª Keanu</div>
                            </div>
                            <div class="bg-white rounded-lg p-2 text-center shadow-sm">
                                <div class="text-purple-600 font-bold">üë®‚Äçüíª Rafa</div>
                            </div>
                            <div class="bg-white rounded-lg p-2 text-center shadow-sm">
                                <div class="text-purple-600 font-bold">üë©‚Äçüíª Salsabila</div>
                            </div>
                            <div class="bg-white rounded-lg p-2 text-center shadow-sm">
                                <div class="text-purple-600 font-bold">üë©‚Äçüíª Nadinda</div>
                            </div>
                            <div class="bg-white rounded-lg p-2 text-center shadow-sm">
                                <div class="text-purple-600 font-bold">üë©‚Äçüíª Aura</div>
                            </div>
                            <div class="bg-white rounded-lg p-2 text-center shadow-sm">
                                <div class="text-purple-600 font-bold">üë©‚Äçüíª Nabila</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Game Features -->
                <div class="bg-white rounded-xl md:rounded-2xl p-3 md:p-4 mb-4 md:mb-6">
                    <h4 class="font-bold text-purple-800 mb-3 text-sm md:text-base">‚ú® Fitur Game</h4>
                    <div class="text-xs md:text-sm text-gray-700 space-y-1">
                        <div>‚Ä¢ üéØ Sistem misi yang dinamis dan otomatis</div>
                        <div>‚Ä¢ üè´ 3 lokasi petualangan (Sekolah, Taman, Ruang Kelas)</div>
                        <div>‚Ä¢ üßÆ Mode Tutor Matematika SMP interaktif</div>
                        <div>‚Ä¢ üß† Sistem level kepintaran dan poin matematika</div>
                        <div>‚Ä¢ üìà Dual progress tracking (Kebaikan & Matematika)</div>
                        <div>‚Ä¢ üíæ Auto-save dan manual save system</div>
                        <div>‚Ä¢ üéµ Sound effects dan animasi interaktif</div>
                        <div>‚Ä¢ üì± Responsive design untuk semua device</div>
                    </div>
                </div>

                <!-- Math Features -->
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl md:rounded-2xl p-3 md:p-4 mb-4 md:mb-6">
                    <h4 class="font-bold text-blue-800 mb-3 text-sm md:text-base">üßÆ Fitur Matematika</h4>
                    <div class="text-xs md:text-sm text-blue-700 space-y-1">
                        <div>‚Ä¢ üìö Soal matematika tingkat SMP</div>
                        <div>‚Ä¢ üî¢ 4 kategori: Dasar, Aljabar, Geometri, Lanjutan</div>
                        <div>‚Ä¢ üìä Sistem level kepintaran 1-8</div>
                        <div>‚Ä¢ üí° Penjelasan detail setiap jawaban</div>
                        <div>‚Ä¢ üèÜ Misi khusus tutor matematika</div>
                        <div>‚Ä¢ üéì Title kepintaran yang berkembang</div>
                    </div>
                </div>

                <!-- Close Button -->
                <div class="text-center">
                    <button id="closeInfoPanel" class="bg-white text-purple-600 font-bold py-2 md:py-3 px-6 md:px-8 rounded-full shadow-lg hover:bg-gray-100 transform hover:scale-105 transition-all duration-300 active:scale-95 text-sm md:text-base">
                        Tutup Info üöÄ
                    </button>
                </div>
            </div>
        </div>

        <!-- Save Menu Panel -->
        <div id="saveMenuPanel" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
            <div class="bg-gradient-to-r from-blue-500 to-purple-600 rounded-2xl md:rounded-3xl p-4 md:p-8 shadow-2xl max-w-lg w-full max-h-screen overflow-y-auto">
                <div class="text-center mb-4 md:mb-6">
                    <div class="text-4xl md:text-6xl mb-2 md:mb-4">üíæ</div>
                    <h3 class="text-xl md:text-3xl font-bold text-white mb-2">Menu Save Game</h3>
                    <p class="text-sm md:text-base text-white opacity-90">Kelola progress permainan kamu</p>
                </div>

                <!-- Save Info -->
                <div id="saveInfo" class="bg-white rounded-xl md:rounded-2xl p-3 md:p-4 mb-4 md:mb-6">
                    <h4 class="font-bold text-purple-800 mb-3 text-sm md:text-base">üìä Info Progress</h4>
                    <div class="grid grid-cols-2 gap-2 md:gap-4 text-xs md:text-sm">
                        <div>
                            <span class="text-gray-600">Level:</span>
                            <span id="saveInfoLevel" class="font-bold text-green-600 ml-1 md:ml-2">1</span>
                        </div>
                        <div>
                            <span class="text-gray-600">Poin:</span>
                            <span id="saveInfoPoints" class="font-bold text-red-500 ml-1 md:ml-2">0</span>
                        </div>
                        <div>
                            <span class="text-gray-600">Waktu Main:</span>
                            <span id="saveInfoTime" class="font-bold text-blue-600 ml-1 md:ml-2">0m</span>
                        </div>
                        <div>
                            <span class="text-gray-600">Terakhir Main:</span>
                            <span id="saveInfoDate" class="font-bold text-purple-600 ml-1 md:ml-2">Hari ini</span>
                        </div>
                    </div>
                </div>

                <!-- Save Actions -->
                <div class="grid grid-cols-2 gap-2 md:gap-4 mb-4 md:mb-6">
                    <button id="manualSaveBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 md:py-3 px-2 md:px-4 rounded-xl md:rounded-2xl shadow-lg transform hover:scale-105 transition-all duration-300 active:scale-95">
                        <div class="text-lg md:text-2xl mb-1">üíæ</div>
                        <div class="text-xs md:text-sm">Save Manual</div>
                    </button>
                    
                    <button id="exportSaveBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 md:py-3 px-2 md:px-4 rounded-xl md:rounded-2xl shadow-lg transform hover:scale-105 transition-all duration-300 active:scale-95">
                        <div class="text-lg md:text-2xl mb-1">üì§</div>
                        <div class="text-xs md:text-sm">Export Save</div>
                    </button>
                    
                    <button id="importSaveBtn" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 md:py-3 px-2 md:px-4 rounded-xl md:rounded-2xl shadow-lg transform hover:scale-105 transition-all duration-300 active:scale-95">
                        <div class="text-lg md:text-2xl mb-1">üì•</div>
                        <div class="text-xs md:text-sm">Import Save</div>
                    </button>
                    
                    <button id="resetGameBtn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 md:py-3 px-2 md:px-4 rounded-xl md:rounded-2xl shadow-lg transform hover:scale-105 transition-all duration-300 active:scale-95">
                        <div class="text-lg md:text-2xl mb-1">üóëÔ∏è</div>
                        <div class="text-xs md:text-sm">Reset Game</div>
                    </button>
                </div>

                <!-- Auto Save Status -->
                <div class="bg-white bg-opacity-20 rounded-xl md:rounded-2xl p-3 md:p-4 mb-4 md:mb-6">
                    <div class="flex items-center justify-between text-white">
                        <div class="flex items-center">
                            <span class="text-lg md:text-2xl mr-2">üîÑ</span>
                            <span class="font-bold text-sm md:text-base">Auto Save</span>
                        </div>
                        <div class="text-xs md:text-sm opacity-90">Setiap 30 detik</div>
                    </div>
                    <div class="text-xs text-white opacity-75 mt-2">
                        Progress otomatis tersimpan di browser kamu
                    </div>
                </div>

                <!-- Hidden file input for import -->
                <input type="file" id="importFileInput" accept=".json" class="hidden">

                <!-- Close Button -->
                <div class="text-center">
                    <button id="closeSaveMenu" class="bg-white text-purple-600 font-bold py-2 md:py-3 px-6 md:px-8 rounded-full shadow-lg hover:bg-gray-100 transform hover:scale-105 transition-all duration-300 active:scale-95 text-sm md:text-base">
                        Tutup Menu üöÄ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Game State with Expanded Mission System
        let gameState = {
            playerLevel: 1,
            kindnessPoints: 0,
            empathyLevel: 'Pemula',
            intelligenceLevel: 1,
            mathPoints: 0,
            intelligenceTitle: 'Pemula Matematika',
            currentLocation: null,
            mathMode: false,
            missions: {
                // Basic Missions (Level 1)
                befriendNew: { 
                    name: "Temani Teman Baru", 
                    description: "Ajak teman baru bermain bersama", 
                    emoji: "ü§ù", 
                    progress: 0, 
                    target: 3, 
                    completed: false, 
                    unlockLevel: 1,
                    reward: 50,
                    category: "friendship"
                },
                giveSupport: { 
                    name: "Beri Semangat", 
                    description: "Hibur teman yang sedang sedih", 
                    emoji: "üí™", 
                    progress: 0, 
                    target: 5, 
                    completed: false, 
                    unlockLevel: 1,
                    reward: 75,
                    category: "support"
                },
                reportBully: { 
                    name: "Laporkan Pembully", 
                    description: "Beritahu guru tentang bullying", 
                    emoji: "üì¢", 
                    progress: 0, 
                    target: 2, 
                    completed: false, 
                    unlockLevel: 1,
                    reward: 100,
                    category: "protection"
                },
                
                // Intermediate Missions (Level 2-3)
                shareFood: { 
                    name: "Berbagi Makanan", 
                    description: "Bagi bekal dengan teman yang lupa", 
                    emoji: "üçé", 
                    progress: 0, 
                    target: 4, 
                    completed: false, 
                    unlockLevel: 2,
                    reward: 60,
                    category: "sharing"
                },
                helpStudy: { 
                    name: "Bantu Belajar", 
                    description: "Ajari teman yang kesulitan pelajaran", 
                    emoji: "üìñ", 
                    progress: 0, 
                    target: 6, 
                    completed: false, 
                    unlockLevel: 2,
                    reward: 80,
                    category: "education"
                },
                includeOthers: { 
                    name: "Ajak Bermain", 
                    description: "Ajak teman yang sendirian ikut bermain", 
                    emoji: "üéÆ", 
                    progress: 0, 
                    target: 5, 
                    completed: false, 
                    unlockLevel: 2,
                    reward: 70,
                    category: "inclusion"
                },
                mediateConflict: { 
                    name: "Damaikan Teman", 
                    description: "Bantu menyelesaikan pertengkaran", 
                    emoji: "üïäÔ∏è", 
                    progress: 0, 
                    target: 3, 
                    completed: false, 
                    unlockLevel: 3,
                    reward: 90,
                    category: "peacemaking"
                },
                
                // Advanced Missions (Level 4-5)
                organizeActivity: { 
                    name: "Organisir Kegiatan", 
                    description: "Buat kegiatan seru untuk semua", 
                    emoji: "üé™", 
                    progress: 0, 
                    target: 3, 
                    completed: false, 
                    unlockLevel: 4,
                    reward: 120,
                    category: "leadership"
                },
                mentorJunior: { 
                    name: "Mentor Adik Kelas", 
                    description: "Bimbing adik kelas yang baru", 
                    emoji: "üë®‚Äçüè´", 
                    progress: 0, 
                    target: 4, 
                    completed: false, 
                    unlockLevel: 4,
                    reward: 110,
                    category: "mentoring"
                },
                createClub: { 
                    name: "Buat Klub Kebaikan", 
                    description: "Bentuk grup untuk menyebarkan kebaikan", 
                    emoji: "üåü", 
                    progress: 0, 
                    target: 2, 
                    completed: false, 
                    unlockLevel: 5,
                    reward: 150,
                    category: "community"
                },
                
                // Expert Missions (Level 6+)
                antibullyingCampaign: { 
                    name: "Kampanye Anti-Bullying", 
                    description: "Buat kampanye melawan bullying", 
                    emoji: "üì£", 
                    progress: 0, 
                    target: 3, 
                    completed: false, 
                    unlockLevel: 6,
                    reward: 200,
                    category: "advocacy"
                },
                peerCounselor: { 
                    name: "Konselor Sebaya", 
                    description: "Jadi tempat curhat teman-teman", 
                    emoji: "ü§ó", 
                    progress: 0, 
                    target: 8, 
                    completed: false, 
                    unlockLevel: 6,
                    reward: 180,
                    category: "counseling"
                },
                kindnessAmbassador: { 
                    name: "Duta Kebaikan", 
                    description: "Jadi contoh kebaikan untuk semua", 
                    emoji: "üëë", 
                    progress: 0, 
                    target: 10, 
                    completed: false, 
                    unlockLevel: 7,
                    reward: 250,
                    category: "ambassador"
                },
                
                // Special Challenge Missions
                weeklyChallenge: { 
                    name: "Tantangan Mingguan", 
                    description: "Lakukan 1 kebaikan setiap hari", 
                    emoji: "üóìÔ∏è", 
                    progress: 0, 
                    target: 7, 
                    completed: false, 
                    unlockLevel: 3,
                    reward: 300,
                    category: "challenge"
                },
                empathyMaster: { 
                    name: "Master Empati", 
                    description: "Pahami perasaan 15 orang berbeda", 
                    emoji: "üíù", 
                    progress: 0, 
                    target: 15, 
                    completed: false, 
                    unlockLevel: 5,
                    reward: 400,
                    category: "empathy"
                },
                
                // Math Tutoring Missions
                mathTutor: { 
                    name: "Tutor Matematika", 
                    description: "Ajari teman matematika dasar", 
                    emoji: "üßÆ", 
                    progress: 0, 
                    target: 5, 
                    completed: false, 
                    unlockLevel: 1,
                    reward: 80,
                    category: "education"
                },
                algebraHelper: { 
                    name: "Pembantu Aljabar", 
                    description: "Bantu teman memahami aljabar", 
                    emoji: "üìê", 
                    progress: 0, 
                    target: 4, 
                    completed: false, 
                    unlockLevel: 2,
                    reward: 100,
                    category: "education"
                },
                geometryGuide: { 
                    name: "Panduan Geometri", 
                    description: "Ajarkan konsep geometri", 
                    emoji: "üìè", 
                    progress: 0, 
                    target: 3, 
                    completed: false, 
                    unlockLevel: 3,
                    reward: 120,
                    category: "education"
                },
                mathMentor: { 
                    name: "Mentor Matematika", 
                    description: "Jadi mentor matematika terpercaya", 
                    emoji: "üéì", 
                    progress: 0, 
                    target: 8, 
                    completed: false, 
                    unlockLevel: 4,
                    reward: 150,
                    category: "education"
                },
                mathChampion: { 
                    name: "Juara Matematika", 
                    description: "Bantu 10 teman sukses matematika", 
                    emoji: "üèÜ", 
                    progress: 0, 
                    target: 10, 
                    completed: false, 
                    unlockLevel: 5,
                    reward: 200,
                    category: "education"
                }
            },
            achievements: [],
            totalPlayTime: 0,
            lastPlayed: null,
            scenariosCompleted: 0,
            dailyStreak: 0,
            lastPlayDate: null
        };

        // Math Problems Database for SMP Level
        const mathProblems = {
            basic: [
                {
                    question: "Berapakah hasil dari 15 + 28?",
                    options: ["42", "43", "41", "44"], // benar: 43 di index 1
                    correct: 1,
                    explanation: "15 + 28 = 43. Kita bisa menghitung dengan cara: 15 + 20 = 35, lalu 35 + 8 = 43."
                },
                {
                    question: "Hasil dari 84 - 37 adalah...",
                    options: ["46", "48", "49", "47"], // benar: 47 di index 3
                    correct: 3,
                    explanation: "84 - 37 = 47. Cara mudah: 84 - 30 = 54, lalu 54 - 7 = 47."
                },
                {
                    question: "Berapakah 12 √ó 8?",
                    options: ["94", "96", "92", "98"], // benar: 96 di index 1
                    correct: 1,
                    explanation: "12 √ó 8 = 96. Bisa dihitung: 12 √ó 8 = (10 √ó 8) + (2 √ó 8) = 80 + 16 = 96."
                },
                {
                  question: "Berapa hasil dari 50 + 25?",
                  options: ["75", "70", "65", "80"],
                  correct: 0,
                  explanation: "50 + 25 = 75."
                },
                {
                  question: "Hasil dari 100 - 45 adalah...",
                  options: ["55", "60", "50", "65"],
                  correct: 0,
                  explanation: "100 - 45 = 55."
                }
            ],
            algebra: [
                {
                    question: "Jika x + 5 = 12, maka nilai x adalah...",
                    options: ["5", "6", "7", "8"], // benar: 7 di index 2
                    correct: 2,
                    explanation: "x + 5 = 12, maka x = 12 - 5 = 7. Kita pindahkan 5 ke ruas kanan."
                },
                {
                    question: "Hasil dari 3x + 2x adalah...",
                    options: ["5x¬≤", "5x", "6", "6x"], // benar: 5x di index 1
                    correct: 1,
                    explanation: "3x + 2x = (3 + 2)x = 5x. Kita jumlahkan koefisiennya."
                },
                {
                    question: "Jika 2y - 3 = 9, maka y = ...",
                    options: ["4", "5", "6", "7"], // benar: 6 di index 2
                    correct: 2,
                    explanation: "2y - 3 = 9, maka 2y = 9 + 3 = 12, jadi y = 12 √∑ 2 = 6."
                },
                {
                  question: "Jika x √∑ 4 = 5, maka x adalah...",
                  options: ["10", "15", "20", "25"],
                  correct: 2,
                  explanation: "x = 5 √ó 4 = 20."
                },
                {
                  question: "Jika 3x = 2x + 5, maka x = ...",
                  options: ["2", "3", "4", "5"],
                  correct: 3,
                  explanation: "3x - 2x = 5 ‚Üí x = 5."
                }
            ],
            geometry: [
                {
                    question: "Luas persegi dengan sisi 8 cm adalah...",
                    options: ["16 cm¬≤", "64 cm¬≤", "32 cm¬≤", "24 cm¬≤"], // benar: 64 cm¬≤ di index 1
                    correct: 1,
                    explanation: "Luas persegi = sisi √ó sisi = 8 √ó 8 = 64 cm¬≤."
                },
                {
                    question: "Keliling lingkaran dengan jari-jari 7 cm adalah... (œÄ = 22/7)",
                    options: ["14 cm", "88 cm", "22 cm", "44 cm"], // benar: 44 cm di index 3
                    correct: 3,
                    explanation: "Keliling = 2œÄr = 2 √ó (22/7) √ó 7 = 2 √ó 22 = 44 cm."
                },
                {
                    question: "Luas segitiga dengan alas 10 cm dan tinggi 6 cm adalah...",
                    options: ["20 cm¬≤", "30 cm¬≤", "60 cm¬≤", "16 cm¬≤"], // benar: 30 cm¬≤ di index 1
                    correct: 1,
                    explanation: "Luas segitiga = ¬Ω √ó alas √ó tinggi = ¬Ω √ó 10 √ó 6 = 30 cm¬≤."
                },
                {
                  question: "Luas lingkaran dengan jari-jari 7 cm (œÄ = 22/7) adalah...",
                  options: ["144 cm¬≤", "154 cm¬≤", "164 cm¬≤", "140 cm¬≤"],
                  correct: 1,
                  explanation: "Luas = œÄ √ó r¬≤ = 22/7 √ó 7 √ó 7 = 154 cm¬≤."
                },
                {
                  question: "Keliling segitiga dengan sisi 5 cm, 6 cm, dan 7 cm adalah...",
                  options: ["17 cm", "18 cm", "19 cm", "20 cm"],
                  correct: 2,
                  explanation: "5 + 6 + 7 = 18 cm."
                }
            ],
            advanced: [
                {
                    question: "Jika a¬≤ + b¬≤ = 25 dan a = 3, maka b = ...",
                    options: ["4", "5", "6", "3"], // benar: 4 di index 0
                    correct: 0,
                    explanation: "a¬≤ + b¬≤ = 25, jika a = 3, maka 9 + b¬≤ = 25, sehingga b¬≤ = 16, jadi b = 4."
                },
                {
                    question: "Hasil dari (x + 3)(x - 2) adalah...",
                    options: ["x¬≤ + x + 6", "x¬≤ - x - 6", "x¬≤ + x - 6", "x¬≤ - x + 6"], // benar: x¬≤ + x - 6 di index 2
                    correct: 2,
                    explanation: "(x + 3)(x - 2) = x¬≤ - 2x + 3x - 6 = x¬≤ + x - 6."
                },
                {
                    question: "Jika f(x) = 2x + 1, maka f(5) = ...",
                    options: ["12", "11", "9", "10"], // benar: 11 di index 1
                    correct: 1,
                    explanation: "f(5) = 2(5) + 1 = 10 + 1 = 11."
                },
                {
                  question: "Jika f(x) = x¬≤ + 2x, maka f(3) = ...",
                  options: ["9", "11", "15", "21"],
                  correct: 2,
                  explanation: "f(3) = 3¬≤ + 2√ó3 = 9 + 6 = 15."
                },
                {
                  question: "Jika 2a + 3 = 9, maka nilai a adalah...",
                  options: ["2", "3", "4", "5"],
                  correct: 1,
                  explanation: "2a = 6 ‚Üí a = 3."
                },
                {
                    question: "Jika a¬≤ = 49, maka a = ...",
                    options: ["6", "7", "8", "9"],
                    correct: 1,
                    explanation: "‚àö49 = 7."
                },
                {
                    question: "Jika f(x) = x¬≤ - 2x, maka f(4) = ...",
                    options: ["8", "12", "16", "24"],
                    correct: 0,
                    explanation: "4¬≤ - 2√ó4 = 16 - 8 = 8."
                }
            ]
        };


        // Expanded Game Scenarios
        const scenarios = {
            school: [
                {
                    title: "Teman Baru di Koridor",
                    description: "Kamu melihat anak baru berdiri sendiri di koridor. Dia terlihat bingung dan kesepian.",
                    characters: [
                        { emoji: "üòü", name: "Anak Baru", dialogue: "Aku tidak tahu harus ke mana..." },
                        { emoji: "üòä", name: "KAMU", dialogue: "Apa yang harus kulakukan?" }
                    ],
                    actions: [
                        { text: "Ajak Bicara", type: "befriend", points: 15, correct: true },
                        { text: "Tunjukkan Jalan", type: "help", points: 10, correct: true },
                        { text: "Abaikan", type: "ignore", points: -5, correct: false },
                        { text: "Panggil Teman Lain", type: "social", points: 20, correct: true }
                    ]
                },
                {
                    title: "Bullying di Kantin",
                    description: "Seorang anak besar mengambil bekal temanmu dan tidak mau mengembalikannya.",
                    characters: [
                        { emoji: "üò°", name: "Pembully", dialogue: "Bekalmu jelek! Aku ambil saja!" },
                        { emoji: "üò¢", name: "Korban", dialogue: "Kembalikan bekalku..." },
                        { emoji: "üò†", name: "KAMU", dialogue: "Ini tidak boleh dibiarkan!" }
                    ],
                    actions: [
                        { text: "Laporkan ke Guru", type: "report", points: 25, correct: true },
                        { text: "Bela Teman", type: "defend", points: 20, correct: true },
                        { text: "Ajak Pergi", type: "escape", points: 10, correct: false },
                        { text: "Diam Saja", type: "ignore", points: -10, correct: false }
                    ]
                },
                {
                    title: "Teman Lupa Bekal",
                    description: "Temanmu lupa membawa bekal dan terlihat lapar saat jam istirahat.",
                    characters: [
                        { emoji: "üòã", name: "Teman Lapar", dialogue: "Aduh, aku lupa bawa bekal..." },
                        { emoji: "ü§î", name: "KAMU", dialogue: "Kasihan dia..." }
                    ],
                    actions: [
                        { text: "Bagi Bekalmu", type: "share", points: 20, correct: true },
                        { text: "Ajak ke Kantin", type: "help", points: 15, correct: true },
                        { text: "Pura-pura Tidak Lihat", type: "ignore", points: -5, correct: false },
                        { text: "Kumpulkan Uang Bareng", type: "organize", points: 25, correct: true }
                    ]
                },
                {
                    title: "Gosip Jahat",
                    description: "Kamu mendengar teman-teman membicarakan hal buruk tentang seseorang.",
                    characters: [
                        { emoji: "üó£Ô∏è", name: "Teman A", dialogue: "Dia aneh banget sih..." },
                        { emoji: "üòè", name: "Teman B", dialogue: "Iya, jangan deket-deket deh!" },
                        { emoji: "üòê", name: "KAMU", dialogue: "Ini tidak benar..." }
                    ],
                    actions: [
                        { text: "Hentikan Gosip", type: "defend", points: 30, correct: true },
                        { text: "Alihkan Pembicaraan", type: "mediate", points: 20, correct: true },
                        { text: "Ikut Bergosip", type: "join", points: -15, correct: false },
                        { text: "Pergi Menjauh", type: "escape", points: 5, correct: false }
                    ]
                },
                {
                    title: "Teman Dijauhi",
                    description: "Seorang teman dijauhi oleh grup karena berbeda pendapat.",
                    characters: [
                        { emoji: "üòî", name: "Teman Terisolasi", dialogue: "Kenapa mereka menghindariku..." },
                        { emoji: "üò§", name: "Grup", dialogue: "Dia selalu beda pendapat!" },
                        { emoji: "ü§ù", name: "KAMU", dialogue: "Semua orang berhak punya pendapat." }
                    ],
                    actions: [
                        { text: "Temani Dia", type: "befriend", points: 25, correct: true },
                        { text: "Mediasi Konflik", type: "mediate", points: 35, correct: true },
                        { text: "Ikut Menjauhi", type: "join", points: -20, correct: false },
                        { text: "Buat Grup Baru", type: "organize", points: 30, correct: true }
                    ]
                },
                {
                    title: "Cyberbullying",
                    description: "Temanmu menunjukkan chat grup yang berisi ejekan tentang dirinya.",
                    characters: [
                        { emoji: "üò≠", name: "Korban", dialogue: "Mereka bilang aku jelek di grup..." },
                        { emoji: "üì±", name: "Chat Jahat", dialogue: "Pesan-pesan menyakitkan..." },
                        { emoji: "üò°", name: "KAMU", dialogue: "Ini bullying digital!" }
                    ],
                    actions: [
                        { text: "Screenshot & Lapor", type: "report", points: 40, correct: true },
                        { text: "Hibur & Dukung", type: "comfort", points: 25, correct: true },
                        { text: "Balas Chat Jahat", type: "fight", points: -10, correct: false },
                        { text: "Blokir Semua", type: "escape", points: 10, correct: false }
                    ]
                },
                {
                    title: "Diskriminasi",
                    description: "Teman dari latar belakang berbeda tidak diajak bermain oleh yang lain.",
                    characters: [
                        { emoji: "üòû", name: "Teman Berbeda", dialogue: "Mereka tidak mau main sama aku..." },
                        { emoji: "üôÑ", name: "Grup Eksklusif", dialogue: "Kita kan beda sama dia..." },
                        { emoji: "üåà", name: "KAMU", dialogue: "Perbedaan itu indah!" }
                    ],
                    actions: [
                        { text: "Ajak Main Bersama", type: "include", points: 30, correct: true },
                        { text: "Edukasi Tentang Toleransi", type: "teach", points: 35, correct: true },
                        { text: "Ikut Mengucilkan", type: "join", points: -25, correct: false },
                        { text: "Buat Aktivitas Inklusif", type: "organize", points: 40, correct: true }
                    ]
                },
                {
                    title: "Teman Insecure",
                    description: "Temanmu selalu merasa tidak percaya diri dan membandingkan diri dengan orang lain.",
                    characters: [
                        { emoji: "üò∞", name: "Teman Insecure", dialogue: "Aku tidak sepintar mereka..." },
                        { emoji: "üí™", name: "KAMU", dialogue: "Setiap orang punya kelebihan!" }
                    ],
                    actions: [
                        { text: "Puji Kelebihannya", type: "encourage", points: 20, correct: true },
                        { text: "Ajak Aktivitas Seru", type: "include", points: 25, correct: true },
                        { text: "Setuju Dia Kurang", type: "agree", points: -15, correct: false },
                        { text: "Bantu Temukan Bakat", type: "mentor", points: 30, correct: true }
                    ]
                },
                {
                    title: "Teman Kesulitan Matematika",
                    description: "Temanmu sangat kesulitan dengan pelajaran matematika dan akan ada ulangan besok.",
                    characters: [
                        { emoji: "üò´", name: "Teman Bingung", dialogue: "Aku tidak mengerti matematika sama sekali!" },
                        { emoji: "üìö", name: "Buku Matematika", dialogue: "Soal-soal yang rumit..." },
                        { emoji: "ü§ì", name: "KAMU", dialogue: "Aku bisa mengajarimu!" }
                    ],
                    actions: [
                        { text: "Ajari Step by Step", type: "mathTutor", points: 30, correct: true },
                        { text: "Beri Contekan", type: "cheat", points: -20, correct: false },
                        { text: "Suruh Belajar Sendiri", type: "ignore", points: -10, correct: false },
                        { text: "Panggil Guru", type: "help", points: 15, correct: true }
                    ]
                },
                {
                  title: "Tugas Mendadak",
                  description: "Guru memberi tugas mendadak dan banyak teman panik.",
                  characters: [
                    { emoji: "üòì", name: "Teman Panik", dialogue: "Aku nggak ngerti tugasnya!" },
                    { emoji: "üòå", name: "KAMU", dialogue: "Tenang, ayo kita kerjakan bareng!" }
                  ],
                  actions: [
                    { text: "Bentuk Grup Belajar", type: "organize", points: 25, correct: true },
                    { text: "Ajari Teman", type: "teach", points: 20, correct: true },
                    { text: "Abaikan Tugas", type: "ignore", points: -10, correct: false },
                    { text: "Salin Jawaban Teman", type: "cheat", points: -20, correct: false }
                  ]
                },
                {
                    title: "Teman Terlambat",
                    description: "Temanmu datang terlambat dan tidak tahu pelajaran apa yang sedang berlangsung.",
                    characters: [
                        { emoji: "üò∞", name: "Teman Terlambat", dialogue: "Aku ketinggalan pelajaran..." },
                        { emoji: "üìö", name: "KAMU", dialogue: "Aku bisa bantu jelaskan!" }
                    ],
                    actions: [
                        { text: "Beri Ringkasan Pelajaran", type: "teach", points: 25, correct: true },
                        { text: "Pinjamkan Catatan", type: "support", points: 20, correct: true },
                        { text: "Biarkan Dia Bingung", type: "ignore", points: -10, correct: false },
                        { text: "Minta Guru Ulangi", type: "advocate", points: 15, correct: true }
                    ]
                }
            ],
            playground: [
                {
                    title: "Teman Terjatuh",
                    description: "Temanmu terjatuh saat bermain dan lututnya berdarah. Dia menangis kesakitan.",
                    characters: [
                        { emoji: "üò≠", name: "Teman", dialogue: "Aduh... sakit sekali!" },
                        { emoji: "üòü", name: "KAMU", dialogue: "Aku harus membantu!" }
                    ],
                    actions: [
                        { text: "Panggil Guru", type: "help", points: 20, correct: true },
                        { text: "Hibur Dia", type: "comfort", points: 15, correct: true },
                        { text: "Cari Obat", type: "medical", points: 25, correct: true },
                        { text: "Tinggalkan", type: "ignore", points: -15, correct: false }
                    ]
                },
                {
                    title: "Permainan Tidak Adil",
                    description: "Dalam permainan, ada yang curang dan tidak mau mengakuinya.",
                    characters: [
                        { emoji: "üò§", name: "Penipu", dialogue: "Aku tidak curang!" },
                        { emoji: "üò†", name: "Korban", dialogue: "Dia jelas curang tadi!" },
                        { emoji: "‚öñÔ∏è", name: "KAMU", dialogue: "Harus adil untuk semua." }
                    ],
                    actions: [
                        { text: "Jadi Wasit", type: "mediate", points: 25, correct: true },
                        { text: "Buat Aturan Baru", type: "organize", points: 30, correct: true },
                        { text: "Ikut Curang", type: "cheat", points: -20, correct: false },
                        { text: "Berhenti Main", type: "quit", points: 5, correct: false }
                    ]
                },
                {
                    title: "Anak Kecil Menangis",
                    description: "Adik kelas menangis karena mainannya diambil anak yang lebih besar.",
                    characters: [
                        { emoji: "üò≠", name: "Adik Kelas", dialogue: "Mainanku diambil..." },
                        { emoji: "üòà", name: "Anak Besar", dialogue: "Ini mainan bagus, aku pinjam!" },
                        { emoji: "ü¶∏", name: "KAMU", dialogue: "Aku harus melindungi yang kecil!" }
                    ],
                    actions: [
                        { text: "Minta Kembalikan", type: "defend", points: 25, correct: true },
                        { text: "Lapor Guru Piket", type: "report", points: 20, correct: true },
                        { text: "Belikan Mainan Baru", type: "help", points: 15, correct: true },
                        { text: "Biarkan Saja", type: "ignore", points: -10, correct: false }
                    ]
                },
                {
                    title: "Tim Olahraga",
                    description: "Saat membentuk tim, ada teman yang selalu dipilih terakhir.",
                    characters: [
                        { emoji: "üòî", name: "Teman Terakhir", dialogue: "Aku selalu dipilih terakhir..." },
                        { emoji: "üèÉ", name: "Kapten Tim", dialogue: "Kita pilih yang jago aja!" },
                        { emoji: "‚öΩ", name: "KAMU", dialogue: "Semua harus dapat kesempatan." }
                    ],
                    actions: [
                        { text: "Pilih Dia Duluan", type: "include", points: 30, correct: true },
                        { text: "Buat Tim Seimbang", type: "organize", points: 35, correct: true },
                        { text: "Ikut Pilih Terakhir", type: "follow", points: -5, correct: false },
                        { text: "Latih Dia Dulu", type: "mentor", points: 25, correct: true }
                    ]
                },
                {
                    title: "Fasilitas Rusak",
                    description: "Ayunan di taman rusak dan berbahaya, tapi masih ada yang mau memakainya.",
                    characters: [
                        { emoji: "‚ö†Ô∏è", name: "Ayunan Rusak", dialogue: "Rantai hampir putus..." },
                        { emoji: "üòÖ", name: "Teman Nekat", dialogue: "Ah, masih bisa kok!" },
                        { emoji: "üò∞", name: "KAMU", dialogue: "Ini berbahaya!" }
                    ],
                    actions: [
                        { text: "Larang Pakai", type: "protect", points: 25, correct: true },
                        { text: "Lapor Petugas", type: "report", points: 30, correct: true },
                        { text: "Pasang Tanda Bahaya", type: "organize", points: 35, correct: true },
                        { text: "Ikut Main Juga", type: "join", points: -20, correct: false }
                    ]
                },
                {
                    title: "Teman Alergi",
                    description: "Temanmu alergi makanan tertentu, tapi ada yang sengaja membawa makanan itu.",
                    characters: [
                        { emoji: "ü§ß", name: "Teman Alergi", dialogue: "Aku tidak bisa dekat makanan itu..." },
                        { emoji: "üòè", name: "Teman Jahil", dialogue: "Ah, lebay! Cuma makanan doang!" },
                        { emoji: "üõ°Ô∏è", name: "KAMU", dialogue: "Alergi itu serius!" }
                    ],
                    actions: [
                        { text: "Edukasi Tentang Alergi", type: "teach", points: 30, correct: true },
                        { text: "Jauhkan Makanan", type: "protect", points: 25, correct: true },
                        { text: "Ikut Mengejek", type: "bully", points: -25, correct: false },
                        { text: "Panggil Guru", type: "report", points: 20, correct: true }
                    ]
                },
                {
                  title: "Mainan Baru",
                  description: "Seseorang membawa mainan baru dan semua ingin mencoba.",
                  characters: [
                    { emoji: "üß∏", name: "Mainan Baru", dialogue: "Aku ingin semua mencoba..." },
                    { emoji: "üòÖ", name: "KAMU", dialogue: "Harus adil bagi semua!" }
                  ],
                  actions: [
                    { text: "Atur Giliran", type: "organize", points: 30, correct: true },
                    { text: "Main Sendiri", type: "selfish", points: -10, correct: false },
                    { text: "Minta Sumbangan Mainan", type: "advocate", points: 20, correct: true },
                    { text: "Gosok Mainan Terus", type: "bully", points: -20, correct: false }
                  ]
                },
                {
                    title: "Anak Kesepian di Ayunan",
                    description: "Seorang anak duduk sendirian di ayunan sambil menunduk.",
                    characters: [
                        { emoji: "üòû", name: "Anak Sendirian", dialogue: "Aku tidak punya teman main..." },
                        { emoji: "üôÇ", name: "KAMU", dialogue: "Aku bisa ajak dia bermain!" }
                    ],
                    actions: [
                        { text: "Ajak Bermain", type: "include", points: 30, correct: true },
                        { text: "Beri Senyuman", type: "encourage", points: 15, correct: true },
                        { text: "Pergi Saja", type: "ignore", points: -10, correct: false },
                        { text: "Ajak Teman Lain Juga", type: "organize", points: 25, correct: true }
                    ]
                }
            ],
            classroom: [
                {
                  title: "Teman Dipermalukan",
                  description: "Seseorang menertawakan teman yang salah menjawab di kelas.",
                  characters: [
                    { emoji: "üò¢", name: "Korban", dialogue: "Aku malu banget..." },
                    { emoji: "üò†", name: "Penertawa", dialogue: "Wkwkwk salah banget jawabnya!" },
                    { emoji: "üòê", name: "KAMU", dialogue: "Itu tidak sopan!" }
                  ],
                  actions: [
                    { text: "Bela Teman", type: "defend", points: 30, correct: true },
                    { text: "Tegur Penertawa", type: "advocate", points: 25, correct: true },
                    { text: "Ikut Tertawa", type: "mock", points: -15, correct: false },
                    { text: "Pura-Pura Tidak Lihat", type: "ignore", points: -5, correct: false }
                  ]
                },
                {
                    title: "Teman Kesulitan Belajar",
                    description: "Temanmu tidak mengerti pelajaran matematika dan terlihat frustasi.",
                    characters: [
                        { emoji: "üò∞", name: "Teman", dialogue: "Aku tidak mengerti sama sekali..." },
                        { emoji: "ü§î", name: "KAMU", dialogue: "Mungkin aku bisa membantu?" }
                    ],
                    actions: [
                        { text: "Ajari Dia", type: "teach", points: 20, correct: true },
                        { text: "Beri Semangat", type: "encourage", points: 15, correct: true },
                        { text: "Minta Tolong Guru", type: "help", points: 18, correct: true },
                        { text: "Biarkan Saja", type: "ignore", points: -5, correct: false }
                    ]
                },
                {
                    title: "Presentasi Gugup",
                    description: "Temanmu sangat gugup saat harus presentasi di depan kelas.",
                    characters: [
                        { emoji: "üò®", name: "Teman Gugup", dialogue: "Aku takut presentasi..." },
                        { emoji: "üòä", name: "KAMU", dialogue: "Aku bisa membantumu!" }
                    ],
                    actions: [
                        { text: "Latih Bersama", type: "help", points: 25, correct: true },
                        { text: "Beri Tips", type: "teach", points: 20, correct: true },
                        { text: "Ejek Ketakutannya", type: "mock", points: -15, correct: false },
                        { text: "Tawarkan Gantian", type: "sacrifice", points: 30, correct: true }
                    ]
                },
                {
                    title: "Tugas Kelompok",
                    description: "Dalam tugas kelompok, ada anggota yang tidak mau bekerja sama.",
                    characters: [
                        { emoji: "üò§", name: "Anggota Malas", dialogue: "Kalian aja yang kerjain!" },
                        { emoji: "üò†", name: "Anggota Lain", dialogue: "Tidak adil!" },
                        { emoji: "ü§ù", name: "KAMU", dialogue: "Kita harus kompak." }
                    ],
                    actions: [
                        { text: "Ajak Diskusi", type: "mediate", points: 25, correct: true },
                        { text: "Bagi Tugas Adil", type: "organize", points: 30, correct: true },
                        { text: "Kerjakan Sendiri", type: "sacrifice", points: 15, correct: false },
                        { text: "Lapor Guru", type: "report", points: 20, correct: true }
                    ]
                },
                {
                    title: "Nilai Jelek",
                    description: "Temanmu mendapat nilai jelek dan merasa malu.",
                    characters: [
                        { emoji: "üòû", name: "Teman Sedih", dialogue: "Nilaiaku jelek banget..." },
                        { emoji: "üí™", name: "KAMU", dialogue: "Masih bisa diperbaiki!" }
                    ],
                    actions: [
                        { text: "Hibur & Motivasi", type: "encourage", points: 20, correct: true },
                        { text: "Ajak Belajar Bareng", type: "help", points: 25, correct: true },
                        { text: "Bilang Wajar Aja", type: "dismiss", points: 5, correct: false },
                        { text: "Bantu Minta Remedial", type: "advocate", points: 30, correct: true }
                    ]
                },
                {
                    title: "Contek Massal",
                    description: "Saat ujian, banyak teman yang menyontek dan mengajakmu ikut.",
                    characters: [
                        { emoji: "üòà", name: "Teman Penyontek", dialogue: "Ayo contek bareng!" },
                        { emoji: "üìù", name: "Soal Ujian", dialogue: "Pertanyaan sulit..." },
                        { emoji: "üòá", name: "KAMU", dialogue: "Ini tidak benar..." }
                    ],
                    actions: [
                        { text: "Tolak & Kerjakan Sendiri", type: "honest", points: 35, correct: true },
                        { text: "Ingatkan Tentang Kejujuran", type: "teach", points: 30, correct: true },
                        { text: "Ikut Menyontek", type: "cheat", points: -30, correct: false },
                        { text: "Lapor Pengawas", type: "report", points: 25, correct: true }
                    ]
                },
                {
                    title: "Diskriminasi Guru",
                    description: "Guru terlihat pilih kasih dan tidak adil kepada beberapa siswa.",
                    characters: [
                        { emoji: "üòî", name: "Siswa Diperlakukan Tidak Adil", dialogue: "Guru selalu memarahi aku..." },
                        { emoji: "üò†", name: "Guru Tidak Adil", dialogue: "Kamu selalu bermasalah!" },
                        { emoji: "‚öñÔ∏è", name: "KAMU", dialogue: "Ini tidak adil..." }
                    ],
                    actions: [
                        { text: "Dukung Teman", type: "support", points: 25, correct: true },
                        { text: "Bicara dengan Guru", type: "advocate", points: 35, correct: true },
                        { text: "Lapor ke Kepala Sekolah", type: "report", points: 40, correct: true },
                        { text: "Diam Saja", type: "ignore", points: -10, correct: false }
                    ]
                },
                {
                    title: "Teman Berkebutuhan Khusus",
                    description: "Ada teman berkebutuhan khusus yang sering diejek oleh yang lain.",
                    characters: [
                        { emoji: "üò¢", name: "Teman Berkebutuhan Khusus", dialogue: "Mereka selalu mengejekku..." },
                        { emoji: "üòè", name: "Pengganggu", dialogue: "Dia aneh, tidak seperti kita!" },
                        { emoji: "ü§ó", name: "KAMU", dialogue: "Semua orang berharga!" }
                    ],
                    actions: [
                        { text: "Bela & Lindungi", type: "defend", points: 40, correct: true },
                        { text: "Edukasi Tentang Inklusi", type: "teach", points: 35, correct: true },
                        { text: "Jadi Teman Baik", type: "befriend", points: 30, correct: true },
                        { text: "Ikut Mengejek", type: "bully", points: -40, correct: false }
                    ]
                },
                {
                    title: "Teman Tidak Punya Alat Tulis",
                    description: "Temanmu lupa membawa alat tulis dan panik saat akan ujian.",
                    characters: [
                        { emoji: "üò®", name: "Teman Panik", dialogue: "Aku lupa bawa pensil!" },
                        { emoji: "‚úèÔ∏è", name: "KAMU", dialogue: "Tenang, aku bisa bantu." }
                    ],
                    actions: [
                        { text: "Pinjamkan Pensil", type: "support", points: 20, correct: true },
                        { text: "Tawarkan Pulpen", type: "help", points: 15, correct: true },
                        { text: "Abaikan", type: "ignore", points: -5, correct: false },
                        { text: "Minta ke Guru", type: "advocate", points: 10, correct: true }
                    ]
                }
            ]
        };

        // Save System Class (unchanged)
        class SaveSystem {
            constructor() {
                this.saveKey = 'heroKebaikanSave';
                this.autoSaveInterval = 30000;
                this.startAutoSave();
            }

            saveGame() {
                try {
                    const saveData = {
                        ...gameState,
                        lastPlayed: new Date().toISOString(),
                        version: '2.0'
                    };
                    localStorage.setItem(this.saveKey, JSON.stringify(saveData));
                    this.showSaveNotification();
                    return true;
                } catch (error) {
                    console.error('Failed to save game:', error);
                    return false;
                }
            }

            loadGame() {
                try {
                    const savedData = localStorage.getItem(this.saveKey);
                    if (savedData) {
                        const parsedData = JSON.parse(savedData);
                        
                        Object.keys(parsedData).forEach(key => {
                            if (key !== 'version') {
                                gameState[key] = parsedData[key];
                            }
                        });
                        
                        this.showLoadNotification();
                        return true;
                    }
                    return false;
                } catch (error) {
                    console.error('Failed to load game:', error);
                    return false;
                }
            }

            resetGame() {
                if (confirm('üö® Yakin ingin menghapus semua progress? Data tidak bisa dikembalikan!')) {
                    localStorage.removeItem(this.saveKey);
                    location.reload();
                }
            }

            exportSave() {
                try {
                    const saveData = localStorage.getItem(this.saveKey);
                    if (saveData) {
                        const blob = new Blob([saveData], { type: 'application/json' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `hero-kebaikan-save-${new Date().toISOString().split('T')[0]}.json`;
                        a.click();
                        URL.revokeObjectURL(url);
                        
                        this.showNotification('üíæ Save file berhasil diunduh!', 'success');
                    }
                } catch (error) {
                    this.showNotification('‚ùå Gagal mengunduh save file!', 'error');
                }
            }

            importSave(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const saveData = JSON.parse(e.target.result);
                        localStorage.setItem(this.saveKey, JSON.stringify(saveData));
                        this.showNotification('‚úÖ Save file berhasil dimuat! Refresh halaman.', 'success');
                        setTimeout(() => location.reload(), 2000);
                    } catch (error) {
                        this.showNotification('‚ùå File save tidak valid!', 'error');
                    }
                };
                reader.readAsText(file);
            }

            startAutoSave() {
                setInterval(() => {
                    this.saveGame();
                }, this.autoSaveInterval);
            }

            showSaveNotification() {
                this.showNotification('üíæ Progress tersimpan!', 'success');
            }

            showLoadNotification() {
                this.showNotification('üìÇ Progress dimuat!', 'info');
            }

            showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = `fixed top-4 right-4 z-50 px-4 py-2 rounded-lg shadow-lg text-white font-bold transform translate-x-full transition-transform duration-300 ${
                    type === 'success' ? 'bg-green-500' : 
                    type === 'error' ? 'bg-red-500' : 'bg-blue-500'
                }`;
                notification.textContent = message;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.style.transform = 'translateX(0)';
                }, 100);
                
                setTimeout(() => {
                    notification.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        document.body.removeChild(notification);
                    }, 300);
                }, 3000);
            }

            getPlayTime() {
                const minutes = Math.floor(gameState.totalPlayTime / 60);
                const hours = Math.floor(minutes / 60);
                const remainingMinutes = minutes % 60;
                
                if (hours > 0) {
                    return `${hours}j ${remainingMinutes}m`;
                }
                return `${minutes}m`;
            }

            getSaveInfo() {
                const savedData = localStorage.getItem(this.saveKey);
                if (savedData) {
                    const data = JSON.parse(savedData);
                    return {
                        lastPlayed: new Date(data.lastPlayed).toLocaleDateString('id-ID'),
                        level: data.playerLevel,
                        points: data.kindnessPoints,
                        playTime: this.getPlayTime()
                    };
                }
                return null;
            }
        }

        // Initialize save system
        const saveSystem = new SaveSystem();

        // Sound System (unchanged)
        class SoundSystem {
            constructor() {
                this.audioContext = null;
                this.sounds = {};
                this.init();
            }

            init() {
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    this.createSounds();
                } catch (e) {
                    console.log('Web Audio API not supported');
                }
            }

            createSounds() {
                this.sounds = {
                    click: () => this.playTone(800, 0.1, 'sine'),
                    success: () => this.playChord([523, 659, 784], 0.3, 'sine'),
                    levelUp: () => this.playMelody([523, 659, 784, 1047], 0.15, 'triangle'),
                    transition: () => this.playSwipe(),
                    error: () => this.playTone(200, 0.2, 'sawtooth'),
                    mission: () => this.playTone(1000, 0.15, 'triangle')
                };
            }

            playTone(frequency, duration, type = 'sine') {
                if (!this.audioContext) return;
                
                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(this.audioContext.destination);
                
                oscillator.frequency.setValueAtTime(frequency, this.audioContext.currentTime);
                oscillator.type = type;
                
                gainNode.gain.setValueAtTime(0.1, this.audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + duration);
                
                oscillator.start(this.audioContext.currentTime);
                oscillator.stop(this.audioContext.currentTime + duration);
            }

            playChord(frequencies, duration, type = 'sine') {
                frequencies.forEach((freq, index) => {
                    setTimeout(() => this.playTone(freq, duration, type), index * 50);
                });
            }

            playMelody(frequencies, noteDuration, type = 'sine') {
                frequencies.forEach((freq, index) => {
                    setTimeout(() => this.playTone(freq, noteDuration, type), index * noteDuration * 1000);
                });
            }

            playSwipe() {
                if (!this.audioContext) return;
                
                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(this.audioContext.destination);
                
                oscillator.frequency.setValueAtTime(400, this.audioContext.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(800, this.audioContext.currentTime + 0.3);
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.1, this.audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.3);
                
                oscillator.start(this.audioContext.currentTime);
                oscillator.stop(this.audioContext.currentTime + 0.3);
            }

            play(soundName) {
                if (this.sounds[soundName]) {
                    this.sounds[soundName]();
                }
            }
        }

        // Initialize sound system
        const soundSystem = new SoundSystem();

        // Math Mode Functions
        function getMathProblem() {
            const categories = ['basic', 'algebra', 'geometry', 'advanced'];
            const availableCategories = categories.filter(cat => {
                if (cat === 'basic') return true;
                if (cat === 'algebra') return gameState.intelligenceLevel >= 2;
                if (cat === 'geometry') return gameState.intelligenceLevel >= 3;
                if (cat === 'advanced') return gameState.intelligenceLevel >= 4;
                return false;
            });
            
            const category = availableCategories[Math.floor(Math.random() * availableCategories.length)];
            const problems = mathProblems[category];
            return {
                ...problems[Math.floor(Math.random() * problems.length)],
                category: category
            };
        }

        function showMathTutoring() {
            gameState.mathMode = true;
            soundSystem.play('transition');
            
            const gameScene = document.getElementById('gameScene');
            gameScene.style.background = 'linear-gradient(135deg, #dbeafe 0%, #bfdbfe 50%, #3b82f6 100%)';
            gameScene.classList.add('transitioning');
            
            sceneContent.classList.add('fade-out');
            
            setTimeout(() => {
                const problem = getMathProblem();
                
                sceneContent.innerHTML = `
                    <div class="text-center mb-6">
                        <div class="text-4xl md:text-6xl mb-4">üßÆ</div>
                        <h3 class="text-xl md:text-2xl font-bold text-blue-800 mb-4">Mode Tutor Matematika</h3>
                        <p class="text-sm md:text-base text-gray-700 mb-4">Bantu temanmu memahami soal matematika ini!</p>
                        <div class="bg-blue-100 rounded-xl p-4 mb-4">
                            <div class="text-xs md:text-sm text-blue-600 font-bold mb-2">Kategori: ${problem.category.toUpperCase()}</div>
                            <div class="text-sm md:text-lg font-bold text-blue-800">${problem.question}</div>
                        </div>
                    </div>
                    
                    <div class="flex justify-center space-x-6 mb-6">
                        <div class="text-center slide-in-left">
                            <div class="text-4xl md:text-6xl mb-2">üòï</div>
                            <div class="bg-red-500 text-white px-3 py-1 rounded-full text-sm font-bold mb-2">TEMAN</div>
                            <div class="bg-white border-2 border-red-300 rounded-lg p-3 shadow-lg max-w-xs">
                                <p class="text-sm text-red-700 font-semibold">"Aku bingung dengan soal ini..."</p>
                            </div>
                        </div>
                        
                        <div class="text-center slide-in-right">
                            <div class="text-4xl md:text-6xl mb-2">ü§ì</div>
                            <div class="bg-blue-500 text-white px-3 py-1 rounded-full text-sm font-bold mb-2">KAMU</div>
                            <div class="bg-white border-2 border-blue-300 rounded-lg p-3 shadow-lg max-w-xs">
                                <p class="text-sm text-blue-700 font-semibold">"Ayo kita selesaikan bersama!"</p>
                            </div>
                        </div>
                    </div>
                `;
                
                sceneContent.classList.remove('fade-out');
                sceneContent.classList.add('fade-in');
                
                actionPanel.classList.remove('hidden');
                actionPanel.classList.add('slide-in-up');
                
                actionButtons.innerHTML = problem.options.map((option, index) => `
                    <button class="math-option bg-gradient-to-b from-blue-400 to-blue-600 hover:from-blue-500 hover:to-blue-700 text-white font-bold py-4 px-4 rounded-xl shadow-lg transform hover:scale-105 transition-all duration-300 active:scale-95" 
                            data-index="${index}" data-correct="${index === problem.correct}"
                            style="animation-delay: ${index * 0.1}s">
                        <div class="text-lg mb-2">${String.fromCharCode(65 + index)}</div>
                        <div class="text-sm">${option}</div>
                    </button>
                `).join('');
                
                document.querySelectorAll('.math-option').forEach((btn, index) => {
                    btn.addEventListener('click', (e) => handleMathAnswer(e, problem));
                    btn.classList.add('bounce-in');
                    btn.addEventListener('mouseenter', () => soundSystem.play('click'));
                });
                
                setTimeout(() => {
                    gameScene.classList.remove('transitioning');
                    sceneContent.classList.remove('fade-in');
                    actionPanel.classList.remove('slide-in-up');
                }, 600);
                
            }, 500);
        }

        function handleMathAnswer(event, problem) {
            const btn = event.currentTarget;
            const selectedIndex = parseInt(btn.dataset.index);
            const isCorrect = selectedIndex === problem.correct;
            
            soundSystem.play(isCorrect ? 'success' : 'error');
            
            btn.classList.add(isCorrect ? 'bounce-in' : 'shake');
            
            // Update stats
            if (isCorrect) {
                actionPanel.classList.add('hidden');
                gameState.mathPoints += 25;
                gameState.kindnessPoints += 15; // Also get kindness points for helping
                updateMathLevel();
                updateMissionProgress('mathTutor');
            } else {
                actionPanel.classList.add('hidden');
                gameState.mathPoints += 5; // Small points for trying
            }
            
            setTimeout(() => {
                showMathFeedback(isCorrect, problem);
            }, 500);
            
            saveSystem.saveGame();
            updateUI();
        }

        function updateMathLevel() {
            const newIntelligenceLevel = Math.floor(gameState.mathPoints / 50) + 1;
            if (newIntelligenceLevel > gameState.intelligenceLevel) {
                gameState.intelligenceLevel = newIntelligenceLevel;
                
                // Update intelligence title
                if (gameState.intelligenceLevel >= 8) gameState.intelligenceTitle = 'Genius Matematika';
                else if (gameState.intelligenceLevel >= 6) gameState.intelligenceTitle = 'Master Matematika';
                else if (gameState.intelligenceLevel >= 4) gameState.intelligenceTitle = 'Ahli Matematika';
                else if (gameState.intelligenceLevel >= 2) gameState.intelligenceTitle = 'Tutor Handal';
                
                showIntelligenceLevelUp();
            }
        }

        function showIntelligenceLevelUp() {
            soundSystem.play('levelUp');
            
            setTimeout(() => {
                const notification = document.createElement('div');
                notification.className = 'fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-gradient-to-r from-blue-400 to-indigo-500 text-white p-6 rounded-2xl shadow-2xl z-50 text-center max-w-sm mx-4';
                notification.innerHTML = `
                    <div class="text-4xl mb-2">üß†</div>
                    <h3 class="text-xl font-bold mb-2">Intelligence Level Up!</h3>
                    <p class="text-sm mb-3">Level Kepintaran: ${gameState.intelligenceLevel}</p>
                    <div class="text-lg font-bold">${gameState.intelligenceTitle}</div>
                    <div class="text-xs mt-2 opacity-90">Soal matematika baru terbuka!</div>
                `;
                
                document.body.appendChild(notification);
                notification.classList.add('bounce-in');
                
                setTimeout(() => {
                    notification.classList.add('fade-out');
                    setTimeout(() => {
                        document.body.removeChild(notification);
                    }, 500);
                }, 3000);
            }, 1000);
        }

        function showMathFeedback(isCorrect, problem) {
            sceneContent.innerHTML = `
                <div class="text-center">
                    <div class="text-8xl mb-4">${isCorrect ? 'üéâ' : 'üí≠'}</div>
                    <h3 class="text-2xl font-bold ${isCorrect ? 'text-green-600' : 'text-orange-600'} mb-4">
                        ${isCorrect ? 'Jawaban Benar!' : 'Coba Lagi!'}
                    </h3>
                    <div class="bg-blue-100 rounded-xl p-4 mb-4">
                        <h4 class="font-bold text-blue-800 mb-2">Penjelasan:</h4>
                        <p class="text-sm text-blue-700">${problem.explanation}</p>
                    </div>
                    <div class="text-xl font-bold ${isCorrect ? 'text-green-600' : 'text-blue-600'} mb-2">
                        +${isCorrect ? 25 : 5} Poin Matematika
                    </div>
                    ${isCorrect ? '<div class="text-lg font-bold text-purple-600 mb-6">+15 Poin Kebaikan</div>' : ''}
                    <div class="flex flex-col sm:flex-row gap-3 justify-center">
                        <button id="continueMathBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-full shadow-lg transform hover:scale-105 transition-all duration-300">
                            Soal Berikutnya üßÆ
                        </button>
                        <button id="exitMathBtn" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-6 rounded-full shadow-lg transform hover:scale-105 transition-all duration-300">
                            Kembali ke Game üéÆ
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('continueMathBtn').addEventListener('click', () => {
                showMathTutoring();
            });
            
            document.getElementById('exitMathBtn').addEventListener('click', () => {
                gameState.mathMode = false;
                showWelcomeScene();
                actionPanel.classList.add('hidden');
            });
        }

        // DOM Elements
        const playerLevelEl = document.getElementById('playerLevel');
        const kindnessPointsEl = document.getElementById('kindnessPoints');
        const empathyLevelEl = document.getElementById('empathyLevel');
        const intelligenceLevelEl = document.getElementById('intelligenceLevel');
        const mathPointsEl = document.getElementById('mathPoints');
        const sceneContent = document.getElementById('sceneContent');
        const actionPanel = document.getElementById('actionPanel');
        const actionButtons = document.getElementById('actionButtons');
        const levelUpPanel = document.getElementById('levelUpPanel');
        const activeMissions = document.getElementById('activeMissions');

        // Location buttons
        const schoolBtn = document.getElementById('schoolBtn');
        const playgroundBtn = document.getElementById('playgroundBtn');
        const classroomBtn = document.getElementById('classroomBtn');

        // Mission Management Functions
        function getAvailableMissions() {
            return Object.entries(gameState.missions).filter(([key, mission]) => {
                return gameState.playerLevel >= mission.unlockLevel && !mission.completed;
            });
        }

        function getActiveMissions() {
            // Show max 6 active missions at a time for better focus
            const available = getAvailableMissions();
            const maxActive = 6;
            
            // If we have more missions than max, rotate them based on completion count
            if (available.length > maxActive) {
                const completedCount = Object.values(gameState.missions).filter(m => m.completed).length;
                const startIndex = (completedCount * 2) % available.length;
                
                const rotated = [];
                for (let i = 0; i < maxActive && i < available.length; i++) {
                    rotated.push(available[(startIndex + i) % available.length]);
                }
                return rotated;
            }
            
            return available;
        }

        function renderMissions() {
            const activeMissionsList = getActiveMissions();
            const completedMissions = Object.entries(gameState.missions).filter(([key, mission]) => mission.completed);
            const totalAvailable = getAvailableMissions().length;
            
            activeMissions.innerHTML = '';
            
            // Add mission rotation indicator if there are more missions than displayed
            if (totalAvailable > 6) {
                const rotationIndicator = document.createElement('div');
                rotationIndicator.className = 'col-span-full bg-gradient-to-r from-yellow-400 to-orange-400 rounded-xl p-3 mb-2 text-center text-white font-bold text-sm';
                rotationIndicator.innerHTML = `
                    üîÑ Menampilkan 6 dari ${totalAvailable} misi aktif
                    <div class="text-xs opacity-90 mt-1">Misi akan berganti otomatis saat ada yang selesai</div>
                `;
                activeMissions.appendChild(rotationIndicator);
            }
            
            // Show active missions
            activeMissionsList.forEach(([key, mission]) => {
                const progressPercentage = (mission.progress / mission.target) * 100;
                const missionCard = document.createElement('div');
                missionCard.className = 'mission-card bg-white rounded-xl md:rounded-2xl p-3 md:p-4 shadow-lg';
                
                missionCard.innerHTML = `
                    <div class="text-2xl md:text-3xl mb-2">${mission.emoji}</div>
                    <h4 class="font-bold text-purple-800 mb-2 text-sm md:text-base">${mission.name}</h4>
                    <p class="text-xs md:text-sm text-gray-600 mb-3">${mission.description}</p>
                    <div class="bg-gray-200 rounded-full h-2 mb-2">
                        <div class="bg-gradient-to-r from-blue-500 to-purple-500 h-2 rounded-full transition-all duration-500" 
                             style="width: ${progressPercentage}%"></div>
                    </div>
                    <div class="flex justify-between items-center">
                        <div class="text-xs text-gray-500">Progress: ${mission.progress}/${mission.target}</div>
                        <div class="text-xs font-bold text-green-600">+${mission.reward} poin</div>
                    </div>
                    <div class="text-xs text-purple-600 mt-1">Level ${mission.unlockLevel}+ ‚Ä¢ ${mission.category}</div>
                `;
                
                activeMissions.appendChild(missionCard);
            });
            
            // Show some completed missions
            completedMissions.slice(-3).forEach(([key, mission]) => {
                const missionCard = document.createElement('div');
                missionCard.className = 'mission-card mission-completed rounded-xl md:rounded-2xl p-3 md:p-4 shadow-lg';
                
                missionCard.innerHTML = `
                    <div class="text-2xl md:text-3xl mb-2">${mission.emoji}</div>
                    <h4 class="font-bold text-white mb-2 text-sm md:text-base">${mission.name}</h4>
                    <p class="text-xs md:text-sm text-white opacity-90 mb-3">${mission.description}</p>
                    <div class="bg-white bg-opacity-30 rounded-full h-2 mb-2">
                        <div class="bg-white h-2 rounded-full" style="width: 100%"></div>
                    </div>
                    <div class="flex justify-between items-center">
                        <div class="text-xs text-white opacity-90">‚úÖ SELESAI</div>
                        <div class="text-xs font-bold text-white">+${mission.reward} poin</div>
                    </div>
                `;
                
                activeMissions.appendChild(missionCard);
            });
            
            // Show locked missions preview
            const lockedMissions = Object.entries(gameState.missions).filter(([key, mission]) => {
                return gameState.playerLevel < mission.unlockLevel;
            });
            
            lockedMissions.slice(0, 2).forEach(([key, mission]) => {
                const missionCard = document.createElement('div');
                missionCard.className = 'mission-card mission-locked bg-gray-300 rounded-xl md:rounded-2xl p-3 md:p-4 shadow-lg';
                
                missionCard.innerHTML = `
                    <div class="text-2xl md:text-3xl mb-2">üîí</div>
                    <h4 class="font-bold text-gray-600 mb-2 text-sm md:text-base">${mission.name}</h4>
                    <p class="text-xs md:text-sm text-gray-500 mb-3">Terkunci - Capai Level ${mission.unlockLevel}</p>
                    <div class="bg-gray-400 rounded-full h-2 mb-2">
                        <div class="bg-gray-500 h-2 rounded-full" style="width: 0%"></div>
                    </div>
                    <div class="flex justify-between items-center">
                        <div class="text-xs text-gray-500">Butuh Level ${mission.unlockLevel}</div>
                        <div class="text-xs font-bold text-gray-600">+${mission.reward} poin</div>
                    </div>
                `;
                
                activeMissions.appendChild(missionCard);
            });
        }

        // Initialize game
        function updateUI() {
            // Update mobile stats
            playerLevelEl.textContent = gameState.playerLevel;
            kindnessPointsEl.textContent = gameState.kindnessPoints;
            intelligenceLevelEl.textContent = gameState.intelligenceLevel;
            mathPointsEl.textContent = gameState.mathPoints;
            
            // Update desktop stats
            const playerLevelDesktop = document.getElementById('playerLevelDesktop');
            const kindnessPointsDesktop = document.getElementById('kindnessPointsDesktop');
            const intelligenceLevelDesktop = document.getElementById('intelligenceLevelDesktop');
            const mathPointsDesktop = document.getElementById('mathPointsDesktop');
            
            if (playerLevelDesktop) playerLevelDesktop.textContent = gameState.playerLevel;
            if (kindnessPointsDesktop) kindnessPointsDesktop.textContent = gameState.kindnessPoints;
            if (intelligenceLevelDesktop) intelligenceLevelDesktop.textContent = gameState.intelligenceLevel;
            if (mathPointsDesktop) mathPointsDesktop.textContent = gameState.mathPoints;
            
            updateSaveInfo();
            renderMissions();
        }

        function updateSaveInfo() {
            document.getElementById('saveInfoLevel').textContent = gameState.playerLevel;
            document.getElementById('saveInfoPoints').textContent = gameState.kindnessPoints;
            document.getElementById('saveInfoTime').textContent = saveSystem.getPlayTime();
            
            const saveInfo = saveSystem.getSaveInfo();
            if (saveInfo) {
                document.getElementById('saveInfoDate').textContent = saveInfo.lastPlayed;
            }
        }

        function showSaveMenu() {
            updateSaveInfo();
            document.getElementById('saveMenuPanel').classList.remove('hidden');
            soundSystem.play('click');
        }

        function hideSaveMenu() {
            document.getElementById('saveMenuPanel').classList.add('hidden');
            soundSystem.play('click');
        }

        function showScenario(location, scenarioIndex = 0) {
            soundSystem.play('transition');
            
            const gameScene = document.getElementById('gameScene');
            gameScene.classList.add('transitioning');
            
            sceneContent.classList.add('fade-out');
            
            setTimeout(() => {
                const locationScenarios = scenarios[location];
                if (scenarioIndex >= locationScenarios.length) {
                    scenarioIndex = Math.floor(Math.random() * locationScenarios.length);
                }
                
                const scenario = locationScenarios[scenarioIndex];
                gameState.currentLocation = location;
                
                const locationBg = getLocationBackground(location);
                gameScene.style.background = locationBg;
                
                sceneContent.innerHTML = `
                    <div class="text-center mb-4 md:mb-6">
                        <div class="text-3xl md:text-4xl mb-2">${getLocationEmoji(location)}</div>
                        <h3 class="text-lg md:text-2xl font-bold text-purple-800 mb-3 md:mb-4 px-2">${scenario.title}</h3>
                        <p class="text-sm md:text-lg text-gray-700 mb-4 md:mb-6 px-2">${scenario.description}</p>
                    </div>
                    
                    <div class="flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4 md:space-x-6 mb-6 md:mb-8">
                        ${scenario.characters.map((char, index) => `
                            <div class="text-center ${getCharacterAnimation(index)}">
                                <div class="text-4xl md:text-6xl mb-2">${char.emoji}</div>
                                <div class="bg-purple-500 text-white px-2 md:px-3 py-1 rounded-full text-xs md:text-sm font-bold mb-2">${char.name}</div>
                                <div class="bg-white border-2 border-purple-300 rounded-lg p-2 md:p-3 shadow-lg max-w-xs mx-auto">
                                    <p class="text-xs md:text-sm text-purple-700 font-semibold">"${char.dialogue}"</p>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                
                sceneContent.classList.remove('fade-out');
                sceneContent.classList.add('fade-in');
                actionPanel.classList.remove('hidden');
                actionPanel.classList.add('slide-in-up');
                actionButtons.innerHTML = shuffleArray(scenario.actions).map((action, index) => `
                    <button class="action-btn bg-gradient-to-b from-blue-400 to-blue-600 hover:from-blue-500 hover:to-blue-700 text-white font-bold py-3 md:py-4 px-3 md:px-4 rounded-xl md:rounded-2xl shadow-lg transform hover:scale-105 transition-all duration-300 active:scale-95" 
                            data-action="${action.type}" data-points="${action.points}" data-correct="${action.correct}"
                            style="animation-delay: ${index * 0.1}s">
                        <div class="text-xl md:text-2xl mb-1 md:mb-2">${getActionEmoji(action.type)}</div>
                        <div class="text-xs md:text-sm">${action.text}</div>
                    </button>
                `).join('');
                document.querySelectorAll('.action-btn').forEach((btn, index) => {
                    btn.addEventListener('click', handleAction);
                    btn.classList.add('bounce-in');
                    btn.addEventListener('mouseenter', () => soundSystem.play('click'));
                });
                
                setTimeout(() => {
                    gameScene.classList.remove('transitioning');
                    sceneContent.classList.remove('fade-in');
                    actionPanel.classList.remove('slide-in-up');
                }, 600);
                
            }, 500);
        }

        function shuffleArray(array) {return [...array].sort(() => Math.random() - 0.5);}
        
        function getLocationBackground(location) {
            const backgrounds = {
                school: 'linear-gradient(135deg, #fef3c7 0%, #fde68a 50%, #f59e0b 100%)',
                playground: 'linear-gradient(135deg, #dcfce7 0%, #bbf7d0 50%, #22c55e 100%)',
                classroom: 'linear-gradient(135deg, #dbeafe 0%, #bfdbfe 50%, #3b82f6 100%)'
            };
            return backgrounds[location] || 'linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%)';
        }

        function getLocationEmoji(location) {
            const emojis = {
                school: 'üè´',
                playground: 'üå≥',
                classroom: 'üìö'
            };
            return emojis[location] || 'üè†';
        }

        function getCharacterAnimation(index) {
            const animations = ['slide-in-left', 'slide-in-up', 'slide-in-right'];
            return animations[index % animations.length];
        }

        function getActionEmoji(actionType) {
            const emojis = {
                befriend: 'ü§ù', help: 'üÜò', ignore: 'üôà', social: 'üë•',
                report: 'üì¢', defend: 'üõ°Ô∏è', escape: 'üèÉ', comfort: 'üíù',
                teach: 'üìñ', encourage: 'üí™', medical: 'üè•', share: 'ü§≤',
                mediate: 'üïäÔ∏è', organize: 'üìã', include: 'ü´Ç', mentor: 'üë®‚Äçüè´',
                protect: 'üõ°Ô∏è', advocate: '‚öñÔ∏è', honest: '‚ú®', support: 'ü§ó'
            };
            return emojis[actionType] || '‚≠ê';
        }

        function handleAction(event) {
            const btn = event.currentTarget;
            const actionType = btn.dataset.action;
            const points = parseInt(btn.dataset.points);
            const isCorrect = btn.dataset.correct === 'true';
            soundSystem.play(isCorrect ? 'success' : 'error');
            actionPanel.classList.add('hidden');
            
            btn.classList.add(isCorrect ? 'bounce-in' : 'shake');
            
            gameState.kindnessPoints += points;
            gameState.scenariosCompleted++;
            
            updateMissionProgress(actionType);
            
            setTimeout(() => {
                showActionFeedback(actionType, points, isCorrect);
            }, 500);
            
            checkLevelUp();
            saveSystem.saveGame();
            updateUI();
        }

        function updateMissionProgress(actionType) {
            const missionMap = {
                befriend: ['befriendNew', 'includeOthers'],
                social: ['befriendNew', 'includeOthers'],
                comfort: ['giveSupport', 'peerCounselor'],
                encourage: ['giveSupport', 'empathyMaster'],
                report: ['reportBully', 'antibullyingCampaign'],
                share: ['shareFood', 'weeklyChallenge'],
                teach: ['helpStudy', 'mentorJunior', 'mathTutor'],
                include: ['includeOthers', 'kindnessAmbassador'],
                mediate: ['mediateConflict', 'peerCounselor'],
                organize: ['organizeActivity', 'createClub'],
                mentor: ['mentorJunior', 'kindnessAmbassador', 'mathMentor'],
                protect: ['reportBully', 'antibullyingCampaign'],
                advocate: ['antibullyingCampaign', 'kindnessAmbassador'],
                help: ['weeklyChallenge', 'empathyMaster'],
                defend: ['reportBully', 'antibullyingCampaign'],
                support: ['giveSupport', 'peerCounselor'],
                mathTutor: ['mathTutor', 'algebraHelper', 'geometryGuide', 'mathMentor', 'mathChampion']
            };
            
            const relatedMissions = missionMap[actionType] || [];
            let missionCompleted = false;
            
            relatedMissions.forEach(missionKey => {
                const mission = gameState.missions[missionKey];
                if (mission && !mission.completed && gameState.playerLevel >= mission.unlockLevel) {
                    mission.progress++;
                    soundSystem.play('mission');
                    
                    if (mission.progress >= mission.target) {
                        mission.completed = true;
                        gameState.kindnessPoints += mission.reward;
                        showMissionComplete(missionKey);
                        missionCompleted = true;
                    }
                }
            });
            
            // Auto-activate new missions when one is completed
            if (missionCompleted) {
                setTimeout(() => {
                    activateNewMissions();
                }, 2000);
            }
            
            renderMissions();
        }

        function activateNewMissions() {
            const availableMissions = getAvailableMissions();
            const completedCount = Object.values(gameState.missions).filter(m => m.completed).length;
            
            // Show notification about new missions
            if (availableMissions.length > 0) {
                const notification = document.createElement('div');
                notification.className = 'fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-gradient-to-r from-purple-400 to-pink-500 text-white p-6 rounded-2xl shadow-2xl z-50 text-center max-w-sm mx-4';
                notification.innerHTML = `
                    <div class="text-4xl mb-2">üéØ</div>
                    <h3 class="text-xl font-bold mb-2">Misi Baru Tersedia!</h3>
                    <p class="text-sm mb-3">Hero Kebaikan level ${gameState.playerLevel} mendapat akses misi baru!</p>
                    <div class="text-lg font-bold">Lihat panel misi di bawah! ‚¨áÔ∏è</div>
                `;
                
                document.body.appendChild(notification);
                notification.classList.add('bounce-in');
                
                // Add pulse effect to mission panel
                const missionPanel = activeMissions.parentElement;
                missionPanel.classList.add('pulse-glow');
                
                setTimeout(() => {
                    notification.classList.add('fade-out');
                    missionPanel.classList.remove('pulse-glow');
                    setTimeout(() => {
                        document.body.removeChild(notification);
                    }, 500);
                }, 4000);
                
                soundSystem.play('levelUp');
            }
            
            renderMissions();
        }

        function showActionFeedback(actionType, points, isCorrect) {
            const feedbackMessages = {
                befriend: { good: "Luar biasa! Kamu membuat teman baru merasa diterima!", bad: "Coba pikirkan perasaan teman baru itu." },
                help: { good: "Hebat! Membantu orang lain adalah tindakan mulia!", bad: "Membantu orang lain selalu lebih baik." },
                report: { good: "Keputusan yang tepat! Melaporkan bullying sangat penting!", bad: "Bullying harus dilaporkan ke orang dewasa." },
                comfort: { good: "Kamu sangat peduli! Menghibur teman adalah hal yang baik!", bad: "Teman yang sedih butuh dukungan." },
                share: { good: "Berbagi itu indah! Kamu menunjukkan kebaikan hati!", bad: "Berbagi membuat dunia lebih baik." },
                teach: { good: "Mengajar teman menunjukkan kepedulianmu!", bad: "Membantu teman belajar itu penting." },
                mediate: { good: "Kamu jadi pembawa damai! Hebat sekali!", bad: "Konflik perlu diselesaikan dengan bijak." },
                organize: { good: "Jiwa kepemimpinanmu luar biasa!", bad: "Mengorganisir kegiatan butuh keberanian." },
                include: { good: "Kamu membuat semua merasa diterima!", bad: "Mengajak semua ikut itu penting." },
                protect: { good: "Kamu melindungi yang lemah! Heroik!", bad: "Melindungi orang lain itu mulia." },
                advocate: { good: "Kamu memperjuangkan keadilan!", bad: "Bersuara untuk kebenaran itu penting." }
            };
            
            const message = feedbackMessages[actionType] || { good: "Tindakan yang baik!", bad: "Coba pikirkan lagi." };
            const feedback = isCorrect ? message.good : message.bad;
            
            sceneContent.innerHTML = `
                <div class="text-center">
                    <div class="text-8xl mb-4">${isCorrect ? 'üåü' : 'üí≠'}</div>
                    <h3 class="text-2xl font-bold ${isCorrect ? 'text-green-600' : 'text-orange-600'} mb-4">
                        ${isCorrect ? 'Pilihan Hebat!' : 'Coba Lagi!'}
                    </h3>
                    <p class="text-lg text-gray-700 mb-4">${feedback}</p>
                    <div class="text-xl font-bold ${points > 0 ? 'text-green-600' : 'text-red-600'} mb-6">
                        ${points > 0 ? '+' : ''}${points} Poin Kebaikan
                    </div>
                    <button id="continueBtn" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-8 rounded-full shadow-lg transform hover:scale-105 transition-all duration-300">
                        Lanjutkan Petualangan! üöÄ
                    </button>
                </div>
            `;
            
            document.getElementById('continueBtn').addEventListener('click', () => {
                showWelcomeScene();
                actionPanel.classList.add('hidden');
            });
        }

        function checkLevelUp() {
            const newLevel = Math.floor(gameState.kindnessPoints / 100) + 1;
            if (newLevel > gameState.playerLevel) {
                gameState.playerLevel = newLevel;
                
                // Update empathy level
                if (gameState.playerLevel >= 10) gameState.empathyLevel = 'Legenda Kebaikan';
                else if (gameState.playerLevel >= 8) gameState.empathyLevel = 'Master Empati';
                else if (gameState.playerLevel >= 6) gameState.empathyLevel = 'Duta Kebaikan';
                else if (gameState.playerLevel >= 4) gameState.empathyLevel = 'Ahli Kebaikan';
                else if (gameState.playerLevel >= 2) gameState.empathyLevel = 'Sahabat Baik';
                
                showLevelUp();
            }
        }

        function showLevelUp() {
            soundSystem.play('levelUp');
            
            const rewards = [
                "Kemampuan Empati Meningkat!",
                "Unlock: Misi Spesial Baru!",
                "Bonus: 25 Poin Kebaikan!",
                "Achievement: Hero Sejati!",
                "Skill Baru: Mediator Handal!",
                "Unlock: Tantangan Level Tinggi!",
                "Bonus: Akses Misi Eksklusif!",
                "Achievement: Pembawa Perubahan!"
            ];
            
            document.getElementById('levelUpReward').innerHTML = `
                <div class="text-4xl mb-2">üèÜ</div>
                <p class="font-bold text-purple-800">${rewards[Math.floor(Math.random() * rewards.length)]}</p>
                <div class="text-sm text-gray-600 mt-2">Level ${gameState.playerLevel} - ${gameState.empathyLevel}</div>
            `;
            
            levelUpPanel.classList.remove('hidden');
            levelUpPanel.classList.add('bounce-in');
            gameState.kindnessPoints += 25;
        }

        function showMissionComplete(missionKey) {
            const mission = gameState.missions[missionKey];
            
            setTimeout(() => {
                const notification = document.createElement('div');
                notification.className = 'fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-gradient-to-r from-green-400 to-blue-500 text-white p-6 rounded-2xl shadow-2xl z-50 text-center max-w-sm mx-4';
                notification.innerHTML = `
                    <div class="text-4xl mb-2">${mission.emoji}</div>
                    <h3 class="text-xl font-bold mb-2">Misi Selesai!</h3>
                    <p class="text-sm mb-3">${mission.name}</p>
                    <div class="text-lg font-bold">+${mission.reward} Poin Bonus!</div>
                `;
                
                document.body.appendChild(notification);
                notification.classList.add('bounce-in');
                
                setTimeout(() => {
                    notification.classList.add('fade-out');
                    setTimeout(() => {
                        document.body.removeChild(notification);
                    }, 500);
                }, 3000);
            }, 1000);
        }

        function showWelcomeScene() {
            soundSystem.play('transition');
            
            const gameScene = document.getElementById('gameScene');
            gameScene.style.background = 'white';
            gameScene.classList.add('transitioning');
            
            sceneContent.classList.add('fade-out');
            
            setTimeout(() => {
                const completedMissions = Object.values(gameState.missions).filter(m => m.completed).length;
                const totalMissions = Object.keys(gameState.missions).length;
                
                sceneContent.innerHTML = `
                    <div class="text-center">
                        <div class="text-6xl md:text-8xl mb-4 float">üåü</div>
                        <h3 class="text-xl md:text-3xl font-bold text-purple-800 mb-4 px-2">Pilih Lokasi Petualangan!</h3>
                        <p class="text-sm md:text-lg text-gray-700 mb-4 px-2">Dimana kamu ingin membantu teman-teman hari ini?</p>
                        
                        <div class="bg-gradient-to-r from-purple-100 to-pink-100 rounded-2xl p-4 mb-6 mx-4">
                            <h4 class="font-bold text-purple-800 mb-2">üìä Progress Hero</h4>
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div>
                                    <span class="text-gray-600">Misi Selesai:</span>
                                    <span class="font-bold text-green-600 ml-2">${completedMissions}/${totalMissions}</span>
                                </div>
                                <div>
                                    <span class="text-gray-600">Skenario:</span>
                                    <span class="font-bold text-blue-600 ml-2">${gameState.scenariosCompleted}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex justify-center space-x-4 md:space-x-8 mb-6">
                            <div class="text-center slide-in-up">
                                <div class="text-4xl md:text-6xl mb-2">üòä</div>
                                <div class="bg-purple-500 text-white px-2 md:px-3 py-1 rounded-full text-xs md:text-sm font-bold">KAMU</div>
                                <div class="text-xs text-purple-600 mt-1">Hero Kebaikan Level ${gameState.playerLevel}</div>
                                <div class="text-xs text-gray-500">${gameState.empathyLevel}</div>
                            </div>
                        </div>
                    </div>
                `;
                
                sceneContent.classList.remove('fade-out');
                sceneContent.classList.add('fade-in');
                
                setTimeout(() => {
                    gameScene.classList.remove('transitioning');
                    sceneContent.classList.remove('fade-in');
                }, 600);
                
            }, 500);
        }

        // Location button cooldown system
        let locationCooldowns = {
            school: false,
            playground: false,
            classroom: false
        };

        function setLocationCooldown(location, duration = 3000) {
            locationCooldowns[location] = true;
            const btn = document.getElementById(location + 'Btn');
            
            // Disable button visually
            btn.classList.add('opacity-50', 'cursor-not-allowed');
            btn.disabled = true;
            
            // Add cooldown indicator
            const originalText = btn.innerHTML;
            let countdown = Math.ceil(duration / 1000);
            
            const updateCountdown = () => {
                if (countdown > 0) {
                    btn.innerHTML = originalText.replace(/\d+ Misi Tersedia/, `Cooldown: ${countdown}s`);
                    countdown--;
                    setTimeout(updateCountdown, 1000);
                } else {
                    // Re-enable button
                    btn.innerHTML = originalText;
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                    btn.disabled = false;
                    locationCooldowns[location] = false;
                }
            };
            
            updateCountdown();
        }

        // Event Listeners with cooldown
        schoolBtn.addEventListener('click', () => {
            if (locationCooldowns.school) return;
            
            soundSystem.play('click');
            showScenario('school', Math.floor(Math.random() * scenarios.school.length));
            setLocationCooldown('school');
        });
        
        playgroundBtn.addEventListener('click', () => {
            if (locationCooldowns.playground) return;
            
            soundSystem.play('click');
            showScenario('playground', Math.floor(Math.random() * scenarios.playground.length));
            setLocationCooldown('playground');
        });
        
        classroomBtn.addEventListener('click', () => {
            if (locationCooldowns.classroom) return;
            
            soundSystem.play('click');
            showScenario('classroom', Math.floor(Math.random() * scenarios.classroom.length));
            setLocationCooldown('classroom');
        });

        document.getElementById('closeLevelUp').addEventListener('click', () => {
            soundSystem.play('click');
            levelUpPanel.classList.add('hidden');
            levelUpPanel.classList.remove('bounce-in');
            updateUI();
        });

        // Info Panel Functions
        function showInfoPanel() {
            document.getElementById('infoPanel').classList.remove('hidden');
            soundSystem.play('click');
        }

        function hideInfoPanel() {
            document.getElementById('infoPanel').classList.add('hidden');
            soundSystem.play('click');
        }

        // Info Panel Event Listeners
        document.getElementById('infoBtn').addEventListener('click', showInfoPanel);
        document.getElementById('infoBtnDesktop').addEventListener('click', showInfoPanel);
        document.getElementById('closeInfoPanel').addEventListener('click', hideInfoPanel);

        // Save System Event Listeners
        document.getElementById('saveMenuBtn').addEventListener('click', showSaveMenu);
        document.getElementById('saveMenuBtnDesktop').addEventListener('click', showSaveMenu);
        document.getElementById('closeSaveMenu').addEventListener('click', hideSaveMenu);
        
        document.getElementById('manualSaveBtn').addEventListener('click', () => {
            soundSystem.play('success');
            saveSystem.saveGame();
            updateSaveInfo();
        });
        
        document.getElementById('exportSaveBtn').addEventListener('click', () => {
            soundSystem.play('click');
            saveSystem.exportSave();
        });
        
        document.getElementById('importSaveBtn').addEventListener('click', () => {
            soundSystem.play('click');
            document.getElementById('importFileInput').click();
        });
        
        document.getElementById('importFileInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                saveSystem.importSave(file);
            }
        });
        
        document.getElementById('resetGameBtn').addEventListener('click', () => {
            soundSystem.play('error');
            saveSystem.resetGame();
        });

        // Math Mode Event Listeners
        document.getElementById('mathTutorBtn').addEventListener('click', () => {
            soundSystem.play('click');
            showMathTutoring();
        });

        // Add hover sounds to location buttons
        const mathTutorBtn = document.getElementById('mathTutorBtn');
        [schoolBtn, playgroundBtn, classroomBtn, mathTutorBtn].forEach(btn => {
            btn.addEventListener('mouseenter', () => {
                soundSystem.play('click');
            });
        });

        // Add floating animation to location buttons
        document.querySelectorAll('.location-btn').forEach((btn, index) => {
            btn.style.animationDelay = `${index * 0.2}s`;
            btn.classList.add('float');
        });

        // Play Time Tracking
        let playTimeStart = Date.now();
        setInterval(() => {
            gameState.totalPlayTime += 1;
        }, 1000);

        // Load saved game on startup
        if (saveSystem.loadGame()) {
            updateUI();
        }

        // Initialize game
        updateUI();
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96a6ec3850fc87a8',t:'MTc1NDQwMzQ5Ni4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
